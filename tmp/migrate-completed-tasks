#!/usr/bin/env node

const fs = require('fs/promises');
const path = require('path');
const sqlite3 = require('sqlite3').verbose();
const { promisify } = require('util');

// Database connection
const db = new sqlite3.Database('.data/today.db');
const dbAll = promisify(db.all.bind(db));

async function getCompletedTasks() {
    const query = `
        SELECT id, title, completed_at
        FROM tasks
        WHERE status = '✅ Done'
        ORDER BY completed_at DESC
    `;
    return await dbAll(query);
}

async function findAndUpdateTask(taskId, title, completedAt) {
    // Search for the task in markdown files
    const vaultPath = 'vault';
    const results = [];

    async function searchDir(dirPath) {
        const entries = await fs.readdir(dirPath, { withFileTypes: true });

        for (const entry of entries) {
            const fullPath = path.join(dirPath, entry.name);

            // Skip excluded directories
            if (entry.isDirectory()) {
                const skipDirs = ['plans', 'Apple Notes', 'Bear', '@file', '@inbox', '@templates', '@tmp', '.sync', '.conflict-backup'];
                if (skipDirs.some(skip => entry.name.startsWith(skip))) continue;
                await searchDir(fullPath);
            } else if (entry.isFile() && entry.name.endsWith('.md')) {
                const content = await fs.readFile(fullPath, 'utf-8');
                const lines = content.split('\n');
                let modified = false;

                for (let i = 0; i < lines.length; i++) {
                    // Look for the task by ID
                    if (lines[i].includes(`task-id: ${taskId}`)) {
                        // Check if it's already marked as complete
                        if (lines[i].startsWith('- [ ]')) {
                            // Convert to completed with date
                            const completionDate = completedAt ?
                                new Date(completedAt).toISOString().split('T')[0] :
                                new Date().toISOString().split('T')[0];

                            // Replace checkbox and add completion date if not present
                            lines[i] = lines[i].replace('- [ ]', '- [x]');

                            // Add completion date if not already there
                            if (!lines[i].includes('✅')) {
                                // Insert before the task-id comment
                                lines[i] = lines[i].replace(
                                    /(\s*<!-- task-id:.*-->)/,
                                    ` ✅ ${completionDate}$1`
                                );
                            }

                            modified = true;
                            results.push({
                                file: fullPath,
                                line: i + 1,
                                updated: true,
                                title: title
                            });
                        } else if (lines[i].startsWith('- [x]')) {
                            // Already marked as complete
                            results.push({
                                file: fullPath,
                                line: i + 1,
                                updated: false,
                                alreadyComplete: true,
                                title: title
                            });
                        }
                    }
                }

                if (modified) {
                    await fs.writeFile(fullPath, lines.join('\n'));
                }
            }
        }
    }

    await searchDir(vaultPath);
    return results;
}

async function main() {
    try {
        console.log('Fetching completed tasks from database...');
        const completedTasks = await getCompletedTasks();
        console.log(`Found ${completedTasks.length} completed tasks`);

        let updated = 0;
        let alreadyComplete = 0;
        let notFound = 0;

        for (let i = 0; i < completedTasks.length; i++) {
            const task = completedTasks[i];

            if ((i + 1) % 50 === 0) {
                console.log(`Processing task ${i + 1}/${completedTasks.length}...`);
            }

            const results = await findAndUpdateTask(task.id, task.title, task.completed_at);

            if (results.length === 0) {
                notFound++;
            } else {
                for (const result of results) {
                    if (result.updated) {
                        updated++;
                        console.log(`✓ Updated: ${result.title.substring(0, 50)}...`);
                    } else if (result.alreadyComplete) {
                        alreadyComplete++;
                    }
                }
            }
        }

        console.log('\n=== Migration Summary ===');
        console.log(`Total completed tasks: ${completedTasks.length}`);
        console.log(`Updated to complete: ${updated}`);
        console.log(`Already marked complete: ${alreadyComplete}`);
        console.log(`Not found in markdown: ${notFound}`);

        db.close();
    } catch (error) {
        console.error('Error:', error);
        process.exit(1);
    }
}

main();