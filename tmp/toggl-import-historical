#!/usr/bin/env python3
"""
Import historical Toggl data from Reports API format into the database.
The Reports API groups entries, so we need to flatten them.
"""

import sys
import json
import sqlite3
from pathlib import Path

def main():
    # Read the reports API data
    reports_file = "/tmp/toggl_all_historical.json"
    db_path = ".data/today.db"

    print(f"Reading {reports_file}...")
    with open(reports_file) as f:
        reports_data = json.load(f)

    print(f"Processing {len(reports_data)} grouped entries...")

    # Flatten the time entries
    time_entries = []
    for group in reports_data:
        description = group.get('description')
        project_id = group.get('project_id')
        user_id = group.get('user_id')
        billable = group.get('billable', False)

        # Extract individual time entries from the group
        for entry in group.get('time_entries', []):
            time_entry = {
                'id': entry['id'],
                'description': description,
                'wid': None,  # Not available in reports API
                'pid': project_id,
                'tid': group.get('task_id'),
                'billable': 1 if billable else 0,
                'start': entry['start'],
                'stop': entry['stop'],
                'duration': entry['seconds'],
                'created_with': None,
                'tags': None,  # tag_ids available but not full tags
                'duronly': 0,
                'at': entry['at'],
                'user_id': user_id
            }
            time_entries.append(time_entry)

    print(f"Flattened to {len(time_entries)} individual time entries")

    # Connect to database
    print(f"Connecting to {db_path}...")
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()

    # Prepare insert statement
    insert_sql = """
        INSERT OR REPLACE INTO toggl_time_entries (
            id, description, wid, pid, tid, billable, start, stop,
            duration, created_with, tags, duronly, at, user_id
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    """

    # Import in batches
    batch_size = 1000
    imported = 0

    for i in range(0, len(time_entries), batch_size):
        batch = time_entries[i:i + batch_size]

        cursor.executemany(insert_sql, [
            (
                e['id'],
                e['description'],
                e['wid'],
                e['pid'],
                e['tid'],
                e['billable'],
                e['start'],
                e['stop'],
                e['duration'],
                e['created_with'],
                e['tags'],
                e['duronly'],
                e['at'],
                e['user_id']
            )
            for e in batch
        ])

        imported += len(batch)
        print(f"  Imported {imported}/{len(time_entries)} entries...", end='\\r')

    conn.commit()
    conn.close()

    print(f"\\nâœ“ Successfully imported {len(time_entries)} time entries")

    # Show date range
    dates = [e['start'] for e in time_entries]
    print(f"\\nDate range: {min(dates)} to {max(dates)}")

if __name__ == '__main__':
    main()
