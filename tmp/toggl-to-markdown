#!/usr/bin/env python3
"""
Import Toggl time entries into markdown format for time tracking system.
Converts Toggl data to: START|END|DESCRIPTION #topic/tag
"""

import sqlite3
import sys
from datetime import datetime

# Project to topic mapping
PROJECT_TO_TOPIC = {
    "F.Accounting ðŸ’µ": "#topic/personal_finance",
    "F.Home & Household ðŸ ": "#topic/home_household",
    "F.Hosting ðŸ¨": "#topic/hosting",
    "F.Personal Admin ðŸ—": "#topic/personal_admin",
    "H.Family ðŸ‘¨â€â¤ï¸â€ðŸ‘¨": "#topic/family",
    "H.Friends & Social Life ðŸ™‚": "#topic/friends_socializing",
    "H.Health & Fitness ðŸƒâ€â™‚ï¸": "#topic/fitness",
    "H.Learning ðŸ‘¨â€ðŸŽ“": "#topic/languages",
    "H.Mental Clarity ðŸ§˜â€â™‚ï¸": "#topic/meditation_mindfulness",
    "H.Travel & Exploration ðŸš¢": "#topic/travel",
    "O.Content ðŸ–¼": "#topic/ogm",
    "O.Marketing/SEO ðŸ“ˆ": "#topic/ogm_marketing",
    "O.Members ðŸ‘¬": "#topic/ogm_members",
    "O.Site Development ðŸš§": "#topic/ogm_site_development",
    "O.Staff ðŸ‘¥": "#topic/ogm_staff",
    "O.Sysadmin ðŸ‘¨â€ðŸ’»": "#topic/ogm_sysadmin",
    "Z.Games â™Ÿï¸": "#topic/games",
}

# Project name to clean description mapping (for when no description exists)
PROJECT_TO_DESCRIPTION = {
    "F.Accounting ðŸ’µ": "Accounting",
    "F.Home & Household ðŸ ": "Home & household",
    "F.Hosting ðŸ¨": "Hosting",
    "F.Personal Admin ðŸ—": "Personal admin",
    "H.Family ðŸ‘¨â€â¤ï¸â€ðŸ‘¨": "Family time",
    "H.Friends & Social Life ðŸ™‚": "Socializing",
    "H.Health & Fitness ðŸƒâ€â™‚ï¸": "Exercise",
    "H.Learning ðŸ‘¨â€ðŸŽ“": "Learning",
    "H.Mental Clarity ðŸ§˜â€â™‚ï¸": "Meditation",
    "H.Travel & Exploration ðŸš¢": "Travel planning",
    "O.Content ðŸ–¼": "OlderGay.Men content",
    "O.Marketing/SEO ðŸ“ˆ": "OlderGay.Men marketing",
    "O.Members ðŸ‘¬": "OlderGay.Men member support",
    "O.Site Development ðŸš§": "OlderGay.Men site development",
    "O.Staff ðŸ‘¥": "OlderGay.Men staff",
    "O.Sysadmin ðŸ‘¨â€ðŸ’»": "OlderGay.Men sysadmin",
    "Z.Games â™Ÿï¸": "Games",
}

def clean_description(description, project):
    """Clean up description by removing project prefix and separators."""
    if not description:
        # Use clean project description when no description exists
        return PROJECT_TO_DESCRIPTION.get(project, project)

    # Remove project prefix if present (e.g., "H.Health & Fitness ðŸƒâ€â™‚ï¸ - Exercise" -> "Exercise")
    if project and description.startswith(project):
        description = description[len(project):].strip()

    # Remove leading " - " separator
    if description.startswith("- "):
        description = description[2:].strip()

    # If we ended up with empty string after cleaning, use project description
    if not description:
        return PROJECT_TO_DESCRIPTION.get(project, project)

    return description

def import_month(year_month, db_path='.data/today.db', output_dir='vault/logs/time-tracking'):
    """Import Toggl entries for a specific month."""
    # Connect to database
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()

    # Get entries for the specified month
    cursor.execute("""
        SELECT
            te.start,
            te.stop,
            te.description,
            p.name as project
        FROM toggl_time_entries te
        LEFT JOIN toggl_projects p ON te.pid = p.id
        WHERE strftime('%Y-%m', te.start) = ?
        AND te.stop IS NOT NULL
        ORDER BY te.start
    """, (year_month,))

    entries = cursor.fetchall()
    conn.close()

    if not entries:
        print(f"No entries found for {year_month}")
        return 0

    # Convert to new format
    output_lines = [f"# Time Tracking - {datetime.strptime(year_month, '%Y-%m').strftime('%B %Y')}", ""]

    for start_utc, stop_utc, description, project in entries:
        # Parse UTC timestamps
        start_dt = datetime.fromisoformat(start_utc.replace('Z', '+00:00'))
        stop_dt = datetime.fromisoformat(stop_utc.replace('Z', '+00:00'))

        # Convert to America/New_York (EDT is -04:00, EST is -05:00)
        # Note: This is simplified - doesn't account for DST transitions
        start_local = start_dt.strftime('%Y-%m-%dT%H:%M:%S-04:00')
        stop_local = stop_dt.strftime('%Y-%m-%dT%H:%M:%S-04:00')

        # Clean description and get topic tag
        clean_desc = clean_description(description, project)
        topic_tag = PROJECT_TO_TOPIC.get(project, "#topic/other")

        # Create entry
        entry = f"{start_local}|{stop_local}|{clean_desc} {topic_tag}"
        output_lines.append(entry)

    # Write file
    output_file = f"{output_dir}/{year_month}.md"
    with open(output_file, 'w') as f:
        f.write('\n'.join(output_lines) + '\n')

    print(f"âœ“ Created {output_file} with {len(entries)} entries")
    return len(entries)

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print("Usage: bin/toggl-to-markdown YYYY-MM [YYYY-MM ...]")
        print("")
        print("Examples:")
        print("  bin/toggl-to-markdown 2025-10")
        print("  bin/toggl-to-markdown 2025-09 2025-10")
        sys.exit(1)

    total = 0
    for year_month in sys.argv[1:]:
        total += import_month(year_month)

    print(f"\nTotal: {total} entries imported")
