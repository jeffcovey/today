#!/usr/bin/env python3
"""
Remap legacy #topic/other tags to current topic taxonomy based on description patterns.
"""

import re
import glob
from pathlib import Path

# Mapping patterns (regex) to topic tags
DESCRIPTION_TO_TOPIC = {
    # OlderGay.Men related
    r'^Rewrite sfpix\.net': '#topic/ogm_site_development',
    r'^Do regular OlderGay tasks': '#topic/ogm',
    r'^Perform routine OlderGay tasks': '#topic/ogm',
    r'^O\.Run OlderGay\.Men': '#topic/ogm',

    # Personal admin / productivity
    r'^Clear the desk': '#topic/personal_admin',
    r'^GTD Review': '#topic/personal_admin',
    r'^Weekly Preview': '#topic/personal_admin',
    r'^Weekly Review': '#topic/personal_admin',
    r'^ðŸ—“ Planning': '#topic/personal_admin',
    r'^Hindsight': '#topic/personal_admin',
    r'^Do Hindsight tasks': '#topic/personal_admin',
    r'^Drafts': '#topic/personal_admin',
    r'^Scriptable': '#topic/personal_admin',

    # Finance
    r'^Care for finances': '#topic/personal_finance',

    # Home & household
    r'^Konmari': '#topic/home_household',

    # Travel
    r'^Prepare for travels': '#topic/travel',
    r'^âœˆï¸ Travel': '#topic/travel',

    # Languages
    r'^ðŸ—£ Languages': '#topic/languages',

    # Family & relationships
    r'^ðŸˆ Cat': '#topic/family',
    r'^OKC': '#topic/friends_socializing',  # Dating app

    # Reading/learning - could be multiple categories, being conservative
    r'^Read': '#topic/personal_admin',  # Could also be learning
    r'^Write': '#topic/personal_admin',

    # Finance
    r'^ðŸ’µ Finance': '#topic/personal_finance',

    # Home & household
    r'^House Cleaning': '#topic/home_household',

    # Learning
    r'^Learning Toggl': '#topic/personal_admin',
    r'^PPV': '#topic/personal_admin',  # Pay-per-view, likely for learning/events
}

def remap_file(filepath):
    """Remap topics in a single markdown file."""
    with open(filepath, 'r') as f:
        lines = f.readlines()

    changes = 0
    new_lines = []

    for line in lines:
        # Skip header lines
        if line.startswith('#') and not '#topic/' in line:
            new_lines.append(line)
            continue

        # Check if this line has #topic/other
        if '#topic/other' in line:
            # Extract the description (between last | and #topic/other)
            match = re.search(r'\|([^|]+) #topic/other', line)
            if match:
                description = match.group(1)

                # Try to find a matching pattern
                for pattern, new_topic in DESCRIPTION_TO_TOPIC.items():
                    if re.match(pattern, description):
                        # Replace #topic/other with the new topic
                        new_line = line.replace('#topic/other', new_topic)
                        new_lines.append(new_line)
                        changes += 1
                        break
                else:
                    # No match found, keep original
                    new_lines.append(line)
            else:
                new_lines.append(line)
        else:
            new_lines.append(line)

    if changes > 0:
        with open(filepath, 'w') as f:
            f.writelines(new_lines)

    return changes

def main():
    # Process all markdown files in vault/logs/time-tracking/
    files = glob.glob('vault/logs/time-tracking/*.md')

    total_changes = 0
    files_changed = 0

    for filepath in sorted(files):
        changes = remap_file(filepath)
        if changes > 0:
            filename = Path(filepath).name
            print(f"âœ“ {filename}: {changes} remappings")
            total_changes += changes
            files_changed += 1

    print(f"\nâœ“ Total: {total_changes} entries remapped across {files_changed} files")

    # Show remaining #topic/other count
    import subprocess
    result = subprocess.run(['grep', '-h', '#topic/other', *files],
                          capture_output=True, text=True)
    remaining = len(result.stdout.strip().split('\n')) if result.stdout.strip() else 0
    print(f"  Remaining #topic/other entries: {remaining}")

if __name__ == '__main__':
    main()
