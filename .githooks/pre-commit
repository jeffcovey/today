#!/bin/sh
# Husky helper file removed - not needed for our setup

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if any JavaScript source files are being committed
STAGED_JS=$(echo "$STAGED_FILES" | grep -E '^src/.*\.js$' || true)

# Update file dates index for new markdown files
bin/update-file-dates-index

# Auto-fix markdown files with markdownlint
STAGED_MD=$(echo "$STAGED_FILES" | grep '\.md$' || true)

if [ -n "$STAGED_MD" ]; then
  echo "Auto-fixing markdown files with markdownlint..."
  npx markdownlint-cli2 --fix $STAGED_MD
  
  # Re-add the fixed files to the commit
  for file in $STAGED_MD; do
    git add "$file"
  done
  
  echo "✅ Markdown files have been auto-fixed and staged"
fi

# Only run tests if source code changed
if [ -n "$STAGED_JS" ]; then
  echo "JavaScript source files changed, running tests..."
  
  # Run only tests related to changed files
  npm test -- --bail --passWithNoTests --findRelatedTests $STAGED_JS
  
  if [ $? -ne 0 ]; then
    echo ""
    echo "❌ Tests failed. Please fix the failing tests before committing."
    echo ""
    exit 1
  fi
  
  echo "✅ All tests passed!"
else
  echo "No JavaScript source files changed, skipping tests."
fi

exit 0