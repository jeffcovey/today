version: '3.8'

services:
  scheduler:
    build:
      context: .
      dockerfile: Dockerfile.scheduler
    container_name: today-scheduler
    restart: unless-stopped
    environment:
      # Core environment
      - NODE_ENV=production
      - TZ=${TZ:-America/New_York}
      
      # Secrets (from .env)
      - DOTENV_PRIVATE_KEY=${DOTENV_PRIVATE_KEY}
      - TURSO_DATABASE_URL=${TURSO_DATABASE_URL}
      - TURSO_AUTH_TOKEN=${TURSO_AUTH_TOKEN}
      
      # Service credentials
      - EMAIL_ACCOUNT=${EMAIL_ACCOUNT}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD}
      - ICLOUD_USERNAME=${ICLOUD_USERNAME}
      - ICLOUD_APP_PASSWORD=${ICLOUD_APP_PASSWORD}
      
      # Optional configurations
      - SKIP_DEP_CHECK=true
      - OLLAMA_HOST=${OLLAMA_HOST:-http://ollama:11434}
      
    volumes:
      # Mount the entire project for access to notes
      - .:/app
      
      # Persist caches between restarts
      - calendar-cache:/app/.calendar-cache
      - data-cache:/app/.data
      
      # Use container's node_modules
      - /app/node_modules
      
      # Mount SSH for git operations (read-only)
      - ~/.ssh:/root/.ssh:ro
      
    networks:
      - today-network
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    depends_on:
      - ollama

  ollama:
    image: ollama/ollama:latest
    container_name: ollama-scheduler
    restart: unless-stopped
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - today-network

volumes:
  calendar-cache:
    driver: local
  data-cache:
    driver: local
  ollama-data:
    driver: local

networks:
  today-network:
    driver: bridge