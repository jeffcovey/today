#!/bin/bash

# Add creation and modification dates to sync metadata in all markdown files

for file in notes/**/*.md projects/**/*.md; do
    if [ -f "$file" ]; then
        # Get creation date (first commit)
        created_at=$(git log --format="%aI" --reverse "$file" 2>/dev/null | head -1)
        
        # Get modification date (last commit)
        modified_at=$(git log --format="%aI" -1 "$file" 2>/dev/null)
        
        if [ -n "$created_at" ] && [ -n "$modified_at" ]; then
            echo "Processing $file..."
            
            # Check if file has sync metadata
            if grep -q "<!-- sync-metadata" "$file"; then
                # Update existing metadata
                # First, extract current metadata
                current_meta=$(sed -n '/<!-- sync-metadata/,/-->/p' "$file" | sed '1d;$d')
                
                # Add or update dates in metadata
                if echo "$current_meta" | grep -q "created_at:"; then
                    # Update existing created_at
                    new_meta=$(echo "$current_meta" | sed "s/created_at:.*/created_at: $created_at/")
                else
                    # Add created_at
                    new_meta="$current_meta
created_at: $created_at"
                fi
                
                if echo "$new_meta" | grep -q "modified_at:"; then
                    # Update existing modified_at
                    new_meta=$(echo "$new_meta" | sed "s/modified_at:.*/modified_at: $modified_at/")
                else
                    # Add modified_at
                    new_meta="$new_meta
modified_at: $modified_at"
                fi
                
                # Create temp file with updated metadata
                sed '/<!-- sync-metadata/,/-->/d' "$file" > "$file.tmp"
                echo "" >> "$file.tmp"
                echo "<!-- sync-metadata" >> "$file.tmp"
                echo "$new_meta" >> "$file.tmp"
                echo "-->" >> "$file.tmp"
                
                mv "$file.tmp" "$file"
                echo "  Updated $file"
            fi
        fi
    fi
done

echo "Done adding dates to metadata"