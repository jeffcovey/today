#!/bin/bash
# Control script for vault-watcher daemon

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Commands
case "${1:-status}" in
  start)
    echo -e "${GREEN}Starting vault watcher...${NC}"
    
    # Check if already running
    if bin/vault-watcher status 2>/dev/null | grep -q "is running"; then
      echo -e "${YELLOW}Vault watcher is already running${NC}"
      exit 0
    fi
    
    # Start in background
    nohup bin/vault-watcher > /dev/null 2>&1 &
    echo $! > .data/vault-watcher.pid
    
    sleep 2
    
    # Verify it started
    if bin/vault-watcher status 2>/dev/null | grep -q "is running"; then
      echo -e "${GREEN}✓ Vault watcher started successfully${NC}"
    else
      echo -e "${RED}✗ Failed to start vault watcher${NC}"
      exit 1
    fi
    ;;
    
  stop)
    echo -e "${YELLOW}Stopping vault watcher...${NC}"
    bin/vault-watcher stop
    ;;
    
  restart)
    echo -e "${YELLOW}Restarting vault watcher...${NC}"
    bin/vault-watcher stop 2>/dev/null || true
    sleep 2
    $0 start
    ;;
    
  status)
    bin/vault-watcher status
    ;;
    
  logs)
    bin/vault-watcher logs
    ;;
    
  tail)
    # Follow logs in real-time
    if [ -f .data/vault-watcher.log ]; then
      tail -f .data/vault-watcher.log
    else
      echo -e "${YELLOW}No log file found${NC}"
    fi
    ;;
    
  test)
    # Test by creating a file
    echo -e "${GREEN}Testing vault watcher...${NC}"
    TEST_FILE="vault/notes/test-watcher-$(date +%s).md"
    echo "# Test File" > "$TEST_FILE"
    echo "This is a test file for vault watcher" >> "$TEST_FILE"
    echo -e "${GREEN}Created test file: $TEST_FILE${NC}"
    echo "Watch the logs to see if it gets processed..."
    sleep 5
    rm -f "$TEST_FILE"
    echo -e "${GREEN}Test file removed${NC}"
    ;;
    
  *)
    echo "Usage: $0 {start|stop|restart|status|logs|tail|test}"
    echo ""
    echo "Commands:"
    echo "  start    - Start the vault watcher daemon"
    echo "  stop     - Stop the vault watcher daemon"
    echo "  restart  - Restart the vault watcher daemon"
    echo "  status   - Check if watcher is running"
    echo "  logs     - Show all logs"
    echo "  tail     - Follow logs in real-time"
    echo "  test     - Create a test file to verify watcher"
    exit 1
    ;;
esac