#!/usr/bin/env node

// Auto-use dotenvx if available
import { autoDotenvx } from './lib/dotenvx-loader.js';
autoDotenvx();

import { program } from 'commander';
import { config } from 'dotenv';
import path from 'path';
import { fileURLToPath } from 'url';
import chalk from 'chalk';
import { execSync } from 'child_process';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Load environment variables (fallback if not using dotenvx)
if (!process.env.DOTENVX_RUNNING) {
  config();
}

// Try to load TODAY_ANTHROPIC_KEY from encrypted env (same as bin/today uses)
function loadTodayApiKey() {
  try {
    const result = execSync('npx dotenvx get TODAY_ANTHROPIC_KEY 2>/dev/null', {
      encoding: 'utf-8'
    }).trim();
    if (result) {
      process.env.TODAY_ANTHROPIC_KEY = result;
      return true;
    }
  } catch (e) {
    // No API key available
  }
  return false;
}

// Load the API key
loadTodayApiKey();

// Import commands
Promise.all([
  import('../src/email-downloader.js'),
  import('../src/email-manager.js'),
  import('../src/email-organizer.js')
]).then(([{ EmailDownloader }, { EmailManager }, { EmailOrganizer }]) => {
  program
    .name('email')
    .description('Email management CLI for downloading and managing emails')
    .version('1.0.0');

  program
    .command('download')
    .description('Download emails from the last N days')
    .option('-d, --days <number>', 'Number of days to download', '30')
    .option('-a, --account <email>', 'Email account to download from', process.env.EMAIL_ACCOUNT || 'jeff.covey@icloud.com')
    .action(async (options) => {
      try {
        console.log(chalk.blue(`ðŸ“§ Downloading emails from the last ${options.days} days...`));
        const downloader = new EmailDownloader();
        await downloader.downloadEmails(options.account, parseInt(options.days));
      } catch (error) {
        console.error(chalk.red('Error downloading emails:'), error.message);
        process.exit(1);
      }
    });

  program
    .command('setup')
    .description('Setup email account credentials')
    .action(async () => {
      console.log(chalk.blue('ðŸ“§ Email Account Setup'));
      console.log(chalk.yellow('\nFor iCloud/Apple Mail:'));
      console.log('1. Go to https://appleid.apple.com');
      console.log('2. Sign in and go to "Sign-In and Security"');
      console.log('3. Select "App-Specific Passwords"');
      console.log('4. Generate a new password for "notion-cli email"');
      console.log('5. Add the following to your .env file:');
      console.log(chalk.green('\nEMAIL_ACCOUNT=jeff.covey@icloud.com'));
      console.log(chalk.green('EMAIL_PASSWORD=xxxx-xxxx-xxxx-xxxx'));
      console.log(chalk.gray('\n(Replace xxxx-xxxx-xxxx-xxxx with your app-specific password)'));
    });

  program
    .command('stats')
    .description('Show email database statistics')
    .action(async () => {
      try {
        console.log(chalk.blue('ðŸ“Š Email Database Statistics'));
        const downloader = new EmailDownloader();
        const stats = await downloader.getEmailStats();
        
        if (stats.total === 0) {
          console.log(chalk.yellow('No emails downloaded yet.'));
          console.log('Run "email download" to download emails.');
        } else {
          console.log(chalk.green(`\nTotal emails: ${stats.total}`));
          console.log(chalk.gray(`Oldest email: ${stats.oldest ? new Date(stats.oldest).toLocaleDateString() : 'N/A'}`));
          console.log(chalk.gray(`Newest email: ${stats.newest ? new Date(stats.newest).toLocaleDateString() : 'N/A'}`));
          console.log(chalk.gray(`Total size: ${(stats.total_size / 1024 / 1024).toFixed(2)} MB`));
          
          if (stats.folders && stats.folders.length > 0) {
            console.log(chalk.blue('\nðŸ“ Emails by folder:'));
            stats.folders.forEach(folder => {
              console.log(chalk.gray(`  ${folder.folder}: ${folder.count} emails`));
            });
          }
        }
      } catch (error) {
        console.error(chalk.red('Error getting stats:'), error.message);
        process.exit(1);
      }
    });

  program
    .command('list')
    .description('List recent emails')
    .option('-l, --limit <number>', 'Number of emails to show', '10')
    .option('-f, --from <email>', 'Filter by sender')
    .option('-s, --subject <text>', 'Filter by subject')
    .action(async (options) => {
      try {
        const manager = new EmailManager();
        const filter = {};
        
        if (options.from) filter.from = options.from;
        if (options.subject) filter.subject = options.subject;
        filter.limit = parseInt(options.limit);
        
        const emails = await manager.getLocalEmails(filter);
        
        if (emails.length === 0) {
          console.log(chalk.yellow('No emails found.'));
        } else {
          console.log(chalk.blue(`\nðŸ“§ Recent Emails (${emails.length}):`));
          emails.forEach((email, i) => {
            const date = new Date(email.date).toLocaleDateString();
            console.log(`${i + 1}. ${chalk.bold(email.subject || '(no subject)')}`);
            console.log(`   From: ${email.from_address} | Date: ${date}`);
          });
        }
        process.exit(0); // Explicitly exit after listing emails
      } catch (error) {
        console.error(chalk.red('Error listing emails:'), error.message);
        process.exit(1);
      }
    });

  program
    .command('chat')
    .description('Have a conversation about your emails')
    .action(async () => {
      try {
        console.log(chalk.blue('ðŸ’¬ Email Conversation Mode'));
        console.log(chalk.gray('Examples:'));
        console.log(chalk.gray('  â€¢ "Show me emails from GitHub"'));
        console.log(chalk.gray('  â€¢ "Delete all emails about Patreon"'));
        console.log(chalk.gray('  â€¢ "How many emails from last week?"'));
        console.log(chalk.gray('  â€¢ "Move Heroku emails to a folder"'));
        console.log(chalk.gray('  â€¢ "Summarize my recent emails"\n'));

        const manager = new EmailManager();
        await manager.conversationMode();
      } catch (error) {
        console.error(chalk.red('Error in conversation mode:'), error.message);
        console.error(chalk.gray('Stack trace:'), error.stack);
        // Don't exit on error, just return
      }
    });

  program
    .command('organize')
    .description('Organize inbox emails into stage-based folders')
    .action(async () => {
      try {
        console.log(chalk.blue('ðŸ“ Organizing emails by stage...'));
        console.log(chalk.gray('This will categorize emails into:'));
        console.log(chalk.gray('  â€¢ _Front Stage: Meetings, calls, support, communications'));
        console.log(chalk.gray('  â€¢ _Back Stage: Maintenance, bills, bug fixes, organizing'));
        console.log(chalk.gray('  â€¢ _Off Stage: Personal time, nature, friends, reading\n'));

        const organizer = new EmailOrganizer();
        await organizer.run();
        process.exit(0); // Explicitly exit after successful completion
      } catch (error) {
        console.error(chalk.red('Error organizing emails:'), error.message);
        process.exit(1);
      }
    });

  program.parse();
}).catch(error => {
  console.error(chalk.red('Failed to load email commands:'), error.message);
  process.exit(1);
});