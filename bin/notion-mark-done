#!/usr/bin/env node

// DEPRECATED: This script uses task-id which is no longer used
// We've transitioned to Obsidian Tasks syntax
// This script is kept for backwards compatibility only

// Auto-use dotenvx if available
import { autoDotenvx } from './lib/dotenvx-loader.js';
autoDotenvx();

import { program } from 'commander';
import chalk from 'chalk';
import { NotionAPI } from '../src/notion-api.js';
import { getDatabase } from '../src/database-service.js';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

program
  .name('notion-mark-done')
  .description('Mark tasks as done in Notion after successful migration')
  .version('1.0.0')
  .argument('[task-id]', 'Task ID (partial or full) or Notion ID to mark as done')
  .option('-a, --all', 'Mark all migrated tasks as done in Notion')
  .option('-n, --dry-run', 'Show what would be done without making changes')
  .option('-v, --verbose', 'Show detailed output')
  .parse();

const options = program.opts();
const args = program.args;

async function markTaskDone(notionApi, notionId, title, dryRun = false, verbose = false) {
  try {
    if (verbose) {
      console.log(chalk.gray(`Processing: ${title}`));
      console.log(chalk.gray(`  Notion ID: ${notionId}`));
    }

    if (dryRun) {
      console.log(chalk.yellow(`[DRY RUN] Would mark as done: ${title}`));
      return { success: true, dryRun: true };
    }

    // Update the page in Notion
    const properties = {
      'Status': {
        status: {
          name: '✅ Done'
        }
      },
      'Repeat Every (Days)': {
        number: null  // Clear the repeat interval
      }
    };

    if (verbose) {
      console.log(chalk.gray('  Updating properties:', JSON.stringify(properties, null, 2)));
    }

    await notionApi.updatePageProperties(notionId, properties);
    
    console.log(chalk.green(`✓ Marked as done: ${title}`));
    return { success: true };
  } catch (error) {
    console.error(chalk.red(`✗ Failed to update: ${title}`));
    console.error(chalk.red(`  Error: ${error.message}`));
    return { success: false, error: error.message };
  }
}

async function main() {
  // Check for Notion API token (try both NOTION_TOKEN and NOTION_API_TOKEN)
  const notionToken = process.env.NOTION_TOKEN || process.env.NOTION_API_TOKEN;
  if (!notionToken) {
    console.error(chalk.red('Error: NOTION_TOKEN environment variable is not set'));
    console.error(chalk.yellow('Please set it in your .env file or environment'));
    process.exit(1);
  }

  // Initialize Notion API
  const notionApi = new NotionAPI(notionToken);

  // Open local database
  const db = getDatabase('.data/today.db', { readOnly: true });

  try {
    let tasksToProcess = [];

    if (options.all) {
      // Get all tasks with Notion IDs
      console.log(chalk.blue('Finding all migrated tasks with Notion IDs...'));
      const tasks = db.prepare(`
        SELECT id, title, notion_id 
        FROM tasks 
        WHERE notion_id IS NOT NULL
        ORDER BY title
      `).all();
      
      tasksToProcess = tasks;
      console.log(chalk.blue(`Found ${tasks.length} tasks with Notion IDs`));
    } else if (args[0]) {
      // Find specific task
      const searchId = args[0];
      
      // First try to find by task ID (partial match)
      let task = db.prepare(`
        SELECT id, title, notion_id 
        FROM tasks 
        WHERE id LIKE ? AND notion_id IS NOT NULL
      `).get(`${searchId}%`);
      
      if (!task) {
        // Try to find by Notion ID (exact or partial)
        task = db.prepare(`
          SELECT id, title, notion_id 
          FROM tasks 
          WHERE notion_id LIKE ? 
        `).get(`%${searchId}%`);
      }
      
      if (!task) {
        // Try to find by title
        task = db.prepare(`
          SELECT id, title, notion_id 
          FROM tasks 
          WHERE title LIKE ? AND notion_id IS NOT NULL
        `).get(`%${searchId}%`);
      }
      
      if (!task) {
        console.error(chalk.red(`Task not found: ${searchId}`));
        console.error(chalk.yellow('Try using a partial task ID, Notion ID, or title'));
        process.exit(1);
      }
      
      if (!task.notion_id) {
        console.error(chalk.red(`Task does not have a Notion ID: ${task.title}`));
        process.exit(1);
      }
      
      tasksToProcess = [task];
    } else {
      // Interactive mode - show tasks and let user choose
      const tasks = db.prepare(`
        SELECT id, title, notion_id, status
        FROM tasks 
        WHERE notion_id IS NOT NULL
        ORDER BY do_date DESC, title
        LIMIT 20
      `).all();
      
      if (tasks.length === 0) {
        console.log(chalk.yellow('No tasks with Notion IDs found'));
        process.exit(0);
      }
      
      console.log(chalk.bold('\nRecent tasks with Notion IDs:'));
      console.log(chalk.gray('─'.repeat(80)));
      
      tasks.forEach((task, i) => {
        const num = String(i + 1).padStart(2, ' ');
        const id = task.id.substring(0, 8);
        const status = task.status || '?';
        console.log(`${chalk.cyan(num)}. [${id}] ${task.title} (${status})`);
      });
      
      console.log(chalk.gray('─'.repeat(80)));
      console.log(chalk.yellow('\nUsage:'));
      console.log('  notion-mark-done <task-id>    Mark specific task as done');
      console.log('  notion-mark-done --all         Mark all tasks as done');
      console.log('  notion-mark-done --dry-run     Preview changes without updating');
      
      process.exit(0);
    }

    // Process tasks
    if (tasksToProcess.length === 0) {
      console.log(chalk.yellow('No tasks to process'));
      process.exit(0);
    }

    console.log(chalk.bold(`\n${options.dryRun ? '[DRY RUN] ' : ''}Processing ${tasksToProcess.length} task(s)...`));
    console.log(chalk.gray('─'.repeat(60)));

    let successCount = 0;
    let failCount = 0;

    for (const task of tasksToProcess) {
      const result = await markTaskDone(
        notionApi, 
        task.notion_id, 
        task.title,
        options.dryRun,
        options.verbose
      );
      
      if (result.success) {
        successCount++;
      } else {
        failCount++;
      }
      
      // Add a small delay to avoid rate limiting
      if (!options.dryRun && tasksToProcess.length > 1) {
        await new Promise(resolve => setTimeout(resolve, 500));
      }
    }

    // Summary
    console.log(chalk.gray('─'.repeat(60)));
    if (options.dryRun) {
      console.log(chalk.yellow(`\n[DRY RUN] Would update ${successCount} task(s)`));
    } else {
      console.log(chalk.green(`\n✓ Successfully updated ${successCount} task(s)`));
      if (failCount > 0) {
        console.log(chalk.red(`✗ Failed to update ${failCount} task(s)`));
      }
    }

    // If we actually updated tasks, suggest removing Notion fields
    if (!options.dryRun && successCount > 0) {
      console.log(chalk.gray('\nTip: Once you\'re satisfied with the migration, you can remove'));
      console.log(chalk.gray('Notion IDs from the local database with:'));
      console.log(chalk.cyan('  bin/tasks clear-notion-ids'));
    }

    process.exit(0);  // Explicit exit on success

  } catch (error) {
    console.error(chalk.red('Error:'), error.message);
    if (options.verbose) {
      console.error(error.stack);
    }
    process.exit(1);
  } finally {
    db.close();
  }
}

main().catch(error => {
  console.error(chalk.red('Fatal error:'), error.message);
  process.exit(1);
});