#!/usr/bin/env node

import { execSync } from 'child_process';
import path from 'path';
import { fileURLToPath } from 'url';
import chalk from 'chalk';
import { getDatabase } from '../src/database-service.js';
import { getSourcesForType, getWritableSource, writeEntryAndSync } from '../src/plugin-loader.js';
import {
  getConfiguredTimezone,
  getCurrentTimeISO,
  getTodayDate,
  getWeekAgoDate,
  subtractSecondsISO,
  formatTime
} from '../src/date-utils.js';
import {
  parseDuration,
  formatDurationMinutes,
  calculateDurationMinutes
} from '../src/duration-utils.js';
import {
  parseArgs,
  showSourceError,
  showSourceFilterError
} from '../src/cli-utils.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const PROJECT_ROOT = path.dirname(__dirname);

const TIMEZONE = getConfiguredTimezone();

// Start tracking
async function cmdStart(description, options = {}) {
  if (!description) {
    console.error(chalk.red('✗') + ' Usage: track start "Description with #topic/tags" [--source SOURCE]');
    console.log('');
    console.log('Examples:');
    console.log('  track start "Deep work session #topic/programming"');
    console.log('  track start "Duolingo practice #topic/languages"');
    console.log('  track start "Hip mobility workout #topic/fitness"');
    process.exit(1);
  }

  const db = getDatabase();
  const vaultPath = path.join(PROJECT_ROOT, 'vault');

  // Get target source
  const sourceResult = await getWritableSource('time-logs', options.source);
  if (!sourceResult.success) {
    showSourceError(sourceResult.error, sourceResult.availableSources);
    process.exit(1);
  }
  const { source } = sourceResult;

  // Check for running timer on this source
  const runningTimer = db.prepare(`
    SELECT start_time, description, source
    FROM time_logs
    WHERE end_time IS NULL AND source = ?
    ORDER BY start_time DESC
    LIMIT 1
  `).get(source.sourceId);

  if (runningTimer) {
    const currentTime = getCurrentTimeISO();
    const duration = calculateDurationMinutes(runningTimer.start_time, currentTime);
    const durationFormatted = formatDurationMinutes(duration);

    console.log(chalk.yellow('⚠') + ` Stopping previous timer: ${runningTimer.description} (${durationFormatted})`);

    // Stop the previous timer
    const stopEntry = {
      start_time: runningTimer.start_time,
      end_time: currentTime,
      description: runningTimer.description
    };

    const stopResult = await writeEntryAndSync('time-logs', stopEntry, {
      sourceFilter: options.source,
      db,
      vaultPath
    });

    if (!stopResult.success) {
      console.error(chalk.red('✗') + ` Failed to stop previous timer: ${stopResult.error}`);
      process.exit(1);
    }
  }

  // Start new timer (entry with NULL end_time)
  const startTime = getCurrentTimeISO();
  const entry = {
    start_time: startTime,
    end_time: null,
    description: description
  };

  const result = await writeEntryAndSync('time-logs', entry, {
    sourceFilter: options.source,
    db,
    vaultPath
  });

  if (!result.success) {
    console.error(chalk.red('✗') + ` Failed to start timer: ${result.error}`);
    process.exit(1);
  }

  console.log(chalk.green('✓') + ` Started: ${description}`);
  console.log(chalk.blue('ℹ') + ` Timezone: ${TIMEZONE}`);
}

// Stop command
async function cmdStop(options = {}) {
  const db = getDatabase();
  const vaultPath = path.join(PROJECT_ROOT, 'vault');

  // Find running timer(s)
  let query = `
    SELECT start_time, description, source
    FROM time_logs
    WHERE end_time IS NULL
    ORDER BY start_time DESC
  `;

  const runningTimers = db.prepare(query).all();

  if (runningTimers.length === 0) {
    console.error(chalk.red('✗') + ' No timer running');
    process.exit(1);
  }

  // If --source specified, filter to that source
  let timerToStop = runningTimers[0];
  if (options.source) {
    const matching = runningTimers.filter(t => t.source.includes(options.source));
    if (matching.length === 0) {
      console.error(chalk.red('✗') + ` No running timer matching source "${options.source}"`);
      console.log('');
      console.log('Running timers:');
      for (const t of runningTimers) {
        console.log(`  ${t.source}: ${t.description}`);
      }
      process.exit(1);
    }
    timerToStop = matching[0];
  } else if (runningTimers.length > 1) {
    // Multiple timers, require --source
    console.error(chalk.red('✗') + ' Multiple timers running. Use --source to specify which one to stop.');
    console.log('');
    console.log('Running timers:');
    for (const t of runningTimers) {
      console.log(`  ${t.source}: ${t.description}`);
    }
    process.exit(1);
  }

  const endTime = getCurrentTimeISO();
  const duration = calculateDurationMinutes(timerToStop.start_time, endTime);
  const durationFormatted = formatDurationMinutes(duration);

  // Complete the entry
  const entry = {
    start_time: timerToStop.start_time,
    end_time: endTime,
    description: timerToStop.description
  };

  // Extract plugin name from the source ID for filtering
  const [pluginName] = timerToStop.source.split('/');

  const result = await writeEntryAndSync('time-logs', entry, {
    sourceFilter: pluginName,
    db,
    vaultPath
  });

  if (!result.success) {
    console.error(chalk.red('✗') + ` Failed to stop timer: ${result.error}`);
    process.exit(1);
  }

  console.log(chalk.green('✓') + ` Stopped: ${timerToStop.description} (${durationFormatted})`);
}

// Add command - add a completed entry
async function cmdAdd(durationStr, options = {}) {
  // Handle case where description parts come after options parsing
  const descriptionParts = options._positional || [];
  const description = descriptionParts.join(' ');

  if (!durationStr || !description) {
    console.error(chalk.red('✗') + ' Usage: track add DURATION "Description with #topic/tags" [--source SOURCE]');
    console.log('');
    console.log('Examples:');
    console.log('  track add 20m "Reviewing pull requests #topic/programming"');
    console.log('  track add 2h "Deep work session #topic/programming"');
    console.log('  track add 1.5h "Language practice #topic/languages"');
    console.log('  track add 2h30m "Project planning #topic/personal_admin"');
    console.log('');
    console.log('Supported duration formats:');
    console.log('  20m, 35 minutes, 2h, 2 hours, 1.5h, 2h30m');
    process.exit(1);
  }

  const durationMinutes = parseDuration(durationStr);

  if (durationMinutes === 0) {
    console.error(chalk.red('✗') + ` Could not parse duration: ${durationStr}`);
    console.log('');
    console.log('Supported formats: 20m, 35 minutes, 2h, 2 hours, 1.5h, 2h30m');
    process.exit(1);
  }

  const endTime = getCurrentTimeISO();
  const durationSeconds = durationMinutes * 60;

  // Calculate start time
  const startTime = subtractSecondsISO(new Date(), durationSeconds);

  // Write entry via plugin and sync
  const entry = {
    start_time: startTime,
    end_time: endTime,
    description: description
  };

  const db = getDatabase();
  const vaultPath = path.join(PROJECT_ROOT, 'vault');

  const result = await writeEntryAndSync('time-logs', entry, {
    sourceFilter: options.source,
    db,
    vaultPath,
    onSync: () => console.log(chalk.gray('Syncing...'))
  });

  if (!result.success) {
    showSourceError(result.error, result.availableSources);
    process.exit(1);
  }

  const durationFormatted = formatDurationMinutes(durationMinutes);
  console.log(chalk.green('✓') + ` Added: ${description} (${durationFormatted})`);

  console.log(chalk.blue('ℹ') + ` Time range: ${formatTime(startTime)} - ${formatTime(endTime)}`);
}

// Status command - queries DB for running timers (end_time IS NULL)
async function cmdStatus() {
  const db = getDatabase();

  // Query for all running timers across all sources
  const runningTimers = db.prepare(`
    SELECT start_time, description, source
    FROM time_logs
    WHERE end_time IS NULL
    ORDER BY start_time DESC
  `).all();

  if (runningTimers.length === 0) {
    console.log(chalk.blue('ℹ') + ' No timer running');
    return;
  }

  console.log(chalk.cyan('⏱') + '  Currently tracking:');
  console.log('');

  const currentTime = getCurrentTimeISO();

  for (const timer of runningTimers) {
    const { start_time, description, source } = timer;
    const duration = calculateDurationMinutes(start_time, currentTime);
    const durationFormatted = formatDurationMinutes(duration);

    console.log('  ' + chalk.green(description));
    console.log(`  Started: ${formatTime(start_time)}`);
    console.log(`  Duration: ${durationFormatted}`);
    console.log(`  Source: ${chalk.gray(source)}`);

    if (runningTimers.length > 1) {
      console.log('');
    }
  }
}

// Today command - queries time_logs table
async function cmdToday(options = {}) {
  const db = getDatabase();
  const today = getTodayDate();

  // Validate source filter if provided
  if (options.source) {
    const { sources, allSources } = await getSourcesForType('time-logs', options.source);
    if (sources.length === 0) {
      showSourceFilterError(options.source, 'time-logs', allSources);
      return;
    }
    // Show which sources we're querying
    console.log(chalk.gray(`Sources: ${sources.map(s => s.sourceId).join(', ')}`));
    console.log('');
  }

  // Build query with optional source filter
  let query = `
    SELECT start_time, end_time, duration_minutes, description, source
    FROM time_logs
    WHERE date(start_time) = ?
    ORDER BY start_time
  `;
  const params = [today];

  if (options.source) {
    query = `
      SELECT start_time, end_time, duration_minutes, description, source
      FROM time_logs
      WHERE date(start_time) = ? AND source LIKE ?
      ORDER BY start_time
    `;
    params.push(`%${options.source}%`);
  }

  const entries = db.prepare(query).all(...params);

  if (entries.length === 0) {
    console.log(chalk.blue('ℹ') + ' No time entries for today');
    return;
  }

  console.log(chalk.cyan("Today's Time Tracking") + ` (${today})`);
  console.log('');

  let totalMinutes = 0;
  const topicMinutes = {};

  for (const entry of entries) {
    const { start_time, end_time, duration_minutes, description } = entry;
    const duration = duration_minutes || calculateDurationMinutes(start_time, end_time);

    if (!description) continue;

    const topics = (description.match(/#topic\/[a-z_]+/g) || ['(untagged)']).join(' ');

    totalMinutes += duration;
    topicMinutes[topics] = (topicMinutes[topics] || 0) + duration;

    // Display entry
    const startDisplay = formatTime(start_time);
    const endDisplay = end_time ? formatTime(end_time) : 'now';
    const symbol = end_time ? chalk.green('✓') : chalk.yellow('⏱');
    console.log(`  ${symbol} ${startDisplay} - ${endDisplay} (${formatDurationMinutes(duration)})`);
    console.log(`    ${description}`);
  }

  // Summary by topic
  if (Object.keys(topicMinutes).length > 0) {
    console.log('');
    console.log(chalk.cyan('By Topic:'));
    const sorted = Object.entries(topicMinutes).sort((a, b) => b[1] - a[1]);
    for (const [topic, mins] of sorted) {
      console.log(`  ${topic}: ${formatDurationMinutes(mins)}`);
    }
  }

  console.log('');
  console.log(chalk.cyan('Total:') + ` ${formatDurationMinutes(totalMinutes)}`);
}

// Week command - queries time_logs table
async function cmdWeek(options = {}) {
  const db = getDatabase();

  // Validate source filter if provided
  if (options.source) {
    const { sources, allSources } = await getSourcesForType('time-logs', options.source);
    if (sources.length === 0) {
      showSourceFilterError(options.source, 'time-logs', allSources);
      return;
    }
    // Show which sources we're querying
    console.log(chalk.gray(`Sources: ${sources.map(s => s.sourceId).join(', ')}`));
    console.log('');
  }

  // Calculate week start (7 days ago)
  const weekStart = getWeekAgoDate();
  const today = getTodayDate();

  // Build query with optional source filter
  let query = `
    SELECT start_time, end_time, duration_minutes, description, source
    FROM time_logs
    WHERE date(start_time) >= ? AND date(start_time) <= ?
    ORDER BY start_time
  `;
  const params = [weekStart, today];

  if (options.source) {
    query = `
      SELECT start_time, end_time, duration_minutes, description, source
      FROM time_logs
      WHERE date(start_time) >= ? AND date(start_time) <= ? AND source LIKE ?
      ORDER BY start_time
    `;
    params.push(`%${options.source}%`);
  }

  const entries = db.prepare(query).all(...params);

  if (entries.length === 0) {
    console.log(chalk.blue('ℹ') + ' No time entries for this week');
    return;
  }

  console.log(chalk.cyan("This Week's Time Tracking") + ` (${weekStart} to ${today})`);
  console.log('');

  let totalMinutes = 0;
  const topicMinutes = {};
  const dayMinutes = {};

  for (const entry of entries) {
    const { start_time, duration_minutes, description } = entry;
    const duration = duration_minutes || calculateDurationMinutes(start_time, entry.end_time);

    if (!description) continue;

    const entryDate = start_time.substring(0, 10);
    const topics = (description.match(/#topic\/[a-z_]+/g) || ['(untagged)']).join(' ');

    totalMinutes += duration;
    topicMinutes[topics] = (topicMinutes[topics] || 0) + duration;
    dayMinutes[entryDate] = (dayMinutes[entryDate] || 0) + duration;
  }

  // Summary by day
  console.log(chalk.cyan('By Day:'));
  const sortedDays = Object.entries(dayMinutes).sort((a, b) => a[0].localeCompare(b[0]));
  for (const [day, mins] of sortedDays) {
    console.log(`  ${day}: ${formatDurationMinutes(mins)}`);
  }

  // Summary by topic
  console.log('');
  console.log(chalk.cyan('By Topic:'));
  const sortedTopics = Object.entries(topicMinutes).sort((a, b) => b[1] - a[1]);
  for (const [topic, mins] of sortedTopics) {
    console.log(`  ${topic}: ${formatDurationMinutes(mins)}`);
  }

  console.log('');
  console.log(chalk.cyan('Total:') + ` ${formatDurationMinutes(totalMinutes)}`);
}

// Sync command - delegates to plugin system for all time-logs plugins
async function cmdSync() {
  console.log(chalk.blue('ℹ') + ' Syncing time-logs plugins to database...');

  try {
    const result = execSync('bin/plugins sync --type time-logs', { encoding: 'utf8' });
    // Strip dotenvx output and show result
    const lines = result.split('\n').filter(l => !l.includes('[dotenvx'));
    console.log(lines.join('\n'));
  } catch (error) {
    // Check if it's just "no plugins" vs actual error
    if (error.stdout?.includes('No plugins of type')) {
      console.log(chalk.yellow('⚠') + ' No time-logs plugins are enabled.');
      console.log('');
      console.log('To sync time tracking data, configure a plugin:');
      console.log('');
      console.log('  ' + chalk.cyan('bin/plugins configure'));
    } else {
      console.error(chalk.red('✗') + ' Sync failed:', error.message);
      process.exit(1);
    }
  }
}

// Main command handler
const { command, positional, options } = parseArgs();

switch (command) {
  case 'start':
    await cmdStart(positional.join(' '), options);
    break;
  case 'stop':
    await cmdStop(options);
    break;
  case 'add':
    await cmdAdd(positional[0], { ...options, _positional: positional.slice(1) });
    break;
  case 'status':
    await cmdStatus();
    break;
  case 'today':
    await cmdToday(options);
    break;
  case 'week':
    await cmdWeek(options);
    break;
  case 'sync':
    await cmdSync();
    break;
  default:
    console.log('Time Tracking CLI');
    console.log('');
    console.log('Usage: track [command] [options]');
    console.log('');
    console.log('Commands:');
    console.log('  start DESC [--source]       Start tracking time (include #topic/tags in description)');
    console.log('  stop [--source]             Stop current timer');
    console.log('  add DURATION DESC [--source] Add entry for work you forgot to track');
    console.log('  status                      Show current timer status');
    console.log('  today [--source NAME]       Show today\'s entries');
    console.log('  week [--source NAME]        Show this week\'s entries');
    console.log('  sync                        Sync all time-logs plugins to database');
    console.log('');
    console.log('Options:');
    console.log('  --source NAME               Filter by plugin source (e.g., markdown-time-tracking)');
    console.log('');
    console.log('Examples:');
    console.log('  track start "Deep work session #topic/programming"');
    console.log('  track stop');
    console.log('  track add 20m "Code review #topic/programming"');
    console.log('  track add 1.5h "Reading #topic/learning"');
    console.log('  track status');
    console.log('  track today');
    console.log('  track today --source toggl');
    console.log('  track week --source markdown');
    console.log('');
    console.log('Duration formats for \'add\' command:');
    console.log('  20m, 35 minutes, 2h, 2 hours, 1.5h, 2h30m');
    console.log('');
}
