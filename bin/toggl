#!/bin/bash
# Toggl time tracking sync and management

set -e

# Load common dotenvx handler
source "$(dirname "$0")/lib/dotenvx-loader.sh"
auto_dotenvx "$@"

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

# Check if API token is configured
check_config() {
    if [[ -z "$TOGGL_API_TOKEN" ]]; then
        print_error "TOGGL_API_TOKEN not configured in .env"
        echo ""
        echo "To get your Toggl API token:"
        echo "1. Log in to toggl.com"
        echo "2. Go to Profile Settings (click your avatar → Profile settings)"
        echo "3. Scroll down to 'API Token' section"
        echo "4. Copy your API token"
        echo "5. Add to .env file: TOGGL_API_TOKEN=your_token_here"
        echo ""
        exit 1
    fi
}

# Function to sync time entries
sync_entries() {
    local days="${1:-7}"
    print_info "Syncing Toggl time entries from last $days days..."
    
    # Calculate date range
    local end_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    local start_date=$(date -u -d "$days days ago" +"%Y-%m-%dT%H:%M:%SZ" 2>/dev/null || \
                       date -u -v-${days}d +"%Y-%m-%dT%H:%M:%SZ")
    
    # Fetch time entries from Toggl API
    print_info "Fetching entries from $start_date to $end_date..."
    
    local response=$(curl -s -u "$TOGGL_API_TOKEN:api_token" \
        "https://api.track.toggl.com/api/v9/me/time_entries?start_date=$start_date&end_date=$end_date")
    
    if [[ -z "$response" ]] || [[ "$response" == "null" ]]; then
        print_error "Failed to fetch time entries"
        return 1
    fi
    
    # Save to temp file for processing
    echo "$response" > /tmp/toggl_entries.json
    
    # Process with Node.js script
    node -e "
        import { getDatabase } from '$PROJECT_ROOT/src/database-service.js';
        import fs from 'fs';
        
        const entries = JSON.parse(fs.readFileSync('/tmp/toggl_entries.json', 'utf8'));
        const db = getDatabase();
        
        // Prepare insert statement
        const insertEntry = db.prepare(\`
            INSERT OR REPLACE INTO toggl_time_entries (
                id, description, wid, pid, tid, billable, start, stop, 
                duration, created_with, tags, duronly, at, user_id
            ) VALUES (
                ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?
            )
        \`);
        
        let count = 0;
        const transaction = db.transaction(() => {
            for (const entry of entries) {
                insertEntry.run(
                    entry.id,
                    entry.description || null,
                    entry.wid || null,
                    entry.pid || null,
                    entry.tid || null,
                    entry.billable ? 1 : 0,
                    entry.start,
                    entry.stop || null,
                    entry.duration || null,
                    entry.created_with || null,
                    entry.tags ? JSON.stringify(entry.tags) : null,
                    entry.duronly ? 1 : 0,
                    entry.at || null,
                    entry.user_id || null
                );
                count++;
            }
        });
        
        transaction();
        console.log(\`Synced \${count} time entries\`);
        
        // Clean up
        fs.unlinkSync('/tmp/toggl_entries.json');
        
        // Force exit after completion
        process.exit(0);
    " 2>&1 | while read line; do
        if [[ "$line" == *"Synced"* ]]; then
            print_status "$line"
        else
            print_info "$line"
        fi
    done
    
    return 0
}

# Function to sync projects
sync_projects() {
    print_info "Syncing Toggl projects..."
    
    # Get workspace ID first
    local me_response=$(curl -s -u "$TOGGL_API_TOKEN:api_token" \
        "https://api.track.toggl.com/api/v9/me")
    
    local workspace_id=$(echo "$me_response" | jq -r '.default_workspace_id // .workspace_id // 0')
    
    if [[ "$workspace_id" == "0" ]] || [[ -z "$workspace_id" ]]; then
        print_error "Could not get workspace ID"
        return 1
    fi
    
    print_info "Using workspace ID: $workspace_id"
    
    # Fetch projects
    local projects=$(curl -s -u "$TOGGL_API_TOKEN:api_token" \
        "https://api.track.toggl.com/api/v9/workspaces/$workspace_id/projects")
    
    if [[ -z "$projects" ]] || [[ "$projects" == "null" ]]; then
        print_info "No projects found or API error"
        return 0
    fi
    
    # Save to temp file
    echo "$projects" > /tmp/toggl_projects.json
    
    # Process with Node.js
    node -e "
        import { getDatabase } from '$PROJECT_ROOT/src/database-service.js';
        import fs from 'fs';
        
        const projects = JSON.parse(fs.readFileSync('/tmp/toggl_projects.json', 'utf8'));
        const db = getDatabase();
        
        const insertProject = db.prepare(\`
            INSERT OR REPLACE INTO toggl_projects (
                id, name, wid, cid, active, is_private, billable, color, at
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        \`);
        
        let count = 0;
        const transaction = db.transaction(() => {
            for (const project of projects) {
                insertProject.run(
                    project.id,
                    project.name,
                    project.wid || null,
                    project.cid || null,
                    project.active ? 1 : 0,
                    project.is_private ? 1 : 0,
                    project.billable ? 1 : 0,
                    project.color || null,
                    project.at || null
                );
                count++;
            }
        });
        
        transaction();
        console.log(\`Synced \${count} projects\`);
        
        fs.unlinkSync('/tmp/toggl_projects.json');
        
        // Force exit after completion
        process.exit(0);
    " 2>&1 | while read line; do
        if [[ "$line" == *"Synced"* ]]; then
            print_status "$line"
        else
            print_info "$line"
        fi
    done
    
    return 0
}

# Function to show today's summary
show_today() {
    print_info "Today's time tracking summary:"
    echo ""
    
    sqlite3 -column -header "$PROJECT_ROOT/.data/today.db" <<EOF
SELECT 
    COALESCE(p.name, 'No Project') as Project,
    printf('%.2f', SUM(te.duration) / 3600.0) as Hours,
    COUNT(*) as Entries,
    SUBSTR(GROUP_CONCAT(te.description, ', '), 1, 50) as Activities
FROM toggl_time_entries te
LEFT JOIN toggl_projects p ON te.pid = p.id
WHERE DATE(te.start) = DATE('now', 'localtime')
    AND te.stop IS NOT NULL
GROUP BY p.name
ORDER BY SUM(te.duration) DESC;
EOF
    
    echo ""
    echo "Total today:"
    sqlite3 "$PROJECT_ROOT/.data/today.db" <<EOF
SELECT 
    printf('%.2f hours', SUM(duration) / 3600.0) as total,
    COUNT(*) || ' entries' as count
FROM toggl_time_entries
WHERE DATE(start) = DATE('now', 'localtime')
    AND stop IS NOT NULL;
EOF
}

# Function to show weekly summary
show_week() {
    print_info "This week's time tracking summary:"
    echo ""
    
    sqlite3 -column -header "$PROJECT_ROOT/.data/today.db" <<EOF
SELECT 
    DATE(start) as Date,
    printf('%.2f', SUM(duration) / 3600.0) as Hours,
    COUNT(*) as Entries,
    GROUP_CONCAT(DISTINCT COALESCE(p.name, 'No Project')) as Projects
FROM toggl_time_entries te
LEFT JOIN toggl_projects p ON te.pid = p.id
WHERE DATE(start) >= DATE('now', '-7 days', 'localtime')
    AND stop IS NOT NULL
GROUP BY DATE(start)
ORDER BY DATE(start) DESC;
EOF
    
    echo ""
    echo "Week total by project:"
    sqlite3 -column -header "$PROJECT_ROOT/.data/today.db" <<EOF
SELECT 
    COALESCE(p.name, 'No Project') as Project,
    printf('%.2f', SUM(te.duration) / 3600.0) as Hours
FROM toggl_time_entries te
LEFT JOIN toggl_projects p ON te.pid = p.id
WHERE DATE(te.start) >= DATE('now', '-7 days', 'localtime')
    AND te.stop IS NOT NULL
GROUP BY p.name
ORDER BY SUM(te.duration) DESC;
EOF
}

# Function to analyze patterns
analyze_patterns() {
    print_info "Analyzing time tracking patterns..."
    echo ""
    
    echo "Most productive hours (last 30 days):"
    sqlite3 -column -header "$PROJECT_ROOT/.data/today.db" <<EOF
SELECT 
    strftime('%H:00', start) as Hour,
    printf('%.2f', SUM(duration) / 3600.0) as 'Total Hours',
    COUNT(*) as Entries
FROM toggl_time_entries
WHERE DATE(start) >= DATE('now', '-30 days', 'localtime')
    AND stop IS NOT NULL
GROUP BY strftime('%H', start)
ORDER BY SUM(duration) DESC
LIMIT 8;
EOF
    
    echo ""
    echo "Average daily hours (last 30 days):"
    sqlite3 "$PROJECT_ROOT/.data/today.db" <<EOF
SELECT 
    printf('%.2f hours', AVG(daily_hours)) as 'Average Daily Hours'
FROM (
    SELECT 
        DATE(start) as date,
        SUM(duration) / 3600.0 as daily_hours
    FROM toggl_time_entries
    WHERE DATE(start) >= DATE('now', '-30 days', 'localtime')
        AND DATE(start) < DATE('now', 'localtime')
        AND stop IS NOT NULL
    GROUP BY DATE(start)
);
EOF
    
    echo ""
    echo "Most used tags (last 30 days):"
    sqlite3 -column -header "$PROJECT_ROOT/.data/today.db" <<EOF
WITH tag_entries AS (
    SELECT 
        json_each.value as tag,
        duration
    FROM toggl_time_entries, json_each(tags)
    WHERE DATE(start) >= DATE('now', '-30 days', 'localtime')
        AND stop IS NOT NULL
        AND tags IS NOT NULL
)
SELECT 
    tag as Tag,
    printf('%.2f', SUM(duration) / 3600.0) as Hours,
    COUNT(*) as Entries
FROM tag_entries
GROUP BY tag
ORDER BY SUM(duration) DESC
LIMIT 10;
EOF
}

# Main command handling
case "${1:-}" in
    sync)
        check_config
        days="${2:-7}"
        sync_entries "$days"
        sync_projects
        show_today
        ;;
    today)
        show_today
        ;;
    week)
        show_week
        ;;
    analyze)
        analyze_patterns
        ;;
    projects)
        check_config
        sync_projects
        ;;
    setup)
        echo "Toggl Time Tracking Setup"
        echo "========================="
        echo ""
        echo "1. Get your API token from toggl.com:"
        echo "   - Log in to toggl.com"
        echo "   - Click your avatar → Profile settings"
        echo "   - Scroll to 'API Token' section"
        echo "   - Copy the token"
        echo ""
        echo "2. Add to your .env file:"
        echo "   TOGGL_API_TOKEN=your_token_here"
        echo ""
        echo "3. Run 'bin/toggl sync' to import your time entries"
        echo ""
        echo "4. The sync will be added to 'bin/sync' for daily updates"
        ;;
    *)
        echo "Usage: toggl [command] [options]"
        echo ""
        echo "Commands:"
        echo "  sync [days]  Sync time entries (default: 7 days)"
        echo "  today        Show today's time tracking"
        echo "  week         Show this week's summary"
        echo "  analyze      Analyze tracking patterns"
        echo "  projects     Sync only projects"
        echo "  setup        Show setup instructions"
        echo ""
        echo "Examples:"
        echo "  toggl sync        # Sync last 7 days"
        echo "  toggl sync 30     # Sync last 30 days"
        echo "  toggl today       # Show today's tracked time"
        echo "  toggl analyze     # Analyze patterns"
        ;;
esac