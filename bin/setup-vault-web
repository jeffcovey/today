#!/bin/bash
# Setup script for vault web server on DigitalOcean droplet

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

print_status() { echo -e "${GREEN}✓${NC} $1"; }
print_info() { echo -e "${BLUE}ℹ${NC} $1"; }
print_warning() { echo -e "${YELLOW}⚠${NC} $1"; }
print_error() { echo -e "${RED}✗${NC} $1"; }

# Check if running on droplet
if [ ! -d "/opt/today" ]; then
    print_error "This script should be run on the DigitalOcean droplet"
    exit 1
fi

cd /opt/today

# Step 1: Install nginx if not already installed
if ! command -v nginx &> /dev/null; then
    print_info "Installing nginx..."
    apt-get update
    apt-get install -y nginx certbot python3-certbot-nginx
    print_status "Nginx installed"
else
    print_status "Nginx already installed"
fi

# Step 2: Get domain name from user
if [ -z "$1" ]; then
    echo "Usage: $0 <domain-name>"
    echo "Example: $0 vault.example.com"
    exit 1
fi

DOMAIN=$1

# Step 3: Add web server credentials to .env if not present
if ! grep -q "WEB_USER" .env 2>/dev/null; then
    print_info "Setting up web server credentials..."
    
    # Generate random password
    WEB_PASSWORD=$(openssl rand -base64 32)
    
    cat >> .env << EOF

# Vault Web Server
WEB_USER=admin
WEB_PASSWORD=$WEB_PASSWORD
WEB_PORT=3001
EOF
    
    # Encrypt the updated .env
    npx dotenvx encrypt
    
    print_status "Web credentials added to .env"
    print_warning "Web password: $WEB_PASSWORD"
    print_warning "Save this password! It's encrypted in .env"
else
    print_status "Web credentials already configured"
fi

# Step 4: Install the systemd service
print_info "Installing vault-web service..."
cp config/vault-web.service /etc/systemd/system/
systemctl daemon-reload
systemctl enable vault-web
systemctl start vault-web
print_status "Vault web service installed and started"

# Step 5: Configure nginx
print_info "Configuring nginx..."

# Create nginx config from template
cat > /etc/nginx/sites-available/$DOMAIN << EOF
server {
    listen 80;
    server_name $DOMAIN;
    
    location / {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_cache_bypass \$http_upgrade;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
    
    client_max_body_size 10M;
}
EOF

# Enable the site
ln -sf /etc/nginx/sites-available/$DOMAIN /etc/nginx/sites-enabled/

# Test nginx config
nginx -t

# Reload nginx
systemctl reload nginx
print_status "Nginx configured"

# Step 6: Setup SSL with Let's Encrypt
print_info "Setting up SSL certificate..."
print_warning "Make sure your domain $DOMAIN points to this server's IP!"
read -p "Press enter when ready to continue with SSL setup..."

certbot --nginx -d $DOMAIN --non-interactive --agree-tos --email admin@$DOMAIN --redirect

print_status "SSL certificate installed"

# Step 7: Add firewall rules if ufw is enabled
if command -v ufw &> /dev/null && ufw status | grep -q "Status: active"; then
    print_info "Configuring firewall..."
    ufw allow 'Nginx Full'
    print_status "Firewall configured"
fi

# Step 8: Test the service
print_info "Testing web server..."
if curl -s -o /dev/null -w "%{http_code}" http://localhost:3001 | grep -q "401"; then
    print_status "Web server is running (auth required)"
else
    print_warning "Web server may not be running correctly"
    print_info "Check logs with: journalctl -u vault-web -f"
fi

print_status "Setup complete!"
echo ""
echo "Your vault is now available at: https://$DOMAIN"
echo ""
echo "To view credentials:"
echo "  npx dotenvx run -- bash -c 'echo Username: \$WEB_USER; echo Password: \$WEB_PASSWORD'"
echo ""
echo "To check service status:"
echo "  systemctl status vault-web"
echo ""
echo "To view logs:"
echo "  journalctl -u vault-web -f"