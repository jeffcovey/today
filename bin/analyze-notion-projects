#!/usr/bin/env node

import { config } from 'dotenv';
import { NotionAPI } from '../src/notion-api.js';
import chalk from 'chalk';

config();

async function analyzeProjectsDatabase() {
  const notionToken = process.env.NOTION_TOKEN;
  
  if (!notionToken) {
    console.error(chalk.red('‚ùå NOTION_TOKEN not found in .env file'));
    process.exit(1);
  }

  const notion = new NotionAPI(notionToken);
  
  try {
    console.log(chalk.cyan('\nüìä Analyzing Notion Projects Database\n'));
    
    // Get the projects database
    const projectsDB = await notion.getProjectsDatabase();
    if (!projectsDB) {
      console.error(chalk.red('Projects database not found'));
      process.exit(1);
    }
    
    console.log(chalk.green('‚úÖ Found Projects Database:'));
    console.log(`   ID: ${projectsDB.id}`);
    console.log(`   Title: ${projectsDB.title}`);
    console.log(`   URL: ${projectsDB.url}\n`);
    
    // Get database schema
    console.log(chalk.cyan('üìã Database Schema:'));
    const schema = await notion.getDatabaseSchema(projectsDB.id);
    
    console.log('\nProperties:');
    for (const [propName, propInfo] of Object.entries(schema.properties)) {
      console.log(`   ${chalk.yellow(propName)}: ${propInfo.type}`);
      
      // Show additional details for certain property types
      if (propInfo.type === 'select' || propInfo.type === 'status') {
        const fullProp = schema.fullDatabase.properties[propName];
        if (fullProp[propInfo.type]?.options) {
          console.log(`      Options:`);
          fullProp[propInfo.type].options.forEach(opt => {
            console.log(`         - ${opt.name}`);
          });
        }
        if (fullProp.status?.groups) {
          console.log(`      Groups:`);
          fullProp.status.groups.forEach(group => {
            console.log(`         - ${group.name}: ${group.option_ids.length} options`);
          });
        }
      } else if (propInfo.type === 'relation') {
        console.log(`      Related DB: ${propInfo.relation?.database_id}`);
      } else if (propInfo.type === 'formula') {
        const fullProp = schema.fullDatabase.properties[propName];
        if (fullProp.formula?.expression) {
          console.log(`      Expression: ${fullProp.formula.expression}`);
        }
      }
    }
    
    // Get sample projects with all properties
    console.log(chalk.cyan('\nüìÅ Sample Projects (first 5):'));
    const response = await notion.notion.databases.query({
      database_id: projectsDB.id,
      page_size: 5,
      sorts: [
        {
          timestamp: 'last_edited_time',
          direction: 'descending'
        }
      ]
    });
    
    for (const [index, project] of response.results.entries()) {
      console.log(`\n${chalk.green(`Project ${index + 1}:`)} ${notion.extractTitle(project)}`);
      console.log(`   ID: ${project.id}`);
      console.log(`   Created: ${new Date(project.created_time).toLocaleDateString()}`);
      console.log(`   Last Edited: ${new Date(project.last_edited_time).toLocaleDateString()}`);
      console.log(`   URL: ${project.url}`);
      
      console.log(`\n   Properties:`);
      for (const [propName, propValue] of Object.entries(project.properties)) {
        const value = notion.formatPropertyValue(propValue);
        if (value) {
          console.log(`      ${propName}: ${value}`);
        }
      }
    }
    
    // Get statistics
    console.log(chalk.cyan('\nüìà Statistics:'));
    
    // Count all projects
    const allProjectsResponse = await notion.notion.databases.query({
      database_id: projectsDB.id,
      page_size: 100
    });
    
    console.log(`   Total Projects: ${allProjectsResponse.results.length}`);
    
    // Count by status
    const statusCounts = {};
    allProjectsResponse.results.forEach(project => {
      const status = notion.getStatusValue(project.properties.Status) || 'No Status';
      statusCounts[status] = (statusCounts[status] || 0) + 1;
    });
    
    console.log(`   By Status:`);
    for (const [status, count] of Object.entries(statusCounts)) {
      console.log(`      ${status}: ${count}`);
    }
    
    // Check for related databases
    console.log(chalk.cyan('\nüîó Related Databases:'));
    const relationProperties = Object.entries(schema.properties)
      .filter(([_, prop]) => prop.type === 'relation');
    
    if (relationProperties.length > 0) {
      for (const [propName, propInfo] of relationProperties) {
        console.log(`   ${propName} ‚Üí Database ID: ${propInfo.relation?.database_id}`);
      }
    } else {
      console.log('   No relations found');
    }
    
  } catch (error) {
    console.error(chalk.red(`\n‚ùå Error: ${error.message}`));
    process.exit(1);
  } finally {
    notion.close();
  }
}

analyzeProjectsDatabase();