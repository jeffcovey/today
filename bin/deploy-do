#!/bin/bash
# Deploy to DigitalOcean Droplet
# This script helps manage deployment to a DigitalOcean droplet

set -e

# If we're not already running under dotenvx, wrap ourselves
if [ -z "$DOTENVX_INJECTED" ]; then
    export DOTENVX_INJECTED=1
    exec npx dotenvx run -- "$0" "$@"
fi

# Configuration
DROPLET_IP="${DO_DROPLET_IP:-}"
DROPLET_USER="${DO_DROPLET_USER:-root}"
DEPLOY_PATH="/opt/today"
SSH_KEY="${HOME}/.ssh/do_deploy_key"

# Check if deployment key exists
if [ ! -f "$SSH_KEY" ]; then
    echo "âš ï¸  Deployment key not found. Setting up..."
    .devcontainer/setup-ssh-keys.sh
fi

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

print_status() { echo -e "${GREEN}âœ“${NC} $1"; }
print_info() { echo -e "${BLUE}â„¹${NC} $1"; }
print_warning() { echo -e "${YELLOW}âš ${NC} $1"; }
print_error() { echo -e "${RED}âœ—${NC} $1"; }

# Check if IP is configured
check_config() {
    if [ -z "$DROPLET_IP" ]; then
        print_error "DROPLET_IP not set!"
        echo "Please set your droplet IP:"
        echo "  export DO_DROPLET_IP=your.droplet.ip.address"
        echo "Or add to .env:"
        echo "  DO_DROPLET_IP=your.droplet.ip.address"
        exit 1
    fi
}

# Parse arguments
ACTION="${1:-deploy}"

case "$ACTION" in
    setup)
        echo "ðŸš€ Initial setup of DigitalOcean droplet..."
        check_config
        
        print_info "This will install Node.js, Git, and dependencies on your droplet"
        # Check if running non-interactively or with --yes flag
        if [ ! -t 0 ] || [ "$2" = "--yes" ] || [ "$2" = "-y" ]; then
            REPLY="y"
        else
            read -p "Continue? (y/n) " -n 1 -r
            echo
        fi
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
        
        print_info "Copying setup script to droplet..."
        scp -i "$SSH_KEY" bin/setup-droplet.sh ${DROPLET_USER}@${DROPLET_IP}:/tmp/
        
        print_info "Running setup on droplet..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "bash /tmp/setup-droplet.sh"
        
        print_status "Setup complete!"
        echo "Run 'bin/deploy-do deploy' to deploy your code"
        ;;
        
    deploy)
        echo "ðŸš¢ Deploying to DigitalOcean..."
        check_config
        
        print_info "Syncing code to ${DROPLET_USER}@${DROPLET_IP}:${DEPLOY_PATH}"
        
        # Create deployment and data directories if they don't exist
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "mkdir -p ${DEPLOY_PATH} ${DEPLOY_PATH}/.data"
        
        # Sync files (INCLUDING .git for sync operations, but excluding node_modules and local data)
        # IMPORTANT: --delete will remove files not in source, but excluded dirs are preserved
        rsync -avz --delete -e "ssh -i $SSH_KEY" \
            --exclude='node_modules' \
            --exclude='.data' \
            --exclude='.notion-cache' \
            --exclude='.calendar-cache' \
            --exclude='.env.keys' \
            --exclude='.last-dep-check' \
            ./ ${DROPLET_USER}@${DROPLET_IP}:${DEPLOY_PATH}/
        
        # Ensure git is configured properly on droplet
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "git config --global --add safe.directory ${DEPLOY_PATH}" 2>/dev/null || true
        
        # Configure git user identity for commits
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "git config --global user.email 'today-bot@system.local' && git config --global user.name 'Today Bot'" 2>/dev/null || true
        
        # Setup tmux config if not exists
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "[ ! -f ~/.tmux.conf ] && echo 'set -g default-command \"cd /opt/today && exec bash\"' > ~/.tmux.conf || true" 2>/dev/null || true
        
        # Configure git to use GitHub token for authentication (if available)
        print_info "Configuring GitHub authentication..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && npx dotenvx run -- bash -c 'if [ -n \"\$GITHUB_TOKEN\" ]; then echo \"https://\${GITHUB_TOKEN}:x-oauth-basic@github.com\" > ~/.git-credentials && git config --global credential.helper store && echo \"âœ“ GitHub token configured\"; fi'" 2>/dev/null || true
        
        print_info "Installing dependencies..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && npm install --production"
        
        # Only initialize database if it doesn't exist
        if ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "[ ! -f ${DEPLOY_PATH}/.data/today.db ]"; then
            print_info "First deployment - initializing database..."
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && timeout 30 npx dotenvx run -- node src/migrations.js"
            
            print_info "Pulling all data from Turso (this may take a while)..."
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && rm -f .data/turso-sync.json && npx dotenvx run -- bin/turso-sync pull --full" || print_warning "Full pull may have been interrupted"
        else
            print_info "Database exists, running migrations..."
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && timeout 30 npx dotenvx run -- node src/migrations.js" || print_warning "Migrations may have already run"
        fi
        
        print_info "Restarting services..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl restart today-scheduler || true"
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl restart vault-web || true"
        
        print_status "Deployment complete!"
        ;;
        
    secrets)
        echo "ðŸ” Updating secrets on droplet..."
        check_config
        
        print_info "Copying .env file..."
        scp -i "$SSH_KEY" .env ${DROPLET_USER}@${DROPLET_IP}:${DEPLOY_PATH}/.env
        
        if [ -f .env.keys ]; then
            print_info "Extracting and copying decryption key..."
            # Extract just the key value, not the whole file
            PRIVATE_KEY=$(grep '^DOTENV_PRIVATE_KEY=' .env.keys | cut -d= -f2)
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "echo 'DOTENV_PRIVATE_KEY=${PRIVATE_KEY}' > ${DEPLOY_PATH}/.env.keys"
        fi
        
        print_info "Setting proper permissions..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "chmod 600 ${DEPLOY_PATH}/.env*"
        
        print_info "Restarting services..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl restart today-scheduler || true"
        
        print_status "Secrets updated!"
        ;;
        
    ssh)
        echo "ðŸ”Œ Connecting to droplet..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP}
        ;;
        
    logs)
        echo "ðŸ“Š Showing scheduler logs..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "journalctl -u today-scheduler -f"
        ;;
        
    status)
        echo "ðŸ“ˆ Checking status..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl status today-scheduler"
        ;;
        
    nginx-config)
        echo "ðŸ”§ Updating nginx configuration..."
        check_config
        
        print_info "Copying nginx config to droplet..."
        scp -i "$SSH_KEY" config/nginx-vault-web-fixed.conf ${DROPLET_USER}@${DROPLET_IP}:/tmp/
        
        print_info "Installing nginx config..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sudo cp /tmp/nginx-vault-web-fixed.conf /etc/nginx/sites-available/today.jeffcovey.net"
        
        print_info "Testing nginx configuration..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sudo nginx -t"
        
        print_info "Reloading nginx..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sudo systemctl reload nginx"
        
        print_status "Nginx configuration updated!"
        ;;
        
    restart)
        echo "ðŸ”„ Restarting scheduler..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl restart today-scheduler"
        print_status "Scheduler restarted"
        ;;
        
    web-restart)
        echo "ðŸŒ Restarting web server..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl restart vault-web"
        print_status "Web server restarted"
        ;;
        
    stop)
        echo "â¹ Stopping scheduler..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl stop today-scheduler"
        print_status "Scheduler stopped"
        ;;
        
    start)
        echo "â–¶ï¸ Starting scheduler..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl start today-scheduler"
        print_status "Scheduler started"
        ;;
        
    db-init)
        echo "ðŸ—„ï¸ Initializing database..."
        check_config
        print_info "Creating .data directory..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "mkdir -p ${DEPLOY_PATH}/.data"
        
        print_info "Running database migrations..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && npx dotenvx run -- node src/migrations.js"
        
        print_status "Database initialized!"
        ;;
        
    git-setup)
        echo "ðŸ”§ Setting up git repository on droplet..."
        check_config
        
        print_info "Copying .git directory to droplet..."
        rsync -avzh --progress -e "ssh -i $SSH_KEY" \
            .git/ ${DROPLET_USER}@${DROPLET_IP}:${DEPLOY_PATH}/.git/
        
        print_info "Configuring git safe directory..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "git config --global --add safe.directory ${DEPLOY_PATH}"
        
        print_info "Configuring git user identity..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "git config --global user.email 'today-bot@system.local' && git config --global user.name 'Today Bot'"
        
        print_info "Configuring GitHub authentication..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && npx dotenvx run -- bash -c 'if [ -n \"\$GITHUB_TOKEN\" ]; then echo \"https://\${GITHUB_TOKEN}:x-oauth-basic@github.com\" > ~/.git-credentials && git config --global credential.helper store && echo \"âœ“ GitHub token configured\"; else echo \"âš  No GITHUB_TOKEN found\"; fi'"
        
        print_info "Testing git access..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && npx dotenvx run -- git fetch --dry-run" 2>/dev/null && print_status "Git fetch successful!" || print_warning "Git fetch failed - check GITHUB_TOKEN"
        
        print_info "Checking git status..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && git status --short"
        
        print_status "Git repository configured!"
        ;;
        
    db-upload)
        echo "ðŸ“¤ Uploading local database to droplet..."
        check_config
        
        if [ ! -f ".data/today.db" ]; then
            print_error "Local database .data/today.db not found!"
            exit 1
        fi
        
        # Allow custom target name (e.g., today.db.macbook)
        TARGET_NAME="${2:-today.db}"
        
        print_info "Backing up existing database on droplet..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && [ -f .data/today.db ] && cp .data/today.db .data/today.db.backup-$(date +%Y%m%d-%H%M%S) || true"
        
        print_info "Uploading database ($(du -h .data/today.db | cut -f1)) using rsync..."
        # Using -avzh as you confirmed works (z for compression, h for human-readable)
        rsync -avzh --progress -e "ssh -i $SSH_KEY" \
            .data/today.db ${DROPLET_USER}@${DROPLET_IP}:${DEPLOY_PATH}/.data/${TARGET_NAME}
        
        # If uploaded with different name, move to today.db
        if [ "$TARGET_NAME" != "today.db" ]; then
            print_info "Moving ${TARGET_NAME} to today.db..."
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH}/.data && mv ${TARGET_NAME} today.db"
        fi
        
        print_info "Setting permissions..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "chmod 644 ${DEPLOY_PATH}/.data/today.db"
        
        print_info "Verifying upload..."
        LOCAL_SIZE=$(du -b .data/today.db | cut -f1)
        REMOTE_SIZE=$(ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "du -b ${DEPLOY_PATH}/.data/today.db | cut -f1")
        if [ "$LOCAL_SIZE" != "$REMOTE_SIZE" ]; then
            print_warning "Size mismatch: local=$LOCAL_SIZE remote=$REMOTE_SIZE"
        else
            print_status "Database size verified: $(du -h .data/today.db | cut -f1)"
        fi
        
        # Quick data check
        TASK_COUNT=$(ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sqlite3 ${DEPLOY_PATH}/.data/today.db 'SELECT COUNT(*) FROM tasks' 2>/dev/null || echo 0")
        print_info "Database contains $TASK_COUNT tasks"
        
        print_status "Database uploaded successfully!"
        ;;
        
    ollama-setup)
        echo "ðŸ¤– Setting up Ollama on droplet..."
        check_config
        
        print_info "Installing Ollama..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "curl -fsSL https://ollama.com/install.sh | sh"
        
        print_info "Starting Ollama service..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl enable ollama && systemctl start ollama"
        
        print_info "Waiting for Ollama to start..."
        sleep 5
        
        print_info "Testing Ollama installation..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "ollama --version"
        
        print_info "Checking available memory..."
        AVAILABLE_MB=$(ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "free -m | awk '/^Mem:/ {print \$7}'")
        
        if [ "$AVAILABLE_MB" -lt 800 ]; then
            print_warning "Only ${AVAILABLE_MB}MB RAM available. LLMs need at least 800MB."
            print_warning "Consider upgrading to a 2GB droplet ($12/month) for local LLM support."
            print_info "Skipping model download due to insufficient memory."
        else
            print_info "Pulling tinyllama model (637MB) - fastest small model..."
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "ollama pull tinyllama"
            
            print_info "Testing model..."
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "echo 'What is 2+2?' | ollama run tinyllama"
        fi
        
        print_status "Ollama setup complete!"
        print_info "Available at http://localhost:11434 on the droplet"
        print_info "Add OLLAMA_HOST=http://localhost:11434 to your .env"
        ;;
        
    ollama)
        echo "ðŸ¤– Managing Ollama models..."
        check_config
        
        case "${2:-list}" in
            list)
                print_info "Installed models:"
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "ollama list"
                ;;
            pull)
                if [ -z "$3" ]; then
                    print_error "Usage: bin/deploy-do ollama pull <model>"
                    echo "Recommended models (memory requirements):"
                    echo "  â€¢ tinyllama (800MB RAM) - Very fast, basic quality"  
                    echo "  â€¢ phi3 (4GB RAM) - Good balance of speed and quality"
                    echo "  â€¢ mistral (6GB RAM) - Better quality"
                    echo "  â€¢ codellama (5GB RAM) - For coding tasks"
                    exit 1
                fi
                print_info "Pulling model: $3"
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "ollama pull $3"
                ;;
            rm)
                if [ -z "$3" ]; then
                    print_error "Usage: bin/deploy-do ollama rm <model>"
                    exit 1
                fi
                print_info "Removing model: $3"
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "ollama rm $3"
                ;;
            test)
                MODEL="${3:-phi3-mini}"
                print_info "Testing model: $MODEL"
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "echo 'Hello, how are you?' | ollama run $MODEL"
                ;;
            *)
                echo "Usage: bin/deploy-do ollama [list|pull <model>|rm <model>|test [model]]"
                ;;
        esac
        ;;

    exec)
        if [ -z "$2" ]; then
            print_error "Usage: bin/deploy-do exec 'command'"
            exit 1
        fi
        check_config
        shift
        echo "âš¡ Executing: $*"
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && $*"
        ;;
        
    *)
        echo "Usage: bin/deploy-do [command]"
        echo ""
        echo "Commands:"
        echo "  setup       - Initial droplet setup (run once)"
        echo "  deploy      - Deploy code to droplet (default, includes .git)"
        echo "  secrets     - Update .env files"
        echo "  db-init     - Initialize database"
        echo "  db-upload   - Upload local database to droplet"
        echo "  git-setup   - Manually setup git repository"
        echo "  ollama-setup - Install and setup Ollama with phi3-mini model"
        echo "  ollama      - Manage Ollama models (list|pull|rm|test)"
        echo "  nginx-config - Update nginx configuration"
        echo "  ssh         - SSH into droplet"
        echo "  logs        - Show scheduler logs"
        echo "  status      - Show scheduler status"
        echo "  restart     - Restart scheduler"
        echo "  web-restart - Restart web server"
        echo "  stop        - Stop scheduler"
        echo "  start       - Start scheduler"
        echo "  exec CMD    - Execute command in deploy directory"
        echo ""
        echo "First time setup:"
        echo "  1. Create a DigitalOcean droplet (Ubuntu 24.04)"
        echo "  2. Add DO_DROPLET_IP to .env and encrypt with dotenvx"
        echo "  3. bin/deploy-do setup       # Install dependencies on droplet"
        echo "  4. bin/deploy-do secrets     # Copy encrypted secrets"
        echo "  5. bin/deploy-do deploy      # Deploy code (includes .git)"
        echo "  6. bin/deploy-do db-upload   # Upload your local database"
        echo "  7. bin/deploy-do ollama-setup # Install Ollama with phi3-mini model"
        echo ""
        echo "Note: deploy now includes .git for sync operations"
        ;;
esac