#!/bin/bash
# Deploy to DigitalOcean Droplet
# This script helps manage deployment to a DigitalOcean droplet

set -e

# Configuration
DROPLET_IP="${DO_DROPLET_IP:-}"
DROPLET_USER="${DO_DROPLET_USER:-root}"
DEPLOY_PATH="/opt/today"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

print_status() { echo -e "${GREEN}‚úì${NC} $1"; }
print_info() { echo -e "${BLUE}‚Ñπ${NC} $1"; }
print_warning() { echo -e "${YELLOW}‚ö†${NC} $1"; }
print_error() { echo -e "${RED}‚úó${NC} $1"; }

# Check if IP is configured
check_config() {
    if [ -z "$DROPLET_IP" ]; then
        print_error "DROPLET_IP not set!"
        echo "Please set your droplet IP:"
        echo "  export DO_DROPLET_IP=your.droplet.ip.address"
        echo "Or add to .env:"
        echo "  DO_DROPLET_IP=your.droplet.ip.address"
        exit 1
    fi
}

# Parse arguments
ACTION="${1:-deploy}"

case "$ACTION" in
    setup)
        echo "üöÄ Initial setup of DigitalOcean droplet..."
        check_config
        
        print_info "This will install Node.js, Git, and dependencies on your droplet"
        read -p "Continue? (y/n) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
        
        print_info "Copying setup script to droplet..."
        scp bin/setup-droplet.sh ${DROPLET_USER}@${DROPLET_IP}:/tmp/
        
        print_info "Running setup on droplet..."
        ssh ${DROPLET_USER}@${DROPLET_IP} "bash /tmp/setup-droplet.sh"
        
        print_status "Setup complete!"
        echo "Run 'bin/deploy-do deploy' to deploy your code"
        ;;
        
    deploy)
        echo "üö¢ Deploying to DigitalOcean..."
        check_config
        
        print_info "Syncing code to ${DROPLET_USER}@${DROPLET_IP}:${DEPLOY_PATH}"
        
        # Create deployment directory if it doesn't exist
        ssh ${DROPLET_USER}@${DROPLET_IP} "mkdir -p ${DEPLOY_PATH}"
        
        # Sync files (excluding .git, node_modules, and local data)
        rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.data' \
            --exclude='.notion-cache' \
            --exclude='.calendar-cache' \
            --exclude='.env.keys' \
            --exclude='.last-dep-check' \
            --exclude='.devcontainer' \
            ./ ${DROPLET_USER}@${DROPLET_IP}:${DEPLOY_PATH}/
        
        print_info "Installing dependencies..."
        ssh ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && npm install --production"
        
        print_info "Restarting services..."
        ssh ${DROPLET_USER}@${DROPLET_IP} "systemctl restart today-scheduler || true"
        
        print_status "Deployment complete!"
        ;;
        
    secrets)
        echo "üîê Updating secrets on droplet..."
        check_config
        
        print_info "Copying .env file..."
        scp .env ${DROPLET_USER}@${DROPLET_IP}:${DEPLOY_PATH}/.env
        
        if [ -f .env.keys ]; then
            print_info "Copying .env.keys file..."
            scp .env.keys ${DROPLET_USER}@${DROPLET_IP}:${DEPLOY_PATH}/.env.keys
        fi
        
        print_info "Setting proper permissions..."
        ssh ${DROPLET_USER}@${DROPLET_IP} "chmod 600 ${DEPLOY_PATH}/.env*"
        
        print_info "Restarting services..."
        ssh ${DROPLET_USER}@${DROPLET_IP} "systemctl restart today-scheduler || true"
        
        print_status "Secrets updated!"
        ;;
        
    ssh)
        echo "üîå Connecting to droplet..."
        check_config
        ssh ${DROPLET_USER}@${DROPLET_IP}
        ;;
        
    logs)
        echo "üìä Showing scheduler logs..."
        check_config
        ssh ${DROPLET_USER}@${DROPLET_IP} "journalctl -u today-scheduler -f"
        ;;
        
    status)
        echo "üìà Checking status..."
        check_config
        ssh ${DROPLET_USER}@${DROPLET_IP} "systemctl status today-scheduler"
        ;;
        
    restart)
        echo "üîÑ Restarting scheduler..."
        check_config
        ssh ${DROPLET_USER}@${DROPLET_IP} "systemctl restart today-scheduler"
        print_status "Scheduler restarted"
        ;;
        
    stop)
        echo "‚èπ Stopping scheduler..."
        check_config
        ssh ${DROPLET_USER}@${DROPLET_IP} "systemctl stop today-scheduler"
        print_status "Scheduler stopped"
        ;;
        
    start)
        echo "‚ñ∂Ô∏è Starting scheduler..."
        check_config
        ssh ${DROPLET_USER}@${DROPLET_IP} "systemctl start today-scheduler"
        print_status "Scheduler started"
        ;;
        
    exec)
        if [ -z "$2" ]; then
            print_error "Usage: bin/deploy-do exec 'command'"
            exit 1
        fi
        check_config
        shift
        echo "‚ö° Executing: $*"
        ssh ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && $*"
        ;;
        
    *)
        echo "Usage: bin/deploy-do [command]"
        echo ""
        echo "Commands:"
        echo "  setup    - Initial droplet setup (run once)"
        echo "  deploy   - Deploy code to droplet (default)"
        echo "  secrets  - Update .env files"
        echo "  ssh      - SSH into droplet"
        echo "  logs     - Show scheduler logs"
        echo "  status   - Show scheduler status"
        echo "  restart  - Restart scheduler"
        echo "  stop     - Stop scheduler"
        echo "  start    - Start scheduler"
        echo "  exec CMD - Execute command in deploy directory"
        echo ""
        echo "First time setup:"
        echo "  1. Create a DigitalOcean droplet (Ubuntu 24.04)"
        echo "  2. export DO_DROPLET_IP=your.droplet.ip"
        echo "  3. bin/deploy-do setup"
        echo "  4. bin/deploy-do secrets"
        echo "  5. bin/deploy-do deploy"
        ;;
esac