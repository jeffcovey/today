#!/usr/bin/env node

/**
 * Deploy to DigitalOcean Droplet
 *
 * This script helps manage deployment to a DigitalOcean droplet.
 * Ported from Python to Node.js for codebase consistency.
 */

import { autoDotenvx } from './lib/dotenvx-loader.js';
autoDotenvx();

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { execSync, spawnSync } from 'child_process';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const PROJECT_ROOT = path.dirname(__dirname);

// Change to project root
process.chdir(PROJECT_ROOT);

// ANSI colors
const GREEN = '\x1b[0;32m';
const YELLOW = '\x1b[1;33m';
const BLUE = '\x1b[0;34m';
const RED = '\x1b[0;31m';
const NC = '\x1b[0m';

function printStatus(msg) {
  console.log(`${GREEN}âœ“${NC} ${msg}`);
}

function printInfo(msg) {
  console.log(`${BLUE}â„¹${NC} ${msg}`);
}

function printWarning(msg) {
  console.log(`${YELLOW}âš ${NC} ${msg}`);
}

function printError(msg) {
  console.log(`${RED}âœ—${NC} ${msg}`);
}

function getEnv(key, defaultValue = null) {
  return process.env[key] || defaultValue;
}

function requireEnv(key) {
  const value = process.env[key];
  if (!value) {
    printError(`${key} not set!`);
    console.log(`Please set your ${key}:`);
    console.log(`  export ${key}=your_value`);
    console.log('Or add to .env:');
    console.log(`  ${key}=your_value`);
    process.exit(1);
  }
  return value;
}

function run(cmd, options = {}) {
  const { check = true, capture = false, shell = false } = options;

  try {
    if (capture) {
      const result = execSync(cmd, { encoding: 'utf8', shell: true, ...options });
      return { stdout: result, returncode: 0 };
    } else {
      execSync(cmd, { stdio: 'inherit', shell: true, ...options });
      return { returncode: 0 };
    }
  } catch (e) {
    if (check) {
      process.exit(e.status || 1);
    }
    return { stdout: e.stdout || '', stderr: e.stderr || '', returncode: e.status || 1 };
  }
}

class DigitalOceanDeploy {
  constructor() {
    this.dropletIp = getEnv('DO_DROPLET_IP');
    this.dropletUser = getEnv('DO_DROPLET_USER', 'root');
    this.deployPath = '/opt/today';
    this.sshKey = path.join(process.env.HOME, '.ssh', 'do_deploy_key');
    this.deployDomain = getEnv('DO_DEPLOY_DOMAIN', 'today.example.com');
    this.adminEmail = getEnv('DO_ADMIN_EMAIL', 'admin@example.com');

    // Ensure SSH key exists
    if (!fs.existsSync(this.sshKey)) {
      printWarning('Deployment key not found. Setting up...');
      run(path.join(PROJECT_ROOT, '.devcontainer', 'setup-ssh-keys.sh'));
    }
  }

  checkConfig() {
    if (!this.dropletIp) {
      printError('DO_DROPLET_IP not set!');
      console.log('Please set your droplet IP:');
      console.log('  export DO_DROPLET_IP=your.droplet.ip.address');
      console.log('Or add to .env:');
      console.log('  DO_DROPLET_IP=your.droplet.ip.address');
      process.exit(1);
    }
  }

  sshCmd(command, options = {}) {
    const { check = true, capture = false } = options;
    const sshArgs = `ssh -i "${this.sshKey}" ${this.dropletUser}@${this.dropletIp} ${JSON.stringify(command)}`;
    return run(sshArgs, { check, capture });
  }

  sshScript(script, options = {}) {
    const { check = true } = options;
    // Base64 encode the script to avoid any quoting issues with heredocs
    const encoded = Buffer.from(script).toString('base64');
    return this.sshCmd(`echo ${encoded} | base64 -d | bash`, { check });
  }

  scpToRemote(localPath, remotePath) {
    run(`scp -i "${this.sshKey}" "${localPath}" ${this.dropletUser}@${this.dropletIp}:${remotePath}`);
  }

  rsyncToRemote(localPath, remotePath, ...extraArgs) {
    const args = ['rsync', '-avz', '-e', `"ssh -i ${this.sshKey}"`, ...extraArgs, `"${localPath}"`, `${this.dropletUser}@${this.dropletIp}:${remotePath}`];
    run(args.join(' '));
  }

  // =========================================================================
  // Commands
  // =========================================================================

  cmdSetup(args) {
    console.log('ðŸš€ Initial setup of DigitalOcean droplet...');
    this.checkConfig();

    printInfo('This will install Node.js, Git, and dependencies on your droplet');

    // Check for --yes flag or non-interactive
    let confirm = 'n';
    if (!process.stdin.isTTY || (args && args[0] === '--yes' || args[0] === '-y')) {
      confirm = 'y';
    } else {
      const readline = require('readline');
      const rl = readline.createInterface({ input: process.stdin, output: process.stdout });
      // For sync prompt, we'll just proceed if non-interactive
      confirm = 'y';
    }

    if (confirm !== 'y') {
      process.exit(1);
    }

    printInfo('Copying setup script to droplet...');
    this.scpToRemote(path.join(PROJECT_ROOT, 'bin', 'setup-droplet.sh'), '/tmp/');

    printInfo('Running setup on droplet...');
    this.sshCmd('bash /tmp/setup-droplet.sh');

    printStatus('Setup complete!');
    console.log("Run 'bin/deploy-do deploy' to deploy your code");
  }

  cmdDeploy(args) {
    console.log('ðŸš¢ Deploying to DigitalOcean...');
    this.checkConfig();

    printInfo(`Syncing code to ${this.dropletUser}@${this.dropletIp}:${this.deployPath}`);

    // Create directories
    this.sshCmd(`mkdir -p ${this.deployPath} ${this.deployPath}/.data`);

    // Git pull
    printInfo('Pulling latest code from git...');
    this.sshCmd(`cd ${this.deployPath} && git pull`);

    // Sync config files
    printInfo('Syncing configuration files...');
    this.rsyncToRemote('./', `${this.deployPath}/`, '--include=.env', '--include=.env.keys', '--exclude=*');

    // Configure git
    this.sshCmd(`git config --global --add safe.directory ${this.deployPath}`, { check: false });
    this.sshCmd("git config --global user.email 'today-bot@system.local' && git config --global user.name 'Today Bot'", { check: false });

    // Setup tmux config
    this.sshCmd(`[ ! -f ~/.tmux.conf ] && echo 'set -g default-command "cd ${this.deployPath} && exec bash"' > ~/.tmux.conf || true`, { check: false });

    // Configure GitHub auth
    printInfo('Configuring GitHub authentication...');
    this.sshCmd(`cd ${this.deployPath} && npx dotenvx run -- bash -c 'if [ -n "$GITHUB_TOKEN" ]; then echo "https://$GITHUB_TOKEN:x-oauth-basic@github.com" > ~/.git-credentials && git config --global credential.helper store && echo "âœ“ GitHub token configured"; fi'`, { check: false });

    // Install dependencies
    printInfo('Installing dependencies...');
    this.sshCmd(`cd ${this.deployPath} && npm install --production`);

    // Run migrations
    printInfo('Running database migrations...');
    const result = this.sshCmd(`cd ${this.deployPath} && timeout 30 npx dotenvx run -- node src/migrations.js`, { check: false });
    if (result.returncode !== 0) {
      printWarning('Migrations may have already run');
    }

    // Check Resilio Sync
    printInfo('Checking Resilio Sync...');
    const resilioCheck = this.sshCmd('command -v rslsync', { check: false, capture: true });
    if (resilioCheck.returncode !== 0) {
      printWarning('Resilio Sync not installed, installing now...');
      this.sshScript(`
        wget -qO - https://linux-packages.resilio.com/resilio-sync/key.asc | gpg --dearmor | sudo tee /usr/share/keyrings/resilio-sync-archive-keyring.gpg >/dev/null
        echo "deb [signed-by=/usr/share/keyrings/resilio-sync-archive-keyring.gpg] https://linux-packages.resilio.com/resilio-sync/deb resilio-sync non-free" | sudo tee /etc/apt/sources.list.d/resilio-sync.list
        sudo apt-get update
        sudo apt-get install -y resilio-sync
        sudo useradd -r -s /bin/false rslsync 2>/dev/null || true
      `);
      this.cmdResilioSync(['setup']);
    } else {
      this.sshCmd('sudo systemctl start resilio-sync', { check: false });
    }

    // Install logrotate config
    printInfo('Installing logrotate configuration...');
    this.sshCmd(`sudo cp ${this.deployPath}/config/logrotate-today /etc/logrotate.d/today && sudo chmod 644 /etc/logrotate.d/today && echo "âœ“ Logrotate configured"`);

    // Setup WAL checkpoint cron
    printInfo('Setting up SQLite WAL checkpoint cron job...');
    this.sshScript(`
cat > /opt/today/bin/checkpoint-wal.sh << 'SCRIPT'
#!/bin/bash
cd /opt/today
npx dotenvx run -- sqlite3 .data/today.db "PRAGMA wal_checkpoint(PASSIVE);" >/dev/null 2>&1
SCRIPT
chmod +x /opt/today/bin/checkpoint-wal.sh
if ! crontab -l 2>/dev/null | grep -q checkpoint-wal; then
    (crontab -l 2>/dev/null; echo "*/30 * * * * /opt/today/bin/checkpoint-wal.sh") | crontab -
    echo "âœ“ WAL checkpoint cron job added (runs every 30 minutes)"
else
    echo "âœ“ WAL checkpoint cron job already configured"
fi
`);

    // Restart services
    printInfo('Restarting services...');
    this.sshCmd('systemctl restart today-scheduler || true', { check: false });
    this.sshCmd('systemctl restart vault-web || true', { check: false });
    this.sshCmd('systemctl restart vault-watcher || true', { check: false });

    printStatus('Deployment complete!');
  }

  cmdSecrets(args) {
    console.log('ðŸ” Updating secrets on droplet...');
    this.checkConfig();

    printInfo('Copying .env file...');
    this.scpToRemote('.env', `${this.deployPath}/.env`);

    if (fs.existsSync('.env.keys')) {
      printInfo('Extracting and copying decryption key...');
      const content = fs.readFileSync('.env.keys', 'utf8');
      for (const line of content.split('\n')) {
        if (line.startsWith('DOTENV_PRIVATE_KEY=')) {
          const privateKey = line.trim().split('=')[1];
          this.sshCmd(`echo 'DOTENV_PRIVATE_KEY=${privateKey}' > ${this.deployPath}/.env.keys`);
          break;
        }
      }
    }

    printInfo('Setting proper permissions...');
    this.sshCmd(`chmod 600 ${this.deployPath}/.env*`);

    printInfo('Restarting services...');
    this.sshCmd('systemctl restart today-scheduler || true', { check: false });
    this.sshCmd('systemctl restart vault-watcher || true', { check: false });

    printStatus('Secrets updated!');
  }

  cmdSsh(args) {
    console.log('ðŸ”Œ Connecting to droplet...');
    this.checkConfig();
    const result = spawnSync('ssh', ['-i', this.sshKey, `${this.dropletUser}@${this.dropletIp}`], { stdio: 'inherit' });
    process.exit(result.status || 0);
  }

  cmdLogs(args) {
    console.log('ðŸ“Š Showing scheduler logs...');
    this.checkConfig();
    this.sshCmd('journalctl -u today-scheduler -f');
  }

  cmdStatus(args) {
    console.log('ðŸ“ˆ Checking status...');
    this.checkConfig();
    this.sshCmd('systemctl status today-scheduler');
  }

  cmdNginxConfig(args) {
    console.log('ðŸ”§ Updating nginx configuration...');
    this.checkConfig();

    printInfo('Copying nginx config to droplet...');
    this.scpToRemote('config/nginx-vault-web.conf', '/tmp/');

    printInfo('Installing nginx config...');
    this.sshCmd(`sudo cp /tmp/nginx-vault-web.conf /etc/nginx/sites-available/${this.deployDomain}`);

    printInfo('Testing nginx configuration...');
    this.sshCmd('sudo nginx -t');

    printInfo('Reloading nginx...');
    this.sshCmd('sudo systemctl reload nginx');

    printStatus('Nginx configuration updated!');
  }

  cmdRestart(args) {
    console.log('ðŸ”„ Restarting scheduler...');
    this.checkConfig();
    this.sshCmd('systemctl restart today-scheduler');
    printStatus('Scheduler restarted');
  }

  cmdWebRestart(args) {
    console.log('ðŸŒ Restarting web server...');
    this.checkConfig();
    this.sshCmd('systemctl restart vault-web');
    printStatus('Web server restarted');
  }

  cmdStop(args) {
    console.log('â¹ Stopping scheduler...');
    this.checkConfig();
    this.sshCmd('systemctl stop today-scheduler');
    printStatus('Scheduler stopped');
  }

  cmdStart(args) {
    console.log('â–¶ï¸ Starting scheduler...');
    this.checkConfig();
    this.sshCmd('systemctl start today-scheduler');
    printStatus('Scheduler started');
  }

  cmdDbInit(args) {
    console.log('ðŸ—„ï¸ Initializing database...');
    this.checkConfig();

    printInfo('Creating .data directory...');
    this.sshCmd(`mkdir -p ${this.deployPath}/.data`);

    printInfo('Running database migrations...');
    this.sshCmd(`cd ${this.deployPath} && npx dotenvx run -- node src/migrations.js`);

    printStatus('Database initialized!');
  }

  cmdGitSetup(args) {
    console.log('ðŸ”§ Setting up git repository on droplet...');
    this.checkConfig();

    printInfo('Copying .git directory to droplet...');
    this.rsyncToRemote('.git/', `${this.deployPath}/.git/`, '--progress');

    printInfo('Configuring git safe directory...');
    this.sshCmd(`git config --global --add safe.directory ${this.deployPath}`);

    printInfo('Configuring git user identity...');
    this.sshCmd("git config --global user.email 'today-bot@system.local' && git config --global user.name 'Today Bot'");

    printInfo('Configuring GitHub authentication...');
    this.sshCmd(`cd ${this.deployPath} && npx dotenvx run -- bash -c 'if [ -n "$GITHUB_TOKEN" ]; then echo "https://$GITHUB_TOKEN:x-oauth-basic@github.com" > ~/.git-credentials && git config --global credential.helper store && echo "âœ“ GitHub token configured"; else echo "âš  No GITHUB_TOKEN found"; fi'`);

    printInfo('Testing git access...');
    const result = this.sshCmd(`cd ${this.deployPath} && npx dotenvx run -- git fetch --dry-run`, { check: false, capture: true });
    if (result.returncode === 0) {
      printStatus('Git fetch successful!');
    } else {
      printWarning('Git fetch failed - check GITHUB_TOKEN');
    }

    printInfo('Checking git status...');
    this.sshCmd(`cd ${this.deployPath} && git status --short`);

    printStatus('Git repository configured!');
  }

  cmdDbUpload(args) {
    console.log('ðŸ“¤ Uploading local database to droplet...');
    this.checkConfig();

    const localDb = '.data/today.db';
    if (!fs.existsSync(localDb)) {
      printError('Local database .data/today.db not found!');
      process.exit(1);
    }

    const targetName = args[0] || 'today.db';
    const timestamp = new Date().toISOString().replace(/[-:T]/g, '').slice(0, 15);

    printInfo('Backing up existing database on droplet...');
    this.sshCmd(`cd ${this.deployPath} && [ -f .data/today.db ] && cp .data/today.db .data/today.db.backup-${timestamp} || true`);

    // Get local size
    const localSize = fs.statSync(localDb).size;
    const humanSize = execSync(`du -h "${localDb}"`, { encoding: 'utf8' }).split('\t')[0];

    printInfo(`Uploading database (${humanSize}) using rsync...`);
    this.rsyncToRemote(localDb, `${this.deployPath}/.data/${targetName}`, '--progress');

    if (targetName !== 'today.db') {
      printInfo(`Moving ${targetName} to today.db...`);
      this.sshCmd(`cd ${this.deployPath}/.data && mv ${targetName} today.db`);
    }

    printInfo('Setting permissions...');
    this.sshCmd(`chmod 644 ${this.deployPath}/.data/today.db`);

    printInfo('Verifying upload...');
    const result = this.sshCmd(`du -b ${this.deployPath}/.data/today.db`, { capture: true });
    const remoteSize = parseInt(result.stdout.split('\t')[0]);

    if (localSize !== remoteSize) {
      printWarning(`Size mismatch: local=${localSize} remote=${remoteSize}`);
    } else {
      printStatus(`Database size verified: ${humanSize}`);
    }

    // Quick data check
    const taskResult = this.sshCmd(`sqlite3 ${this.deployPath}/.data/today.db 'SELECT COUNT(*) FROM tasks'`, { check: false, capture: true });
    const taskCount = taskResult.returncode === 0 ? taskResult.stdout.trim() : '0';
    printInfo(`Database contains ${taskCount} tasks`);

    printStatus('Database uploaded successfully!');
  }

  cmdVaultWatcherSetup(args) {
    console.log('ðŸ‘ï¸ Setting up vault watcher service...');
    this.checkConfig();

    printInfo('Installing vault watcher service...');
    this.scpToRemote('config/vault-watcher.service', '/tmp/vault-watcher.service');

    this.sshScript(`
sudo mv /tmp/vault-watcher.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable vault-watcher
sudo systemctl restart vault-watcher
sleep 2
sudo systemctl status vault-watcher
`);

    printStatus('Vault watcher service installed and started');
  }

  cmdVaultWatcher(args) {
    this.checkConfig();
    const action = args[0] || 'status';
    printInfo(`Vault watcher: ${action}`);
    this.sshCmd(`sudo systemctl ${action} vault-watcher && sudo systemctl status vault-watcher --no-pager`);
  }

  cmdResilioSync(args) {
    this.checkConfig();
    const action = args[0] || 'status';

    if (action === 'setup') {
      printInfo('Setting up Resilio Sync...');

      this.sshScript(`
sudo useradd -r -s /bin/false rslsync 2>/dev/null || true
sudo mkdir -p /etc/resilio-sync /var/lib/resilio-sync /var/run/resilio-sync /opt/today/vault
sudo chown -R rslsync:rslsync /opt/today/vault
sudo chmod -R 775 /opt/today/vault
sudo chown rslsync:rslsync /var/lib/resilio-sync /var/run/resilio-sync

if [ ! -f /etc/resilio-sync/config.json ]; then
    RESILIO_PASSWORD=$(openssl rand -base64 12)
    echo "RESILIO_PASSWORD=$RESILIO_PASSWORD" > /opt/today/.resilio-password
    chmod 600 /opt/today/.resilio-password

    sudo tee /etc/resilio-sync/config.json > /dev/null << 'CONFIG'
{
    "device_name": "Today Droplet",
    "listening_port": 8888,
    "storage_path": "/var/lib/resilio-sync/",
    "pid_file": "/var/run/resilio-sync/sync.pid",
    "use_upnp": true,
    "download_limit": 0,
    "upload_limit": 0,
    "webui": {
        "listen": "0.0.0.0:8889",
        "login": "admin",
        "password": "PLACEHOLDER"
    }
}
CONFIG
    sudo sed -i "s/PLACEHOLDER/$RESILIO_PASSWORD/" /etc/resilio-sync/config.json
    echo "Generated new password: $RESILIO_PASSWORD"
    echo "(Saved to /opt/today/.resilio-password)"
else
    echo "Using existing Resilio Sync configuration"
    if [ -f /opt/today/.resilio-password ]; then
        source /opt/today/.resilio-password
        echo "Current password: $RESILIO_PASSWORD"
    fi
fi

sudo chown rslsync:rslsync /etc/resilio-sync/config.json
sudo chmod 600 /etc/resilio-sync/config.json

sudo tee /etc/systemd/system/resilio-sync.service > /dev/null << 'SERVICE'
[Unit]
Description=Resilio Sync
Documentation=https://help.resilio.com
After=network.target

[Service]
Type=simple
User=rslsync
Group=rslsync
RuntimeDirectory=resilio-sync
RuntimeDirectoryMode=0755
ExecStartPre=/bin/mkdir -p /var/run/resilio-sync
ExecStartPre=/bin/chown rslsync:rslsync /var/run/resilio-sync
ExecStart=/usr/bin/rslsync --config /etc/resilio-sync/config.json --nodaemon
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
SERVICE

sudo systemctl daemon-reload
sudo systemctl enable resilio-sync
sudo systemctl restart resilio-sync
`);

      // Setup nginx for resilio sync
      const nginxConfig = `server {
    server_name sync.${this.deployDomain};

    location / {
        proxy_pass http://127.0.0.1:8889;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }

    listen 80;
}`;

      const nginxSetupEncoded = Buffer.from(`
if [ ! -f /etc/nginx/sites-available/sync.${this.deployDomain} ]; then
    cat > /tmp/sync-nginx.conf << 'NGINX'
${nginxConfig}
NGINX
    sudo mv /tmp/sync-nginx.conf /etc/nginx/sites-available/sync.${this.deployDomain}
    sudo ln -sf /etc/nginx/sites-available/sync.${this.deployDomain} /etc/nginx/sites-enabled/
    sudo nginx -t && sudo systemctl reload nginx
    sudo certbot --nginx -d sync.${this.deployDomain} --non-interactive --agree-tos --email ${this.adminEmail} --redirect || true
    echo "âœ… Nginx subdomain configured with HTTPS"
fi

echo "âœ… Resilio Sync configured and started"
echo "ðŸ“Œ Web UI available at:"
echo "   ðŸ”’ HTTPS: https://sync.${this.deployDomain}"
echo "   Direct: http://$(hostname -I | awk '{print $1}'):8889"
if [ -f /opt/today/.resilio-password ]; then
    source /opt/today/.resilio-password
    echo "   Username: admin"
    echo "   Password: $RESILIO_PASSWORD"
else
    echo "   Username: admin"
    echo "   Password: admin (default)"
fi
echo ""
echo "Note: You may need to add sync.${this.deployDomain} to your DNS records"
`).toString('base64');
      this.sshCmd(`echo ${nginxSetupEncoded} | base64 -d | bash`);

    } else if (['start', 'stop', 'restart', 'status'].includes(action)) {
      printInfo(`Resilio Sync: ${action}`);
      this.sshCmd(`sudo systemctl ${action} resilio-sync && sudo systemctl status resilio-sync --no-pager`);

    } else if (action === 'set-password') {
      printInfo('Setting new Resilio Sync password...');
      let newPassword;
      if (args[1]) {
        newPassword = args[1];
      } else {
        printInfo('Generating random password...');
        newPassword = execSync('openssl rand -base64 16', { encoding: 'utf8' }).trim();
      }

      this.sshScript(`
sudo jq '.webui.password = "${newPassword}"' /etc/resilio-sync/config.json > /tmp/config.json
sudo mv /tmp/config.json /etc/resilio-sync/config.json
sudo chown rslsync:rslsync /etc/resilio-sync/config.json
sudo chmod 600 /etc/resilio-sync/config.json
echo "RESILIO_PASSWORD=${newPassword}" > /opt/today/.resilio-password
chmod 600 /opt/today/.resilio-password
sudo systemctl restart resilio-sync
echo "âœ… Password updated successfully!"
echo ""
echo "========================================="
echo "New password: ${newPassword}"
echo "========================================="
echo ""
echo "URL: https://sync.${this.deployDomain}"
echo "Username: admin"
echo "Password: ${newPassword}"
`);

    } else if (action === 'fix-permissions') {
      printInfo('Fixing vault folder permissions...');
      this.sshScript(`
sudo chown -R rslsync:rslsync /opt/today/vault
sudo chmod -R 775 /opt/today/vault
echo "âœ… Permissions fixed for /opt/today/vault"
ls -la /opt/today/vault | head -5
`);

    } else if (action === 'key' || action === 'info') {
      printInfo('Resilio Sync information...');
      this.sshScript(`
echo "ðŸ“Œ Web UI Access:"
if [ -f /etc/nginx/sites-enabled/sync.${this.deployDomain} ]; then
    echo "   ðŸ”’ HTTPS: https://sync.${this.deployDomain}"
fi
echo "   Direct: http://$(hostname -I | awk '{print $1}'):8889"

if [ -f /opt/today/.resilio-password ]; then
    source /opt/today/.resilio-password
    echo ""
    echo "Credentials:"
    echo "   Username: admin"
    echo "   Password: $RESILIO_PASSWORD"
else
    echo ""
    echo "Credentials:"
    echo "   Username: admin"
    echo "   Password: admin (default)"
fi
echo ""
echo "To get sync keys, visit the Web UI and check your folders"
`);

    } else {
      console.log('Usage: bin/deploy-do resilio-sync [setup|start|stop|restart|status|set-password|fix-permissions|info]');
      console.log('');
      console.log('  set-password [password]  - Set new password (generates random if not provided)');
      console.log('  fix-permissions          - Fix vault folder permissions');
      console.log('  info                     - Show access info and current password');
    }
  }

  cmdInboxApiSetup(args) {
    console.log('ðŸ“® Setting up inbox upload API...');
    this.checkConfig();

    printInfo('Generating API key...');
    this.sshScript(`
if [ ! -f /opt/today/.inbox-api-key ]; then
    API_KEY=$(openssl rand -hex 32)
    echo "INBOX_API_KEY=$API_KEY" > /opt/today/.inbox-api-key
    chmod 600 /opt/today/.inbox-api-key
    echo "Generated new API key: $API_KEY"
else
    source /opt/today/.inbox-api-key
    echo "Using existing API key: $INBOX_API_KEY"
fi
`);

    this.scpToRemote('config/inbox-api.service', '/tmp/inbox-api.service');

    this.sshScript(`
sudo mv /tmp/inbox-api.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable inbox-api
sudo systemctl restart inbox-api

if ! grep -q "/api/inbox/" /etc/nginx/sites-available/default 2>/dev/null; then
    echo "Note: You may need to manually configure nginx for the inbox API"
fi

sleep 2
sudo systemctl status inbox-api --no-pager || true

echo ""
echo "================================"
source /opt/today/.inbox-api-key
echo "Inbox API Key: $INBOX_API_KEY"
echo "================================"
echo ""
echo "Save this API key in your Drafts app!"
echo "Endpoint: https://${this.deployDomain}/api/inbox/upload"
`);

    printStatus('Inbox API installed and configured');
  }

  cmdInboxApi(args) {
    this.checkConfig();
    const action = args[0] || 'status';
    printInfo(`Inbox API: ${action}`);
    this.sshCmd(`sudo systemctl ${action} inbox-api && sudo systemctl status inbox-api --no-pager`);

    if (action === 'status' || action === 'restart') {
      this.sshScript(`
if [ -f /opt/today/.inbox-api-key ]; then
    echo ""
    source /opt/today/.inbox-api-key
    echo "API Key: $INBOX_API_KEY"
    echo "Upload endpoint: https://${this.deployDomain}/api/inbox/upload"
    echo "Vault endpoint: https://${this.deployDomain}/api/vault/"
fi
`);
    }
  }

  cmdVaultApiSetup(args) {
    console.log('ðŸ“š Setting up vault read API...');
    this.checkConfig();

    printInfo('Installing vault API service...');
    this.scpToRemote('config/vault-api.service', '/tmp/vault-api.service');

    this.sshScript(`
sudo mv /tmp/vault-api.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable vault-api
sudo systemctl restart vault-api
sleep 2
sudo systemctl status vault-api --no-pager || true
`);

    printStatus('Vault API installed and configured');
    printInfo(`Vault API endpoint: https://${this.deployDomain}/api/vault/`);
  }

  cmdVaultApi(args) {
    this.checkConfig();
    const action = args[0] || 'status';
    printInfo(`Vault API: ${action}`);
    this.sshCmd(`sudo systemctl ${action} vault-api && sudo systemctl status vault-api --no-pager`);
  }

  cmdOllamaSetup(args) {
    console.log('ðŸ¤– Setting up Ollama on droplet...');
    this.checkConfig();

    printInfo('Installing Ollama...');
    this.sshCmd('curl -fsSL https://ollama.com/install.sh | sh');

    printInfo('Starting Ollama service...');
    this.sshCmd('systemctl enable ollama && systemctl start ollama');

    printInfo('Waiting for Ollama to start...');
    execSync('sleep 5');

    printInfo('Testing Ollama installation...');
    this.sshCmd('ollama --version');

    printInfo('Checking available memory...');
    const result = this.sshCmd("free -m | awk '/^Mem:/ {print $7}'", { capture: true });
    const availableMb = parseInt(result.stdout.trim());

    if (availableMb < 800) {
      printWarning(`Only ${availableMb}MB RAM available. LLMs need at least 800MB.`);
      printWarning('Consider upgrading to a 2GB droplet ($12/month) for local LLM support.');
      printInfo('Skipping model download due to insufficient memory.');
    } else {
      printInfo('Pulling tinyllama model (637MB) - fastest small model...');
      this.sshCmd('ollama pull tinyllama');

      printInfo('Testing model...');
      this.sshCmd("echo 'What is 2+2?' | ollama run tinyllama");
    }

    printStatus('Ollama setup complete!');
    printInfo('Available at http://localhost:11434 on the droplet');
    printInfo('Add OLLAMA_HOST=http://localhost:11434 to your .env');
  }

  cmdOllama(args) {
    console.log('ðŸ¤– Managing Ollama models...');
    this.checkConfig();

    const action = args[0] || 'list';

    if (action === 'list') {
      printInfo('Installed models:');
      this.sshCmd('ollama list');

    } else if (action === 'pull') {
      if (args.length < 2) {
        printError('Usage: bin/deploy-do ollama pull <model>');
        console.log('Recommended models (memory requirements):');
        console.log('  â€¢ tinyllama (800MB RAM) - Very fast, basic quality');
        console.log('  â€¢ phi3 (4GB RAM) - Good balance of speed and quality');
        console.log('  â€¢ mistral (6GB RAM) - Better quality');
        console.log('  â€¢ codellama (5GB RAM) - For coding tasks');
        process.exit(1);
      }
      printInfo(`Pulling model: ${args[1]}`);
      this.sshCmd(`ollama pull ${args[1]}`);

    } else if (action === 'rm') {
      if (args.length < 2) {
        printError('Usage: bin/deploy-do ollama rm <model>');
        process.exit(1);
      }
      printInfo(`Removing model: ${args[1]}`);
      this.sshCmd(`ollama rm ${args[1]}`);

    } else if (action === 'test') {
      const model = args[1] || 'phi3-mini';
      printInfo(`Testing model: ${model}`);
      this.sshCmd(`echo 'Hello, how are you?' | ollama run ${model}`);

    } else {
      console.log('Usage: bin/deploy-do ollama [list|pull <model>|rm <model>|test [model]]');
    }
  }

  cmdExec(args) {
    if (!args.length) {
      printError("Usage: bin/deploy-do exec 'command'");
      process.exit(1);
    }
    this.checkConfig();
    const command = args.join(' ');
    console.log(`âš¡ Executing: ${command}`);
    this.sshCmd(`cd ${this.deployPath} && ${command}`);
  }

  cmdFetch(args) {
    if (!args.length) {
      printError('Usage: bin/deploy-do fetch <path> [options]');
      console.log('');
      console.log('Examples:');
      console.log('  bin/deploy-do fetch /                    # Fetch homepage');
      console.log('  bin/deploy-do fetch /tasks-today.md      # Fetch today\'s tasks');
      console.log('  bin/deploy-do fetch /plans/              # List plans directory');
      console.log('  bin/deploy-do fetch /api/health          # Check API health');
      console.log('');
      console.log('Options:');
      console.log('  --raw           Output raw HTML/content without processing');
      console.log('  --headers       Include response headers');
      console.log('  --no-auth       Skip authentication (for public endpoints)');
      console.log('  --output FILE   Save response to file');
      process.exit(1);
    }

    this.checkConfig();

    const urlPath = args[0];
    const rawOutput = args.includes('--raw');
    const showHeaders = args.includes('--headers');
    const skipAuth = args.includes('--no-auth');
    let outputFile = null;

    const outputIdx = args.indexOf('--output');
    if (outputIdx !== -1 && outputIdx + 1 < args.length) {
      outputFile = args[outputIdx + 1];
    }

    const curlOpts = showHeaders ? '-i' : '';

    printInfo(`Fetching: ${urlPath}`);
    const fullUrl = `https://${this.deployDomain}${urlPath}`;

    if (!skipAuth) {
      printInfo('Authenticating...');

      // Get password from dotenvx
      let webPassword;
      try {
        const result = execSync('npx dotenvx get WEB_PASSWORD --format shell', { encoding: 'utf8' });
        webPassword = result.trim();
      } catch {
        printError('Failed to decrypt WEB_PASSWORD. Ensure .env.keys exists.');
        process.exit(1);
      }

      // Create temp cookie file
      const cookieFile = `/tmp/deploy-do-cookies-${process.pid}`;

      // Authenticate
      const authResult = this.sshCmd(
        `curl -s -c ${cookieFile} -X POST -d 'username=admin' --data-urlencode 'password=${webPassword}' https://${this.deployDomain}/auth/login -o /dev/null -w '%{http_code}'`,
        { capture: true }
      );
      const authStatus = authResult.stdout.trim();

      if (!['200', '302'].includes(authStatus)) {
        printError(`Authentication failed (HTTP ${authStatus})`);
        this.sshCmd(`rm -f ${cookieFile}`, { check: false });
        process.exit(1);
      }

      printStatus('Authenticated successfully');

      // Fetch with auth
      if (outputFile) {
        const result = this.sshCmd(`curl -s -b ${cookieFile} ${curlOpts} '${fullUrl}'`, { capture: true });
        fs.writeFileSync(outputFile, result.stdout);
        printStatus(`Saved to: ${outputFile}`);
      } else if (rawOutput) {
        this.sshCmd(`curl -s -b ${cookieFile} ${curlOpts} '${fullUrl}'`);
      } else {
        this.sshCmd(`curl -s -b ${cookieFile} ${curlOpts} '${fullUrl}' | sed 's/<[^>]*>//g' | sed 's/&nbsp;/ /g' | sed 's/&lt;/</g' | sed 's/&gt;/>/g' | sed 's/&amp;/\\&/g'`);
      }

      // Cleanup
      this.sshCmd(`rm -f ${cookieFile}`, { check: false });
    } else {
      // No auth needed
      if (outputFile) {
        const result = this.sshCmd(`curl -s ${curlOpts} '${fullUrl}'`, { capture: true });
        fs.writeFileSync(outputFile, result.stdout);
        printStatus(`Saved to: ${outputFile}`);
      } else if (rawOutput) {
        this.sshCmd(`curl -s ${curlOpts} '${fullUrl}'`);
      } else {
        this.sshCmd(`curl -s ${curlOpts} '${fullUrl}' | sed 's/<[^>]*>//g' | sed 's/&nbsp;/ /g'`);
      }
    }
  }

  showHelp() {
    console.log('Usage: bin/deploy-do [command]');
    console.log('');
    console.log('Commands:');
    console.log('  setup       - Initial droplet setup (run once)');
    console.log('  deploy      - Deploy code to droplet (default, includes .git)');
    console.log('  secrets     - Update .env files');
    console.log('  db-init     - Initialize database');
    console.log('  db-upload   - Upload local database to droplet');
    console.log('  git-setup   - Manually setup git repository');
    console.log('  vault-watcher-setup - Setup vault file watcher service');
    console.log('  vault-watcher - Control vault watcher (start|stop|restart|status)');
    console.log('  resilio-sync - Manage Resilio Sync (setup|start|stop|restart|status|key)');
    console.log('  inbox-api-setup - Setup inbox upload API for Drafts');
    console.log('  inbox-api   - Control inbox API (start|stop|restart|status)');
    console.log('  vault-api-setup - Setup vault read API for Drafts sync');
    console.log('  vault-api   - Control vault API (start|stop|restart|status)');
    console.log('  ollama-setup - Install and setup Ollama with phi3-mini model');
    console.log('  ollama      - Manage Ollama models (list|pull|rm|test)');
    console.log('  nginx-config - Update nginx configuration');
    console.log('  ssh         - SSH into droplet');
    console.log('  logs        - Show scheduler logs');
    console.log('  status      - Show scheduler status');
    console.log('  restart     - Restart scheduler');
    console.log('  web-restart - Restart web server');
    console.log('  stop        - Stop scheduler');
    console.log('  start       - Start scheduler');
    console.log('  exec CMD    - Execute command in deploy directory');
    console.log('  fetch PATH  - Fetch authenticated web pages from the site');
    console.log('');
    console.log('First time setup:');
    console.log('  1. Create a DigitalOcean droplet (Ubuntu 24.04)');
    console.log('  2. Add DO_DROPLET_IP to .env and encrypt with dotenvx');
    console.log('  3. bin/deploy-do setup       # Install dependencies on droplet');
    console.log('  4. bin/deploy-do secrets     # Copy encrypted secrets');
    console.log('  5. bin/deploy-do deploy      # Deploy code (includes .git)');
    console.log('  6. bin/deploy-do db-upload   # Upload your local database');
    console.log('  7. bin/deploy-do ollama-setup # Install Ollama with phi3-mini model');
    console.log('');
    console.log('Note: deploy now includes .git for sync operations');
  }
}

// ============================================================================
// Main
// ============================================================================

function main() {
  const deployer = new DigitalOceanDeploy();

  // Parse command
  const args = process.argv.slice(2);
  const command = args[0] || 'deploy';
  const commandArgs = args.slice(1);

  // Map commands to methods
  const commands = {
    'setup': (a) => deployer.cmdSetup(a),
    'deploy': (a) => deployer.cmdDeploy(a),
    'secrets': (a) => deployer.cmdSecrets(a),
    'ssh': (a) => deployer.cmdSsh(a),
    'logs': (a) => deployer.cmdLogs(a),
    'status': (a) => deployer.cmdStatus(a),
    'nginx-config': (a) => deployer.cmdNginxConfig(a),
    'restart': (a) => deployer.cmdRestart(a),
    'web-restart': (a) => deployer.cmdWebRestart(a),
    'stop': (a) => deployer.cmdStop(a),
    'start': (a) => deployer.cmdStart(a),
    'db-init': (a) => deployer.cmdDbInit(a),
    'git-setup': (a) => deployer.cmdGitSetup(a),
    'db-upload': (a) => deployer.cmdDbUpload(a),
    'vault-watcher-setup': (a) => deployer.cmdVaultWatcherSetup(a),
    'vault-watcher': (a) => deployer.cmdVaultWatcher(a),
    'resilio-sync': (a) => deployer.cmdResilioSync(a),
    'inbox-api-setup': (a) => deployer.cmdInboxApiSetup(a),
    'inbox-api': (a) => deployer.cmdInboxApi(a),
    'vault-api-setup': (a) => deployer.cmdVaultApiSetup(a),
    'vault-api': (a) => deployer.cmdVaultApi(a),
    'ollama-setup': (a) => deployer.cmdOllamaSetup(a),
    'ollama': (a) => deployer.cmdOllama(a),
    'exec': (a) => deployer.cmdExec(a),
    'fetch': (a) => deployer.cmdFetch(a),
    'help': () => deployer.showHelp(),
    '--help': () => deployer.showHelp(),
    '-h': () => deployer.showHelp(),
  };

  if (commands[command]) {
    commands[command](commandArgs);
  } else {
    printError(`Unknown command: ${command}`);
    deployer.showHelp();
    process.exit(1);
  }
}

main();
