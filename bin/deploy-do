#!/bin/bash
# Deploy to DigitalOcean Droplet
# This script helps manage deployment to a DigitalOcean droplet

set -e

# If we're not already running under dotenvx, wrap ourselves
if [ -z "$DOTENVX_INJECTED" ]; then
    export DOTENVX_INJECTED=1
    exec npx dotenvx run -- "$0" "$@"
fi

# Configuration
DROPLET_IP="${DO_DROPLET_IP:-}"
DROPLET_USER="${DO_DROPLET_USER:-root}"
DEPLOY_PATH="/opt/today"
SSH_KEY="${HOME}/.ssh/do_deploy_key"

# Check if deployment key exists
if [ ! -f "$SSH_KEY" ]; then
    echo "‚ö†Ô∏è  Deployment key not found. Setting up..."
    .devcontainer/setup-ssh-keys.sh
fi

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

print_status() { echo -e "${GREEN}‚úì${NC} $1"; }
print_info() { echo -e "${BLUE}‚Ñπ${NC} $1"; }
print_warning() { echo -e "${YELLOW}‚ö†${NC} $1"; }
print_error() { echo -e "${RED}‚úó${NC} $1"; }

# Check if IP is configured
check_config() {
    if [ -z "$DROPLET_IP" ]; then
        print_error "DROPLET_IP not set!"
        echo "Please set your droplet IP:"
        echo "  export DO_DROPLET_IP=your.droplet.ip.address"
        echo "Or add to .env:"
        echo "  DO_DROPLET_IP=your.droplet.ip.address"
        exit 1
    fi
}

# Parse arguments
ACTION="${1:-deploy}"

case "$ACTION" in
    setup)
        echo "üöÄ Initial setup of DigitalOcean droplet..."
        check_config
        
        print_info "This will install Node.js, Git, and dependencies on your droplet"
        # Check if running non-interactively or with --yes flag
        if [ ! -t 0 ] || [ "$2" = "--yes" ] || [ "$2" = "-y" ]; then
            REPLY="y"
        else
            read -p "Continue? (y/n) " -n 1 -r
            echo
        fi
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
        
        print_info "Copying setup script to droplet..."
        scp -i "$SSH_KEY" bin/setup-droplet.sh ${DROPLET_USER}@${DROPLET_IP}:/tmp/
        
        print_info "Running setup on droplet..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "bash /tmp/setup-droplet.sh"
        
        print_status "Setup complete!"
        echo "Run 'bin/deploy-do deploy' to deploy your code"
        ;;
        
    deploy)
        echo "üö¢ Deploying to DigitalOcean..."
        check_config
        
        print_info "Syncing code to ${DROPLET_USER}@${DROPLET_IP}:${DEPLOY_PATH}"
        
        # Create deployment and data directories if they don't exist
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "mkdir -p ${DEPLOY_PATH} ${DEPLOY_PATH}/.data"
        
        # Use git pull for code updates (much faster than rsync)
        print_info "Pulling latest code from git..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && git pull"
        
        # Only sync essential files that aren't in git (like .env)
        print_info "Syncing configuration files..."
        rsync -avz -e "ssh -i $SSH_KEY" \
            --include='.env' \
            --include='.env.keys' \
            --exclude='*' \
            ./ ${DROPLET_USER}@${DROPLET_IP}:${DEPLOY_PATH}/
        
        # Ensure git is configured properly on droplet
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "git config --global --add safe.directory ${DEPLOY_PATH}" 2>/dev/null || true
        
        # Configure git user identity for commits
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "git config --global user.email 'today-bot@system.local' && git config --global user.name 'Today Bot'" 2>/dev/null || true
        
        # Setup tmux config if not exists
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "[ ! -f ~/.tmux.conf ] && echo 'set -g default-command \"cd /opt/today && exec bash\"' > ~/.tmux.conf || true" 2>/dev/null || true
        
        # Configure git to use GitHub token for authentication (if available)
        print_info "Configuring GitHub authentication..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && npx dotenvx run -- bash -c 'if [ -n \"\$GITHUB_TOKEN\" ]; then echo \"https://\${GITHUB_TOKEN}:x-oauth-basic@github.com\" > ~/.git-credentials && git config --global credential.helper store && echo \"‚úì GitHub token configured\"; fi'" 2>/dev/null || true
        
        print_info "Installing dependencies..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && npm install --production"
        
        # Only initialize database if it doesn't exist
        if ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "[ ! -f ${DEPLOY_PATH}/.data/today.db ]"; then
            print_info "First deployment - initializing database..."
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && timeout 30 npx dotenvx run -- node src/migrations.js"
            
            print_info "Pulling all data from Turso (this may take a while)..."
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && rm -f .data/turso-sync.json && npx dotenvx run -- bin/turso-sync pull --full" || print_warning "Full pull may have been interrupted"
        else
            print_info "Database exists, running migrations..."
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && timeout 30 npx dotenvx run -- node src/migrations.js" || print_warning "Migrations may have already run"
        fi
        
        
        # Ensure Resilio Sync is installed and running
        print_info "Checking Resilio Sync..."
        if ! ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "command -v rslsync >/dev/null 2>&1"; then
            print_warning "Resilio Sync not installed, installing now..."
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << 'EOF'
                # Add repository key
                wget -qO - https://linux-packages.resilio.com/resilio-sync/key.asc | gpg --dearmor | sudo tee /usr/share/keyrings/resilio-sync-archive-keyring.gpg >/dev/null
                # Add repository
                echo "deb [signed-by=/usr/share/keyrings/resilio-sync-archive-keyring.gpg] https://linux-packages.resilio.com/resilio-sync/deb resilio-sync non-free" | sudo tee /etc/apt/sources.list.d/resilio-sync.list
                # Update and install
                sudo apt-get update
                sudo apt-get install -y resilio-sync
                # Create sync user
                sudo useradd -r -s /bin/false rslsync 2>/dev/null || true
EOF
            # Run the setup
            $0 resilio-sync setup
        else
            # Just ensure the service is running
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sudo systemctl start resilio-sync 2>/dev/null || true"
        fi
        
        # Install logrotate config if it exists
        if [ -f "config/logrotate-today" ]; then
            print_info "Installing logrotate configuration..."
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "[ -f ${DEPLOY_PATH}/config/logrotate-today ] && sudo cp ${DEPLOY_PATH}/config/logrotate-today /etc/logrotate.d/today && sudo chmod 644 /etc/logrotate.d/today && echo '‚úì Logrotate configured' || true"
        fi

        print_info "Restarting services..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl restart today-scheduler || true"
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl restart vault-web || true"
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl restart vault-watcher || true"

        print_status "Deployment complete!"
        ;;
        
    secrets)
        echo "üîê Updating secrets on droplet..."
        check_config
        
        print_info "Copying .env file..."
        scp -i "$SSH_KEY" .env ${DROPLET_USER}@${DROPLET_IP}:${DEPLOY_PATH}/.env
        
        if [ -f .env.keys ]; then
            print_info "Extracting and copying decryption key..."
            # Extract just the key value, not the whole file
            PRIVATE_KEY=$(grep '^DOTENV_PRIVATE_KEY=' .env.keys | cut -d= -f2)
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "echo 'DOTENV_PRIVATE_KEY=${PRIVATE_KEY}' > ${DEPLOY_PATH}/.env.keys"
        fi
        
        print_info "Setting proper permissions..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "chmod 600 ${DEPLOY_PATH}/.env*"
        
        print_info "Restarting services..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl restart today-scheduler || true"
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl restart vault-watcher || true"
        
        print_status "Secrets updated!"
        ;;
        
    ssh)
        echo "üîå Connecting to droplet..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP}
        ;;
        
    logs)
        echo "üìä Showing scheduler logs..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "journalctl -u today-scheduler -f"
        ;;
        
    status)
        echo "üìà Checking status..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl status today-scheduler"
        ;;
        
    nginx-config)
        echo "üîß Updating nginx configuration..."
        check_config
        
        print_info "Copying nginx config to droplet..."
        scp -i "$SSH_KEY" config/nginx-vault-web-fixed.conf ${DROPLET_USER}@${DROPLET_IP}:/tmp/
        
        print_info "Installing nginx config..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sudo cp /tmp/nginx-vault-web-fixed.conf /etc/nginx/sites-available/today.jeffcovey.net"
        
        print_info "Testing nginx configuration..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sudo nginx -t"
        
        print_info "Reloading nginx..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sudo systemctl reload nginx"
        
        print_status "Nginx configuration updated!"
        ;;
        
    restart)
        echo "üîÑ Restarting scheduler..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl restart today-scheduler"
        print_status "Scheduler restarted"
        ;;
        
    web-restart)
        echo "üåê Restarting web server..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl restart vault-web"
        print_status "Web server restarted"
        ;;
        
    stop)
        echo "‚èπ Stopping scheduler..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl stop today-scheduler"
        print_status "Scheduler stopped"
        ;;
        
    start)
        echo "‚ñ∂Ô∏è Starting scheduler..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl start today-scheduler"
        print_status "Scheduler started"
        ;;
        
    db-init)
        echo "üóÑÔ∏è Initializing database..."
        check_config
        print_info "Creating .data directory..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "mkdir -p ${DEPLOY_PATH}/.data"
        
        print_info "Running database migrations..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && npx dotenvx run -- node src/migrations.js"
        
        print_status "Database initialized!"
        ;;
        
    git-setup)
        echo "üîß Setting up git repository on droplet..."
        check_config
        
        print_info "Copying .git directory to droplet..."
        rsync -avzh --progress -e "ssh -i $SSH_KEY" \
            .git/ ${DROPLET_USER}@${DROPLET_IP}:${DEPLOY_PATH}/.git/
        
        print_info "Configuring git safe directory..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "git config --global --add safe.directory ${DEPLOY_PATH}"
        
        print_info "Configuring git user identity..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "git config --global user.email 'today-bot@system.local' && git config --global user.name 'Today Bot'"
        
        print_info "Configuring GitHub authentication..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && npx dotenvx run -- bash -c 'if [ -n \"\$GITHUB_TOKEN\" ]; then echo \"https://\${GITHUB_TOKEN}:x-oauth-basic@github.com\" > ~/.git-credentials && git config --global credential.helper store && echo \"‚úì GitHub token configured\"; else echo \"‚ö† No GITHUB_TOKEN found\"; fi'"
        
        print_info "Testing git access..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && npx dotenvx run -- git fetch --dry-run" 2>/dev/null && print_status "Git fetch successful!" || print_warning "Git fetch failed - check GITHUB_TOKEN"
        
        print_info "Checking git status..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && git status --short"
        
        print_status "Git repository configured!"
        ;;
        
    db-upload)
        echo "üì§ Uploading local database to droplet..."
        check_config
        
        if [ ! -f ".data/today.db" ]; then
            print_error "Local database .data/today.db not found!"
            exit 1
        fi
        
        # Allow custom target name (e.g., today.db.macbook)
        TARGET_NAME="${2:-today.db}"
        
        print_info "Backing up existing database on droplet..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && [ -f .data/today.db ] && cp .data/today.db .data/today.db.backup-$(date +%Y%m%d-%H%M%S) || true"
        
        print_info "Uploading database ($(du -h .data/today.db | cut -f1)) using rsync..."
        # Using -avzh as you confirmed works (z for compression, h for human-readable)
        rsync -avzh --progress -e "ssh -i $SSH_KEY" \
            .data/today.db ${DROPLET_USER}@${DROPLET_IP}:${DEPLOY_PATH}/.data/${TARGET_NAME}
        
        # If uploaded with different name, move to today.db
        if [ "$TARGET_NAME" != "today.db" ]; then
            print_info "Moving ${TARGET_NAME} to today.db..."
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH}/.data && mv ${TARGET_NAME} today.db"
        fi
        
        print_info "Setting permissions..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "chmod 644 ${DEPLOY_PATH}/.data/today.db"
        
        print_info "Verifying upload..."
        LOCAL_SIZE=$(du -b .data/today.db | cut -f1)
        REMOTE_SIZE=$(ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "du -b ${DEPLOY_PATH}/.data/today.db | cut -f1")
        if [ "$LOCAL_SIZE" != "$REMOTE_SIZE" ]; then
            print_warning "Size mismatch: local=$LOCAL_SIZE remote=$REMOTE_SIZE"
        else
            print_status "Database size verified: $(du -h .data/today.db | cut -f1)"
        fi
        
        # Quick data check
        TASK_COUNT=$(ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sqlite3 ${DEPLOY_PATH}/.data/today.db 'SELECT COUNT(*) FROM tasks' 2>/dev/null || echo 0")
        print_info "Database contains $TASK_COUNT tasks"
        
        print_status "Database uploaded successfully!"
        ;;
        
    vault-watcher-setup)
        echo "üëÅÔ∏è Setting up vault watcher service..."
        check_config
        
        print_info "Installing vault watcher service..."
        
        # Copy service file
        scp -i "$SSH_KEY" config/vault-watcher.service ${DROPLET_USER}@${DROPLET_IP}:/tmp/vault-watcher.service
        
        # Install and enable service
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << 'EOF'
            sudo mv /tmp/vault-watcher.service /etc/systemd/system/
            sudo systemctl daemon-reload
            sudo systemctl enable vault-watcher
            sudo systemctl restart vault-watcher
            sleep 2
            sudo systemctl status vault-watcher
EOF
        print_status "Vault watcher service installed and started"
        ;;
    
    vault-watcher)
        # Control vault watcher on droplet
        check_config
        ACTION="${2:-status}"
        print_info "Vault watcher: $ACTION"
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sudo systemctl $ACTION vault-watcher && sudo systemctl status vault-watcher --no-pager"
        ;;
    
    resilio-sync)
        # Manage Resilio Sync for vault synchronization
        check_config
        ACTION="${2:-status}"
        
        case "$ACTION" in
            setup)
                print_info "Setting up Resilio Sync..."
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << 'EOF'
                    # Ensure user exists
                    sudo useradd -r -s /bin/false rslsync 2>/dev/null || true
                    
                    # Create required directories
                    sudo mkdir -p /etc/resilio-sync
                    sudo mkdir -p /var/lib/resilio-sync
                    sudo mkdir -p /var/run/resilio-sync
                    sudo mkdir -p /opt/today/vault
                    
                    # IMPORTANT: Fix vault permissions - rslsync needs write access
                    sudo chown -R rslsync:rslsync /opt/today/vault
                    sudo chmod -R 775 /opt/today/vault
                    
                    # Set permissions for other directories
                    sudo chown rslsync:rslsync /var/lib/resilio-sync
                    sudo chown rslsync:rslsync /var/run/resilio-sync
                    
                    # Only create config if it doesn't exist (preserve existing config)
                    if [ ! -f /etc/resilio-sync/config.json ]; then
                        # Generate a random password if this is first setup
                        RESILIO_PASSWORD=$(openssl rand -base64 12)
                        echo "RESILIO_PASSWORD=$RESILIO_PASSWORD" > /opt/today/.resilio-password
                        chmod 600 /opt/today/.resilio-password
                        
                        sudo tee /etc/resilio-sync/config.json > /dev/null << CONFIG
{
    "device_name": "Today Droplet",
    "listening_port": 8888,
    "storage_path": "/var/lib/resilio-sync/",
    "pid_file": "/var/run/resilio-sync/sync.pid",
    "use_upnp": true,
    "download_limit": 0,
    "upload_limit": 0,
    "webui": {
        "listen": "0.0.0.0:8889",
        "login": "admin",
        "password": "$RESILIO_PASSWORD"
    }
}
CONFIG
                        echo "Generated new password: $RESILIO_PASSWORD"
                        echo "(Saved to /opt/today/.resilio-password)"
                    else
                        echo "Using existing Resilio Sync configuration"
                        if [ -f /opt/today/.resilio-password ]; then
                            source /opt/today/.resilio-password
                            echo "Current password: $RESILIO_PASSWORD"
                        fi
                    fi
                    
                    # Ensure config has correct permissions
                    sudo chown rslsync:rslsync /etc/resilio-sync/config.json
                    sudo chmod 600 /etc/resilio-sync/config.json
                    
                    # Create systemd service with RuntimeDirectory
                    sudo tee /etc/systemd/system/resilio-sync.service > /dev/null << 'SERVICE'
[Unit]
Description=Resilio Sync
Documentation=https://help.resilio.com
After=network.target

[Service]
Type=simple
User=rslsync
Group=rslsync
RuntimeDirectory=resilio-sync
RuntimeDirectoryMode=0755
ExecStartPre=/bin/mkdir -p /var/run/resilio-sync
ExecStartPre=/bin/chown rslsync:rslsync /var/run/resilio-sync
ExecStart=/usr/bin/rslsync --config /etc/resilio-sync/config.json --nodaemon
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
SERVICE
                    
                    # Start service
                    sudo systemctl daemon-reload
                    sudo systemctl enable resilio-sync
                    sudo systemctl restart resilio-sync
                    
                    # Setup nginx subdomain for Resilio Sync
                    if [ ! -f /etc/nginx/sites-available/sync.today.jeffcovey.net ]; then
                        sudo tee /etc/nginx/sites-available/sync.today.jeffcovey.net > /dev/null << 'NGINX'
server {
    server_name sync.today.jeffcovey.net;
    
    location / {
        proxy_pass http://127.0.0.1:8889;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket support for Resilio Sync
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }

    listen 80;
}
NGINX
                        sudo ln -sf /etc/nginx/sites-available/sync.today.jeffcovey.net /etc/nginx/sites-enabled/
                        sudo nginx -t && sudo systemctl reload nginx
                        
                        # Setup SSL with certbot
                        sudo certbot --nginx -d sync.today.jeffcovey.net --non-interactive --agree-tos --email admin@jeffcovey.net --redirect
                        
                        echo "‚úÖ Nginx subdomain configured with HTTPS"
                    fi
                    
                    echo "‚úÖ Resilio Sync configured and started"
                    echo "üìå Web UI available at:"
                    echo "   üîí HTTPS: https://sync.today.jeffcovey.net"
                    echo "   Direct: http://$(hostname -I | awk '{print $1}'):8889"
                    if [ -f /opt/today/.resilio-password ]; then
                        source /opt/today/.resilio-password
                        echo "   Username: admin"
                        echo "   Password: $RESILIO_PASSWORD"
                    else
                        echo "   Username: admin"
                        echo "   Password: admin (default)"
                    fi
                    echo ""
                    echo "Note: You may need to add sync.today.jeffcovey.net to your DNS records"
                    echo "Point it to the same IP as today.jeffcovey.net (167.71.106.64)"
EOF
                ;;
            
            start|stop|restart|status)
                print_info "Resilio Sync: $ACTION"
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sudo systemctl $ACTION resilio-sync && sudo systemctl status resilio-sync --no-pager"
                ;;
            
            set-password)
                print_info "Setting new Resilio Sync password..."
                # If no password provided, generate a random one
                if [ -z "$3" ]; then
                    print_info "Generating random password..."
                    NEW_PASSWORD=$(openssl rand -base64 16)
                else
                    NEW_PASSWORD="$3"
                fi
                
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << EOF
                    # Update the password in config
                    sudo jq '.webui.password = "$NEW_PASSWORD"' /etc/resilio-sync/config.json > /tmp/config.json
                    sudo mv /tmp/config.json /etc/resilio-sync/config.json
                    sudo chown rslsync:rslsync /etc/resilio-sync/config.json
                    sudo chmod 600 /etc/resilio-sync/config.json
                    
                    # Save password for reference
                    echo "RESILIO_PASSWORD=$NEW_PASSWORD" > /opt/today/.resilio-password
                    chmod 600 /opt/today/.resilio-password
                    
                    # Restart service to apply
                    sudo systemctl restart resilio-sync
                    
                    echo "‚úÖ Password updated successfully!"
                    echo ""
                    echo "========================================="
                    echo "New password: $NEW_PASSWORD"
                    echo "========================================="
                    echo ""
                    echo "URL: https://sync.today.jeffcovey.net"
                    echo "Username: admin"
                    echo "Password: $NEW_PASSWORD"
                    echo ""
                    echo "Service restarting..."
EOF
                ;;
            
            fix-permissions)
                print_info "Fixing vault folder permissions..."
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << 'EOF'
                    sudo chown -R rslsync:rslsync /opt/today/vault
                    sudo chmod -R 775 /opt/today/vault
                    echo "‚úÖ Permissions fixed for /opt/today/vault"
                    ls -la /opt/today/vault | head -5
EOF
                ;;
            
            key|info)
                print_info "Resilio Sync information..."
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << 'EOF'
                    echo "üìå Web UI Access:"
                    if [ -f /etc/nginx/sites-enabled/sync.today.jeffcovey.net ]; then
                        echo "   üîí HTTPS: https://sync.today.jeffcovey.net"
                    fi
                    echo "   Direct: http://$(hostname -I | awk '{print $1}'):8889"
                    
                    if [ -f /opt/today/.resilio-password ]; then
                        source /opt/today/.resilio-password
                        echo ""
                        echo "Credentials:"
                        echo "   Username: admin"
                        echo "   Password: $RESILIO_PASSWORD"
                    else
                        echo ""
                        echo "Credentials:"
                        echo "   Username: admin"
                        echo "   Password: admin (default)"
                    fi
                    echo ""
                    echo "To get sync keys, visit the Web UI and check your folders"
                    
                    # Check if DNS is configured
                    if ! host sync.today.jeffcovey.net >/dev/null 2>&1; then
                        echo ""
                        echo "‚ö†Ô∏è  DNS not configured yet!"
                        echo "Add an A record for sync.today.jeffcovey.net pointing to $(hostname -I | awk '{print $1}')"
                    fi
EOF
                ;;
            
            *)
                echo "Usage: bin/deploy-do resilio-sync [setup|start|stop|restart|status|set-password|fix-permissions|info]"
                echo ""
                echo "  set-password [password]  - Set new password (generates random if not provided)"
                echo "  fix-permissions          - Fix vault folder permissions"
                echo "  info                     - Show access info and current password"
                ;;
        esac
        ;;
    
    inbox-api-setup)
        echo "üìÆ Setting up inbox upload API..."
        check_config
        
        print_info "Generating API key..."
        
        # Generate a random API key if not exists
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << 'EOF'
            if [ ! -f /opt/today/.inbox-api-key ]; then
                API_KEY=$(openssl rand -hex 32)
                echo "INBOX_API_KEY=$API_KEY" > /opt/today/.inbox-api-key
                chmod 600 /opt/today/.inbox-api-key
                echo "Generated new API key: $API_KEY"
            else
                source /opt/today/.inbox-api-key
                echo "Using existing API key: $INBOX_API_KEY"
            fi
EOF
        
        # Copy service file
        scp -i "$SSH_KEY" config/inbox-api.service ${DROPLET_USER}@${DROPLET_IP}:/tmp/inbox-api.service
        
        # Install service and nginx config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << 'EOF'
            # Install service
            sudo mv /tmp/inbox-api.service /etc/systemd/system/
            sudo systemctl daemon-reload
            sudo systemctl enable inbox-api
            sudo systemctl restart inbox-api
            
            # Update nginx config if not already configured
            if ! grep -q "/api/inbox/" /etc/nginx/sites-available/default; then
                # Add the inbox API configuration before the last closing brace
                sudo sed -i '/^}$/i \
    # Inbox API endpoint\
    location /api/inbox/ {\
        proxy_pass http://127.0.0.1:3333/inbox/;\
        proxy_http_version 1.1;\
        proxy_set_header Upgrade $http_upgrade;\
        proxy_set_header Connection '"'"'upgrade'"'"';\
        proxy_set_header Host $host;\
        proxy_cache_bypass $http_upgrade;\
        proxy_set_header X-Real-IP $remote_addr;\
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\
        proxy_set_header X-Forwarded-Proto $scheme;\
        client_max_body_size 10M;\
        proxy_connect_timeout 60s;\
        proxy_send_timeout 60s;\
        proxy_read_timeout 60s;\
    }\
    \
    location /api/health {\
        proxy_pass http://127.0.0.1:3333/health;\
        proxy_http_version 1.1;\
        proxy_set_header Host $host;\
    }' /etc/nginx/sites-available/default
                
                # Test and reload nginx
                sudo nginx -t && sudo systemctl reload nginx
                echo "Nginx configuration updated"
            else
                echo "Nginx already configured for inbox API"
            fi
            
            sleep 2
            sudo systemctl status inbox-api --no-pager
            
            # Show the API key for user to copy
            echo ""
            echo "================================"
            source /opt/today/.inbox-api-key
            echo "Inbox API Key: $INBOX_API_KEY"
            echo "================================"
            echo ""
            echo "Save this API key in your Drafts app!"
            echo "Endpoint: https://today.jeffcovey.net/api/inbox/upload"
EOF
        
        print_status "Inbox API installed and configured"
        ;;
    
    vault-api-setup)
        echo "üìö Setting up vault read API..."
        check_config
        
        print_info "Installing vault API service..."
        
        # Copy service file
        scp -i "$SSH_KEY" config/vault-api.service ${DROPLET_USER}@${DROPLET_IP}:/tmp/vault-api.service
        
        # Install service and nginx config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << 'EOF'
            # Install service
            sudo mv /tmp/vault-api.service /etc/systemd/system/
            sudo systemctl daemon-reload
            sudo systemctl enable vault-api
            sudo systemctl restart vault-api
            
            # Update nginx config if not already configured
            if ! grep -q "/api/vault/" /etc/nginx/sites-available/today.jeffcovey.net; then
                # Add the vault API configuration before the first location block
                sudo sed -i '/location \/ {/i\
    # Vault API endpoints\
    location /api/vault/ {\
        proxy_pass http://127.0.0.1:3334/vault/;\
        proxy_http_version 1.1;\
        proxy_set_header Upgrade $http_upgrade;\
        proxy_set_header Connection '"'"'upgrade'"'"';\
        proxy_set_header Host $host;\
        proxy_cache_bypass $http_upgrade;\
        proxy_set_header X-Real-IP $remote_addr;\
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\
        proxy_set_header X-Forwarded-Proto $scheme;\
        proxy_connect_timeout 60s;\
        proxy_send_timeout 60s;\
        proxy_read_timeout 60s;\
    }\
' /etc/nginx/sites-available/today.jeffcovey.net
                
                # Test and reload nginx
                sudo nginx -t && sudo systemctl reload nginx
                echo "Nginx configuration updated"
            else
                echo "Nginx already configured for vault API"
            fi
            
            sleep 2
            sudo systemctl status vault-api --no-pager
EOF
        
        print_status "Vault API installed and configured"
        print_info "Vault API endpoint: https://today.jeffcovey.net/api/vault/"
        ;;
    
    vault-api)
        # Control vault API on droplet
        check_config
        ACTION="${2:-status}"
        print_info "Vault API: $ACTION"
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sudo systemctl $ACTION vault-api && sudo systemctl status vault-api --no-pager"
        ;;
    
    inbox-api)
        # Control inbox API on droplet
        check_config
        ACTION="${2:-status}"
        print_info "Inbox API: $ACTION"
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sudo systemctl $ACTION inbox-api && sudo systemctl status inbox-api --no-pager"
        
        if [ "$ACTION" = "status" ] || [ "$ACTION" = "restart" ]; then
            # Show API key
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << 'EOF'
                if [ -f /opt/today/.inbox-api-key ]; then
                    echo ""
                    source /opt/today/.inbox-api-key
                    echo "API Key: $INBOX_API_KEY"
                    echo "Upload endpoint: https://today.jeffcovey.net/api/inbox/upload"
                    echo "Vault endpoint: https://today.jeffcovey.net/api/vault/"
                fi
EOF
        fi
        ;;
    
    ollama-setup)
        echo "ü§ñ Setting up Ollama on droplet..."
        check_config
        
        print_info "Installing Ollama..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "curl -fsSL https://ollama.com/install.sh | sh"
        
        print_info "Starting Ollama service..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl enable ollama && systemctl start ollama"
        
        print_info "Waiting for Ollama to start..."
        sleep 5
        
        print_info "Testing Ollama installation..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "ollama --version"
        
        print_info "Checking available memory..."
        AVAILABLE_MB=$(ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "free -m | awk '/^Mem:/ {print \$7}'")
        
        if [ "$AVAILABLE_MB" -lt 800 ]; then
            print_warning "Only ${AVAILABLE_MB}MB RAM available. LLMs need at least 800MB."
            print_warning "Consider upgrading to a 2GB droplet ($12/month) for local LLM support."
            print_info "Skipping model download due to insufficient memory."
        else
            print_info "Pulling tinyllama model (637MB) - fastest small model..."
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "ollama pull tinyllama"
            
            print_info "Testing model..."
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "echo 'What is 2+2?' | ollama run tinyllama"
        fi
        
        print_status "Ollama setup complete!"
        print_info "Available at http://localhost:11434 on the droplet"
        print_info "Add OLLAMA_HOST=http://localhost:11434 to your .env"
        ;;
        
    ollama)
        echo "ü§ñ Managing Ollama models..."
        check_config
        
        case "${2:-list}" in
            list)
                print_info "Installed models:"
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "ollama list"
                ;;
            pull)
                if [ -z "$3" ]; then
                    print_error "Usage: bin/deploy-do ollama pull <model>"
                    echo "Recommended models (memory requirements):"
                    echo "  ‚Ä¢ tinyllama (800MB RAM) - Very fast, basic quality"  
                    echo "  ‚Ä¢ phi3 (4GB RAM) - Good balance of speed and quality"
                    echo "  ‚Ä¢ mistral (6GB RAM) - Better quality"
                    echo "  ‚Ä¢ codellama (5GB RAM) - For coding tasks"
                    exit 1
                fi
                print_info "Pulling model: $3"
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "ollama pull $3"
                ;;
            rm)
                if [ -z "$3" ]; then
                    print_error "Usage: bin/deploy-do ollama rm <model>"
                    exit 1
                fi
                print_info "Removing model: $3"
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "ollama rm $3"
                ;;
            test)
                MODEL="${3:-phi3-mini}"
                print_info "Testing model: $MODEL"
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "echo 'Hello, how are you?' | ollama run $MODEL"
                ;;
            *)
                echo "Usage: bin/deploy-do ollama [list|pull <model>|rm <model>|test [model]]"
                ;;
        esac
        ;;

    exec)
        if [ -z "$2" ]; then
            print_error "Usage: bin/deploy-do exec 'command'"
            exit 1
        fi
        check_config
        shift
        echo "‚ö° Executing: $*"
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && $*"
        ;;

    fetch)
        if [ -z "$2" ]; then
            print_error "Usage: bin/deploy-do fetch <path> [options]"
            echo ""
            echo "Examples:"
            echo "  bin/deploy-do fetch /                    # Fetch homepage"
            echo "  bin/deploy-do fetch /tasks/today.md      # Fetch today's tasks"
            echo "  bin/deploy-do fetch /plans/              # List plans directory"
            echo "  bin/deploy-do fetch /api/health          # Check API health"
            echo ""
            echo "Options:"
            echo "  --raw           Output raw HTML/content without processing"
            echo "  --headers       Include response headers"
            echo "  --no-auth       Skip authentication (for public endpoints)"
            echo "  --output FILE   Save response to file"
            exit 1
        fi
        check_config

        # Parse arguments
        URL_PATH="$2"
        shift 2

        RAW_OUTPUT=""
        SHOW_HEADERS=""
        SKIP_AUTH=""
        OUTPUT_FILE=""
        CURL_OPTS=""

        while [ $# -gt 0 ]; do
            case "$1" in
                --raw)
                    RAW_OUTPUT="1"
                    shift
                    ;;
                --headers)
                    SHOW_HEADERS="1"
                    CURL_OPTS="$CURL_OPTS -i"
                    shift
                    ;;
                --no-auth)
                    SKIP_AUTH="1"
                    shift
                    ;;
                --output)
                    OUTPUT_FILE="$2"
                    shift 2
                    ;;
                *)
                    print_warning "Unknown option: $1"
                    shift
                    ;;
            esac
        done

        print_info "Fetching: $URL_PATH"

        # Build the full URL
        FULL_URL="https://today.jeffcovey.net${URL_PATH}"

        if [ -z "$SKIP_AUTH" ]; then
            # Get credentials and authenticate
            print_info "Authenticating..."

            # Decrypt password locally
            WEB_PASSWORD=$(npx dotenvx get WEB_PASSWORD --format shell 2>/dev/null)
            if [ -z "$WEB_PASSWORD" ]; then
                print_error "Failed to decrypt WEB_PASSWORD. Ensure .env.keys exists."
                exit 1
            fi

            # Create temp cookie file
            COOKIE_FILE="/tmp/deploy-do-cookies-$$"

            # Authenticate and get session cookie
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "
                curl -s -c $COOKIE_FILE -X POST \
                    -d 'username=admin' \
                    --data-urlencode 'password=$WEB_PASSWORD' \
                    https://today.jeffcovey.net/auth/login \
                    -o /dev/null -w '%{http_code}'
            " > /tmp/auth-status-$$

            AUTH_STATUS=$(cat /tmp/auth-status-$$)
            rm -f /tmp/auth-status-$$

            if [ "$AUTH_STATUS" != "302" ] && [ "$AUTH_STATUS" != "200" ]; then
                print_error "Authentication failed (HTTP $AUTH_STATUS)"
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "rm -f $COOKIE_FILE"
                exit 1
            fi

            print_status "Authenticated successfully"

            # Fetch the requested URL with authentication
            if [ -n "$OUTPUT_FILE" ]; then
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "
                    curl -s -b $COOKIE_FILE $CURL_OPTS '$FULL_URL'
                " > "$OUTPUT_FILE"
                print_status "Saved to: $OUTPUT_FILE"
            elif [ -n "$RAW_OUTPUT" ]; then
                # Raw output without any processing
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "
                    curl -s -b $COOKIE_FILE $CURL_OPTS '$FULL_URL'
                "
            else
                # Process output for better readability
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "
                    curl -s -b $COOKIE_FILE $CURL_OPTS '$FULL_URL' |
                    if command -v lynx >/dev/null 2>&1; then
                        lynx -stdin -dump -width=120 -nolist 2>/dev/null || cat
                    elif command -v w3m >/dev/null 2>&1; then
                        w3m -dump -cols 120 -T text/html 2>/dev/null || cat
                    elif command -v html2text >/dev/null 2>&1; then
                        html2text -width 120 2>/dev/null || cat
                    else
                        # Basic HTML stripping with sed
                        sed 's/<[^>]*>//g' | sed 's/&nbsp;/ /g' | sed 's/&lt;/</g' | sed 's/&gt;/>/g' | sed 's/&amp;/\&/g' | fmt -w 120
                    fi
                "
            fi

            # Clean up cookie file
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "rm -f $COOKIE_FILE"

        else
            # No authentication needed
            if [ -n "$OUTPUT_FILE" ]; then
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "curl -s $CURL_OPTS '$FULL_URL'" > "$OUTPUT_FILE"
                print_status "Saved to: $OUTPUT_FILE"
            elif [ -n "$RAW_OUTPUT" ]; then
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "curl -s $CURL_OPTS '$FULL_URL'"
            else
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "
                    curl -s $CURL_OPTS '$FULL_URL' |
                    if command -v lynx >/dev/null 2>&1; then
                        lynx -stdin -dump -width=120 -nolist 2>/dev/null || cat
                    elif command -v w3m >/dev/null 2>&1; then
                        w3m -dump -cols 120 -T text/html 2>/dev/null || cat
                    else
                        sed 's/<[^>]*>//g' | sed 's/&nbsp;/ /g' | sed 's/&lt;/</g' | sed 's/&gt;/>/g' | sed 's/&amp;/\&/g' | fmt -w 120
                    fi
                "
            fi
        fi
        ;;

    *)
        echo "Usage: bin/deploy-do [command]"
        echo ""
        echo "Commands:"
        echo "  setup       - Initial droplet setup (run once)"
        echo "  deploy      - Deploy code to droplet (default, includes .git)"
        echo "  secrets     - Update .env files"
        echo "  db-init     - Initialize database"
        echo "  db-upload   - Upload local database to droplet"
        echo "  git-setup   - Manually setup git repository"
        echo "  vault-watcher-setup - Setup vault file watcher service"
        echo "  vault-watcher - Control vault watcher (start|stop|restart|status)"
        echo "  resilio-sync - Manage Resilio Sync (setup|start|stop|restart|status|key)"
        echo "  inbox-api-setup - Setup inbox upload API for Drafts"
        echo "  inbox-api   - Control inbox API (start|stop|restart|status)"
        echo "  vault-api-setup - Setup vault read API for Drafts sync"
        echo "  vault-api   - Control vault API (start|stop|restart|status)"
        echo "  ollama-setup - Install and setup Ollama with phi3-mini model"
        echo "  ollama      - Manage Ollama models (list|pull|rm|test)"
        echo "  nginx-config - Update nginx configuration"
        echo "  ssh         - SSH into droplet"
        echo "  logs        - Show scheduler logs"
        echo "  status      - Show scheduler status"
        echo "  restart     - Restart scheduler"
        echo "  web-restart - Restart web server"
        echo "  stop        - Stop scheduler"
        echo "  start       - Start scheduler"
        echo "  exec CMD    - Execute command in deploy directory"
        echo "  fetch PATH  - Fetch authenticated web pages from the site"
        echo ""
        echo "First time setup:"
        echo "  1. Create a DigitalOcean droplet (Ubuntu 24.04)"
        echo "  2. Add DO_DROPLET_IP to .env and encrypt with dotenvx"
        echo "  3. bin/deploy-do setup       # Install dependencies on droplet"
        echo "  4. bin/deploy-do secrets     # Copy encrypted secrets"
        echo "  5. bin/deploy-do deploy      # Deploy code (includes .git)"
        echo "  6. bin/deploy-do db-upload   # Upload your local database"
        echo "  8. bin/deploy-do ollama-setup # Install Ollama with phi3-mini model"
        echo ""
        echo "Note: deploy now includes .git for sync operations"
        ;;
esac