#!/bin/bash
# Deploy to DigitalOcean Droplet
# This script helps manage deployment to a DigitalOcean droplet

set -e

# If we're not already running under dotenvx, wrap ourselves
if [ -z "$DOTENVX_INJECTED" ]; then
    export DOTENVX_INJECTED=1
    exec npx dotenvx run -- "$0" "$@"
fi

# Configuration
DROPLET_IP="${DO_DROPLET_IP:-}"
DROPLET_USER="${DO_DROPLET_USER:-root}"
DEPLOY_PATH="/opt/today"
SSH_KEY="${HOME}/.ssh/do_deploy_key"

# Check if deployment key exists
if [ ! -f "$SSH_KEY" ]; then
    echo "‚ö†Ô∏è  Deployment key not found. Setting up..."
    .devcontainer/setup-ssh-keys.sh
fi

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

print_status() { echo -e "${GREEN}‚úì${NC} $1"; }
print_info() { echo -e "${BLUE}‚Ñπ${NC} $1"; }
print_warning() { echo -e "${YELLOW}‚ö†${NC} $1"; }
print_error() { echo -e "${RED}‚úó${NC} $1"; }

# Check if IP is configured
check_config() {
    if [ -z "$DROPLET_IP" ]; then
        print_error "DROPLET_IP not set!"
        echo "Please set your droplet IP:"
        echo "  export DO_DROPLET_IP=your.droplet.ip.address"
        echo "Or add to .env:"
        echo "  DO_DROPLET_IP=your.droplet.ip.address"
        exit 1
    fi
}

# Parse arguments
ACTION="${1:-deploy}"

case "$ACTION" in
    setup)
        echo "üöÄ Initial setup of DigitalOcean droplet..."
        check_config
        
        print_info "This will install Node.js, Git, and dependencies on your droplet"
        # Check if running non-interactively or with --yes flag
        if [ ! -t 0 ] || [ "$2" = "--yes" ] || [ "$2" = "-y" ]; then
            REPLY="y"
        else
            read -p "Continue? (y/n) " -n 1 -r
            echo
        fi
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
        
        print_info "Copying setup script to droplet..."
        scp -i "$SSH_KEY" bin/setup-droplet.sh ${DROPLET_USER}@${DROPLET_IP}:/tmp/
        
        print_info "Running setup on droplet..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "bash /tmp/setup-droplet.sh"
        
        print_status "Setup complete!"
        echo "Run 'bin/deploy-do deploy' to deploy your code"
        ;;
        
    deploy)
        echo "üö¢ Deploying to DigitalOcean..."
        check_config
        
        print_info "Syncing code to ${DROPLET_USER}@${DROPLET_IP}:${DEPLOY_PATH}"
        
        # Create deployment and data directories if they don't exist
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "mkdir -p ${DEPLOY_PATH} ${DEPLOY_PATH}/.data"
        
        # Use git pull for code updates (much faster than rsync)
        print_info "Pulling latest code from git..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && git pull"
        
        # Only sync essential files that aren't in git (like .env)
        print_info "Syncing configuration files..."
        rsync -avz -e "ssh -i $SSH_KEY" \
            --include='.env' \
            --include='.env.keys' \
            --exclude='*' \
            ./ ${DROPLET_USER}@${DROPLET_IP}:${DEPLOY_PATH}/
        
        # Ensure git is configured properly on droplet
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "git config --global --add safe.directory ${DEPLOY_PATH}" 2>/dev/null || true
        
        # Configure git user identity for commits
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "git config --global user.email 'today-bot@system.local' && git config --global user.name 'Today Bot'" 2>/dev/null || true
        
        # Setup tmux config if not exists
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "[ ! -f ~/.tmux.conf ] && echo 'set -g default-command \"cd /opt/today && exec bash\"' > ~/.tmux.conf || true" 2>/dev/null || true
        
        # Configure git to use GitHub token for authentication (if available)
        print_info "Configuring GitHub authentication..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && npx dotenvx run -- bash -c 'if [ -n \"\$GITHUB_TOKEN\" ]; then echo \"https://\${GITHUB_TOKEN}:x-oauth-basic@github.com\" > ~/.git-credentials && git config --global credential.helper store && echo \"‚úì GitHub token configured\"; fi'" 2>/dev/null || true
        
        print_info "Installing dependencies..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && npm install --production"
        
        # Only initialize database if it doesn't exist
        if ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "[ ! -f ${DEPLOY_PATH}/.data/today.db ]"; then
            print_info "First deployment - initializing database..."
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && timeout 30 npx dotenvx run -- node src/migrations.js"
            
            print_info "Pulling all data from Turso (this may take a while)..."
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && rm -f .data/turso-sync.json && npx dotenvx run -- bin/turso-sync pull --full" || print_warning "Full pull may have been interrupted"
        else
            print_info "Database exists, running migrations..."
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && timeout 30 npx dotenvx run -- node src/migrations.js" || print_warning "Migrations may have already run"
        fi
        
        # Ensure Syncthing service file is correct (fix for STHOME issue)
        if [ -f config/syncthing.service ]; then
            print_info "Checking Syncthing service configuration..."
            scp -i "$SSH_KEY" config/syncthing.service ${DROPLET_USER}@${DROPLET_IP}:/tmp/syncthing.service 2>/dev/null || true
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "if [ -f /etc/systemd/system/syncthing.service ]; then if ! grep -q 'HOME=/opt/today' /etc/systemd/system/syncthing.service 2>/dev/null; then sudo cp /tmp/syncthing.service /etc/systemd/system/syncthing.service && sudo systemctl daemon-reload && echo 'Updated Syncthing service file'; fi; fi" || true
        fi
        
        print_info "Restarting services..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl restart today-scheduler || true"
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl restart vault-web || true"
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl restart syncthing || true"
        
        print_status "Deployment complete!"
        ;;
        
    secrets)
        echo "üîê Updating secrets on droplet..."
        check_config
        
        print_info "Copying .env file..."
        scp -i "$SSH_KEY" .env ${DROPLET_USER}@${DROPLET_IP}:${DEPLOY_PATH}/.env
        
        if [ -f .env.keys ]; then
            print_info "Extracting and copying decryption key..."
            # Extract just the key value, not the whole file
            PRIVATE_KEY=$(grep '^DOTENV_PRIVATE_KEY=' .env.keys | cut -d= -f2)
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "echo 'DOTENV_PRIVATE_KEY=${PRIVATE_KEY}' > ${DEPLOY_PATH}/.env.keys"
        fi
        
        print_info "Setting proper permissions..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "chmod 600 ${DEPLOY_PATH}/.env*"
        
        print_info "Restarting services..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl restart today-scheduler || true"
        
        print_status "Secrets updated!"
        ;;
        
    ssh)
        echo "üîå Connecting to droplet..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP}
        ;;
        
    logs)
        echo "üìä Showing scheduler logs..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "journalctl -u today-scheduler -f"
        ;;
        
    status)
        echo "üìà Checking status..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl status today-scheduler"
        ;;
        
    nginx-config)
        echo "üîß Updating nginx configuration..."
        check_config
        
        print_info "Copying nginx config to droplet..."
        scp -i "$SSH_KEY" config/nginx-vault-web-fixed.conf ${DROPLET_USER}@${DROPLET_IP}:/tmp/
        
        print_info "Installing nginx config..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sudo cp /tmp/nginx-vault-web-fixed.conf /etc/nginx/sites-available/today.jeffcovey.net"
        
        print_info "Testing nginx configuration..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sudo nginx -t"
        
        print_info "Reloading nginx..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sudo systemctl reload nginx"
        
        print_status "Nginx configuration updated!"
        ;;
        
    restart)
        echo "üîÑ Restarting scheduler..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl restart today-scheduler"
        print_status "Scheduler restarted"
        ;;
        
    web-restart)
        echo "üåê Restarting web server..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl restart vault-web"
        print_status "Web server restarted"
        ;;
        
    stop)
        echo "‚èπ Stopping scheduler..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl stop today-scheduler"
        print_status "Scheduler stopped"
        ;;
        
    start)
        echo "‚ñ∂Ô∏è Starting scheduler..."
        check_config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl start today-scheduler"
        print_status "Scheduler started"
        ;;
        
    db-init)
        echo "üóÑÔ∏è Initializing database..."
        check_config
        print_info "Creating .data directory..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "mkdir -p ${DEPLOY_PATH}/.data"
        
        print_info "Running database migrations..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && npx dotenvx run -- node src/migrations.js"
        
        print_status "Database initialized!"
        ;;
        
    git-setup)
        echo "üîß Setting up git repository on droplet..."
        check_config
        
        print_info "Copying .git directory to droplet..."
        rsync -avzh --progress -e "ssh -i $SSH_KEY" \
            .git/ ${DROPLET_USER}@${DROPLET_IP}:${DEPLOY_PATH}/.git/
        
        print_info "Configuring git safe directory..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "git config --global --add safe.directory ${DEPLOY_PATH}"
        
        print_info "Configuring git user identity..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "git config --global user.email 'today-bot@system.local' && git config --global user.name 'Today Bot'"
        
        print_info "Configuring GitHub authentication..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && npx dotenvx run -- bash -c 'if [ -n \"\$GITHUB_TOKEN\" ]; then echo \"https://\${GITHUB_TOKEN}:x-oauth-basic@github.com\" > ~/.git-credentials && git config --global credential.helper store && echo \"‚úì GitHub token configured\"; else echo \"‚ö† No GITHUB_TOKEN found\"; fi'"
        
        print_info "Testing git access..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && npx dotenvx run -- git fetch --dry-run" 2>/dev/null && print_status "Git fetch successful!" || print_warning "Git fetch failed - check GITHUB_TOKEN"
        
        print_info "Checking git status..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && git status --short"
        
        print_status "Git repository configured!"
        ;;
        
    db-upload)
        echo "üì§ Uploading local database to droplet..."
        check_config
        
        if [ ! -f ".data/today.db" ]; then
            print_error "Local database .data/today.db not found!"
            exit 1
        fi
        
        # Allow custom target name (e.g., today.db.macbook)
        TARGET_NAME="${2:-today.db}"
        
        print_info "Backing up existing database on droplet..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && [ -f .data/today.db ] && cp .data/today.db .data/today.db.backup-$(date +%Y%m%d-%H%M%S) || true"
        
        print_info "Uploading database ($(du -h .data/today.db | cut -f1)) using rsync..."
        # Using -avzh as you confirmed works (z for compression, h for human-readable)
        rsync -avzh --progress -e "ssh -i $SSH_KEY" \
            .data/today.db ${DROPLET_USER}@${DROPLET_IP}:${DEPLOY_PATH}/.data/${TARGET_NAME}
        
        # If uploaded with different name, move to today.db
        if [ "$TARGET_NAME" != "today.db" ]; then
            print_info "Moving ${TARGET_NAME} to today.db..."
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH}/.data && mv ${TARGET_NAME} today.db"
        fi
        
        print_info "Setting permissions..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "chmod 644 ${DEPLOY_PATH}/.data/today.db"
        
        print_info "Verifying upload..."
        LOCAL_SIZE=$(du -b .data/today.db | cut -f1)
        REMOTE_SIZE=$(ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "du -b ${DEPLOY_PATH}/.data/today.db | cut -f1")
        if [ "$LOCAL_SIZE" != "$REMOTE_SIZE" ]; then
            print_warning "Size mismatch: local=$LOCAL_SIZE remote=$REMOTE_SIZE"
        else
            print_status "Database size verified: $(du -h .data/today.db | cut -f1)"
        fi
        
        # Quick data check
        TASK_COUNT=$(ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sqlite3 ${DEPLOY_PATH}/.data/today.db 'SELECT COUNT(*) FROM tasks' 2>/dev/null || echo 0")
        print_info "Database contains $TASK_COUNT tasks"
        
        print_status "Database uploaded successfully!"
        ;;
        
    vault-watcher-setup)
        echo "üëÅÔ∏è Setting up vault watcher service..."
        check_config
        
        print_info "Installing vault watcher service..."
        
        # Copy service file
        scp -i "$SSH_KEY" config/vault-watcher.service ${DROPLET_USER}@${DROPLET_IP}:/tmp/vault-watcher.service
        
        # Install and enable service
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << 'EOF'
            sudo mv /tmp/vault-watcher.service /etc/systemd/system/
            sudo systemctl daemon-reload
            sudo systemctl enable vault-watcher
            sudo systemctl restart vault-watcher
            sleep 2
            sudo systemctl status vault-watcher
EOF
        print_status "Vault watcher service installed and started"
        ;;
    
    vault-watcher)
        # Control vault watcher on droplet
        check_config
        ACTION="${2:-status}"
        print_info "Vault watcher: $ACTION"
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sudo systemctl $ACTION vault-watcher && sudo systemctl status vault-watcher --no-pager"
        ;;
    
    inbox-api-setup)
        echo "üìÆ Setting up inbox upload API..."
        check_config
        
        print_info "Generating API key..."
        
        # Generate a random API key if not exists
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << 'EOF'
            if [ ! -f /opt/today/.inbox-api-key ]; then
                API_KEY=$(openssl rand -hex 32)
                echo "INBOX_API_KEY=$API_KEY" > /opt/today/.inbox-api-key
                chmod 600 /opt/today/.inbox-api-key
                echo "Generated new API key: $API_KEY"
            else
                source /opt/today/.inbox-api-key
                echo "Using existing API key: $INBOX_API_KEY"
            fi
EOF
        
        # Copy service file
        scp -i "$SSH_KEY" config/inbox-api.service ${DROPLET_USER}@${DROPLET_IP}:/tmp/inbox-api.service
        
        # Install service and nginx config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << 'EOF'
            # Install service
            sudo mv /tmp/inbox-api.service /etc/systemd/system/
            sudo systemctl daemon-reload
            sudo systemctl enable inbox-api
            sudo systemctl restart inbox-api
            
            # Update nginx config if not already configured
            if ! grep -q "/api/inbox/" /etc/nginx/sites-available/default; then
                # Add the inbox API configuration before the last closing brace
                sudo sed -i '/^}$/i \
    # Inbox API endpoint\
    location /api/inbox/ {\
        proxy_pass http://127.0.0.1:3333/inbox/;\
        proxy_http_version 1.1;\
        proxy_set_header Upgrade $http_upgrade;\
        proxy_set_header Connection '"'"'upgrade'"'"';\
        proxy_set_header Host $host;\
        proxy_cache_bypass $http_upgrade;\
        proxy_set_header X-Real-IP $remote_addr;\
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\
        proxy_set_header X-Forwarded-Proto $scheme;\
        client_max_body_size 10M;\
        proxy_connect_timeout 60s;\
        proxy_send_timeout 60s;\
        proxy_read_timeout 60s;\
    }\
    \
    location /api/health {\
        proxy_pass http://127.0.0.1:3333/health;\
        proxy_http_version 1.1;\
        proxy_set_header Host $host;\
    }' /etc/nginx/sites-available/default
                
                # Test and reload nginx
                sudo nginx -t && sudo systemctl reload nginx
                echo "Nginx configuration updated"
            else
                echo "Nginx already configured for inbox API"
            fi
            
            sleep 2
            sudo systemctl status inbox-api --no-pager
            
            # Show the API key for user to copy
            echo ""
            echo "================================"
            source /opt/today/.inbox-api-key
            echo "Inbox API Key: $INBOX_API_KEY"
            echo "================================"
            echo ""
            echo "Save this API key in your Drafts app!"
            echo "Endpoint: https://ptod.us/api/inbox/upload"
EOF
        
        print_status "Inbox API installed and configured"
        ;;
    
    vault-api-setup)
        echo "üìö Setting up vault read API..."
        check_config
        
        print_info "Installing vault API service..."
        
        # Copy service file
        scp -i "$SSH_KEY" config/vault-api.service ${DROPLET_USER}@${DROPLET_IP}:/tmp/vault-api.service
        
        # Install service and nginx config
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << 'EOF'
            # Install service
            sudo mv /tmp/vault-api.service /etc/systemd/system/
            sudo systemctl daemon-reload
            sudo systemctl enable vault-api
            sudo systemctl restart vault-api
            
            # Update nginx config if not already configured
            if ! grep -q "/api/vault/" /etc/nginx/sites-available/today.jeffcovey.net; then
                # Add the vault API configuration before the first location block
                sudo sed -i '/location \/ {/i\
    # Vault API endpoints\
    location /api/vault/ {\
        proxy_pass http://127.0.0.1:3334/vault/;\
        proxy_http_version 1.1;\
        proxy_set_header Upgrade $http_upgrade;\
        proxy_set_header Connection '"'"'upgrade'"'"';\
        proxy_set_header Host $host;\
        proxy_cache_bypass $http_upgrade;\
        proxy_set_header X-Real-IP $remote_addr;\
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\
        proxy_set_header X-Forwarded-Proto $scheme;\
        proxy_connect_timeout 60s;\
        proxy_send_timeout 60s;\
        proxy_read_timeout 60s;\
    }\
' /etc/nginx/sites-available/today.jeffcovey.net
                
                # Test and reload nginx
                sudo nginx -t && sudo systemctl reload nginx
                echo "Nginx configuration updated"
            else
                echo "Nginx already configured for vault API"
            fi
            
            sleep 2
            sudo systemctl status vault-api --no-pager
EOF
        
        print_status "Vault API installed and configured"
        print_info "Vault API endpoint: https://today.jeffcovey.net/api/vault/"
        ;;
    
    vault-api)
        # Control vault API on droplet
        check_config
        ACTION="${2:-status}"
        print_info "Vault API: $ACTION"
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sudo systemctl $ACTION vault-api && sudo systemctl status vault-api --no-pager"
        ;;
    
    inbox-api)
        # Control inbox API on droplet
        check_config
        ACTION="${2:-status}"
        print_info "Inbox API: $ACTION"
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sudo systemctl $ACTION inbox-api && sudo systemctl status inbox-api --no-pager"
        
        if [ "$ACTION" = "status" ] || [ "$ACTION" = "restart" ]; then
            # Show API key
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << 'EOF'
                if [ -f /opt/today/.inbox-api-key ]; then
                    echo ""
                    source /opt/today/.inbox-api-key
                    echo "API Key: $INBOX_API_KEY"
                    echo "Upload endpoint: https://today.jeffcovey.net/api/inbox/upload"
                    echo "Vault endpoint: https://today.jeffcovey.net/api/vault/"
                fi
EOF
        fi
        ;;
    
    ollama-setup)
        echo "ü§ñ Setting up Ollama on droplet..."
        check_config
        
        print_info "Installing Ollama..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "curl -fsSL https://ollama.com/install.sh | sh"
        
        print_info "Starting Ollama service..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl enable ollama && systemctl start ollama"
        
        print_info "Waiting for Ollama to start..."
        sleep 5
        
        print_info "Testing Ollama installation..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "ollama --version"
        
        print_info "Checking available memory..."
        AVAILABLE_MB=$(ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "free -m | awk '/^Mem:/ {print \$7}'")
        
        if [ "$AVAILABLE_MB" -lt 800 ]; then
            print_warning "Only ${AVAILABLE_MB}MB RAM available. LLMs need at least 800MB."
            print_warning "Consider upgrading to a 2GB droplet ($12/month) for local LLM support."
            print_info "Skipping model download due to insufficient memory."
        else
            print_info "Pulling tinyllama model (637MB) - fastest small model..."
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "ollama pull tinyllama"
            
            print_info "Testing model..."
            ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "echo 'What is 2+2?' | ollama run tinyllama"
        fi
        
        print_status "Ollama setup complete!"
        print_info "Available at http://localhost:11434 on the droplet"
        print_info "Add OLLAMA_HOST=http://localhost:11434 to your .env"
        ;;
        
    syncthing-setup)
        echo "üìÇ Setting up Syncthing for vault sync..."
        check_config
        
        print_info "Copying Syncthing systemd service..."
        scp -i "$SSH_KEY" config/syncthing.service ${DROPLET_USER}@${DROPLET_IP}:/tmp/
        
        print_info "Installing systemd service..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sudo cp /tmp/syncthing.service /etc/systemd/system/ && sudo systemctl daemon-reload"
        
        print_info "Creating Syncthing config directory..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "mkdir -p /opt/today/.config/syncthing"
        
        print_info "Backing up any existing Syncthing keys..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "if [ -f /opt/today/.config/syncthing/key.pem ]; then cp /opt/today/.config/syncthing/*.pem /opt/today/.config/syncthing.backup/ 2>/dev/null || true; fi"
        
        print_info "Generating Syncthing configuration..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd /opt/today && HOME=/opt/today syncthing generate"
        
        print_info "Ensuring config is in correct location..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "if [ -d /opt/today/.local/state/syncthing ] && [ ! -d /opt/today/.config/syncthing ]; then mkdir -p /opt/today/.config && mv /opt/today/.local/state/syncthing /opt/today/.config/; fi"
        
        print_info "Starting Syncthing service..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sudo systemctl enable syncthing && sudo systemctl start syncthing"
        
        print_info "Waiting for Syncthing to start..."
        sleep 3
        
        print_info "Running headless setup..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && STHOME=/opt/today/.config/syncthing bin/syncthing-headless add-vault"
        
        print_info "Getting device ID..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && STHOME=/opt/today/.config/syncthing bin/syncthing-headless device-id"
        
        print_status "Syncthing setup complete!"
        echo "Access Syncthing at: http://${DROPLET_IP}:8384"
        echo "Use the device ID above to pair with your other devices"
        ;;
        
    syncthing-fix)
        echo "üîß Fixing Syncthing configuration..."
        check_config
        
        print_info "Stopping Syncthing service..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl stop syncthing"
        
        print_info "Backing up existing keys to preserve device ID..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "mkdir -p /tmp/syncthing-keys && find /root /opt/today -name 'key.pem' -path '*/syncthing/*' -exec cp {} /tmp/syncthing-keys/key.pem.backup \; 2>/dev/null; find /root /opt/today -name 'cert.pem' -path '*/syncthing/*' -exec cp {} /tmp/syncthing-keys/cert.pem.backup \; 2>/dev/null || true"
        
        print_info "Moving existing config to project directory..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "if [ -d /root/.local/state/syncthing ]; then mkdir -p /opt/today/.config && rm -rf /opt/today/.config/syncthing && mv /root/.local/state/syncthing /opt/today/.config/syncthing && echo 'Moved existing config'; elif [ -d /root/.config/syncthing ]; then mkdir -p /opt/today/.config && rm -rf /opt/today/.config/syncthing && mv /root/.config/syncthing /opt/today/.config/syncthing && echo 'Moved config from .config'; fi"
        
        print_info "Restoring keys if available..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "if [ -f /tmp/syncthing-keys/key.pem.backup ]; then cp /tmp/syncthing-keys/*.backup /opt/today/.config/syncthing/ && cd /opt/today/.config/syncthing && mv key.pem.backup key.pem 2>/dev/null; mv cert.pem.backup cert.pem 2>/dev/null; fi"
        
        print_info "Updating systemd service file..."
        scp -i "$SSH_KEY" config/syncthing.service ${DROPLET_USER}@${DROPLET_IP}:/tmp/
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "sudo cp /tmp/syncthing.service /etc/systemd/system/syncthing.service && sudo systemctl daemon-reload"
        
        print_info "Ensuring vault directory exists..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "mkdir -p /opt/today/vault"
        
        print_info "Starting Syncthing with correct config..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl start syncthing"
        
        print_info "Waiting for Syncthing to start..."
        sleep 3
        
        print_info "Checking service status..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl status syncthing --no-pager | head -20"
        
        print_status "Syncthing fix complete!"
        echo "Access Syncthing at: http://${DROPLET_IP}:8384"
        ;;
        
    syncthing-backup)
        echo "üíæ Backing up Syncthing device ID..."
        check_config
        
        print_info "Backing up Syncthing keys and config..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "mkdir -p /opt/today/backups/syncthing && cp -r /opt/today/.config/syncthing/*.pem /opt/today/.config/syncthing/config.xml /opt/today/backups/syncthing/ 2>/dev/null && ls -la /opt/today/backups/syncthing/"
        
        print_info "Getting device ID..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "grep 'My ID' /var/log/syslog | grep syncthing | tail -1 || journalctl -u syncthing | grep 'My ID' | tail -1"
        
        print_status "Backup complete!"
        echo "Keys backed up to /opt/today/backups/syncthing/"
        ;;
        
    syncthing-restore)
        echo "‚ôªÔ∏è Restoring Syncthing device ID..."
        check_config
        
        print_info "Checking for backup..."
        if ! ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "test -f /opt/today/backups/syncthing/key.pem"; then
            print_error "No backup found at /opt/today/backups/syncthing/"
            exit 1
        fi
        
        print_info "Stopping Syncthing..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl stop syncthing"
        
        print_info "Restoring keys..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cp /opt/today/backups/syncthing/*.pem /opt/today/.config/syncthing/"
        
        print_info "Starting Syncthing..."
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "systemctl start syncthing"
        
        print_info "Verifying device ID..."
        sleep 3
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "journalctl -u syncthing --since '10 seconds ago' | grep 'My ID'"
        
        print_status "Restore complete!"
        ;;
        
    ollama)
        echo "ü§ñ Managing Ollama models..."
        check_config
        
        case "${2:-list}" in
            list)
                print_info "Installed models:"
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "ollama list"
                ;;
            pull)
                if [ -z "$3" ]; then
                    print_error "Usage: bin/deploy-do ollama pull <model>"
                    echo "Recommended models (memory requirements):"
                    echo "  ‚Ä¢ tinyllama (800MB RAM) - Very fast, basic quality"  
                    echo "  ‚Ä¢ phi3 (4GB RAM) - Good balance of speed and quality"
                    echo "  ‚Ä¢ mistral (6GB RAM) - Better quality"
                    echo "  ‚Ä¢ codellama (5GB RAM) - For coding tasks"
                    exit 1
                fi
                print_info "Pulling model: $3"
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "ollama pull $3"
                ;;
            rm)
                if [ -z "$3" ]; then
                    print_error "Usage: bin/deploy-do ollama rm <model>"
                    exit 1
                fi
                print_info "Removing model: $3"
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "ollama rm $3"
                ;;
            test)
                MODEL="${3:-phi3-mini}"
                print_info "Testing model: $MODEL"
                ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "echo 'Hello, how are you?' | ollama run $MODEL"
                ;;
            *)
                echo "Usage: bin/deploy-do ollama [list|pull <model>|rm <model>|test [model]]"
                ;;
        esac
        ;;

    exec)
        if [ -z "$2" ]; then
            print_error "Usage: bin/deploy-do exec 'command'"
            exit 1
        fi
        check_config
        shift
        echo "‚ö° Executing: $*"
        ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "cd ${DEPLOY_PATH} && $*"
        ;;
        
    *)
        echo "Usage: bin/deploy-do [command]"
        echo ""
        echo "Commands:"
        echo "  setup       - Initial droplet setup (run once)"
        echo "  deploy      - Deploy code to droplet (default, includes .git)"
        echo "  secrets     - Update .env files"
        echo "  db-init     - Initialize database"
        echo "  db-upload   - Upload local database to droplet"
        echo "  git-setup   - Manually setup git repository"
        echo "  syncthing-setup - Setup Syncthing for vault sync"
        echo "  syncthing-fix - Fix Syncthing config location issue"
        echo "  syncthing-backup - Backup Syncthing device ID and keys"
        echo "  syncthing-restore - Restore Syncthing device ID from backup"
        echo "  vault-watcher-setup - Setup vault file watcher service"
        echo "  vault-watcher - Control vault watcher (start|stop|restart|status)"
        echo "  inbox-api-setup - Setup inbox upload API for Drafts"
        echo "  inbox-api   - Control inbox API (start|stop|restart|status)"
        echo "  vault-api-setup - Setup vault read API for Drafts sync"
        echo "  vault-api   - Control vault API (start|stop|restart|status)"
        echo "  ollama-setup - Install and setup Ollama with phi3-mini model"
        echo "  ollama      - Manage Ollama models (list|pull|rm|test)"
        echo "  nginx-config - Update nginx configuration"
        echo "  ssh         - SSH into droplet"
        echo "  logs        - Show scheduler logs"
        echo "  status      - Show scheduler status"
        echo "  restart     - Restart scheduler"
        echo "  web-restart - Restart web server"
        echo "  stop        - Stop scheduler"
        echo "  start       - Start scheduler"
        echo "  exec CMD    - Execute command in deploy directory"
        echo ""
        echo "First time setup:"
        echo "  1. Create a DigitalOcean droplet (Ubuntu 24.04)"
        echo "  2. Add DO_DROPLET_IP to .env and encrypt with dotenvx"
        echo "  3. bin/deploy-do setup       # Install dependencies on droplet"
        echo "  4. bin/deploy-do secrets     # Copy encrypted secrets"
        echo "  5. bin/deploy-do deploy      # Deploy code (includes .git)"
        echo "  6. bin/deploy-do db-upload   # Upload your local database"
        echo "  7. bin/deploy-do syncthing-setup # Setup Syncthing for vault sync"
        echo "  8. bin/deploy-do ollama-setup # Install Ollama with phi3-mini model"
        echo ""
        echo "Note: deploy now includes .git for sync operations"
        ;;
esac