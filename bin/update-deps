#!/bin/bash

# Script to update all dependencies and check for vulnerabilities
# Can be run in quiet mode with --quiet flag

QUIET=false
if [ "$1" = "--quiet" ]; then
    QUIET=true
fi

# Function to log only when not in quiet mode
log() {
    if [ "$QUIET" = false ]; then
        echo "$@"
    fi
}

# Function to always show important messages
alert() {
    echo "$@"
}

log "ðŸ”„ Checking npm dependencies..."
log ""

# Check for vulnerabilities first
VULN_OUTPUT=$(npm audit 2>&1)
if echo "$VULN_OUTPUT" | grep -q "found 0 vulnerabilities"; then
    log "âœ… No vulnerabilities found"
else
    # Check if there are actual vulnerabilities
    if echo "$VULN_OUTPUT" | grep -E "found [1-9][0-9]* vulnerabilit"; then
        alert "âš ï¸  Security vulnerabilities found!"
        echo "$VULN_OUTPUT"
        alert ""
        alert "ðŸ”§ Fixing vulnerabilities..."
        npm audit fix --silent
        alert "âœ… Attempted to fix vulnerabilities"
    else
        log "âœ… No vulnerabilities found"
    fi
fi

# Check for updates
log ""
log "ðŸ“¦ Checking for dependency updates..."
UPDATES=$(npx npm-check-updates 2>/dev/null | grep -E "^\s+\S+\s+\^")

if [ ! -z "$UPDATES" ]; then
    alert "ðŸ“¦ Updates available:"
    echo "$UPDATES"
    alert ""
    alert "Run 'bin/update-deps' to see details and update"
else
    log "âœ… All dependencies up to date"
fi

if [ "$QUIET" = false ]; then
    echo ""
    echo "To update all dependencies, run:"
    echo "  npm update --save"
    echo ""
    echo "To update major versions, run:"
    echo "  npx npm-check-updates -u && npm install"
fi