#!/bin/bash

# Update the file creation dates index
# This index is used by the Drafts sync script to set proper creation dates

INDEX_FILE=".file-dates.json"

# If index doesn't exist, create it with all files
if [ ! -f "$INDEX_FILE" ]; then
    echo "Creating initial file dates index..."
    echo "{" > "$INDEX_FILE"
    first=true
    
    # Process all markdown files in the repository (excluding hidden directories and node_modules)
    for file in $(find . -name "*.md" -type f -not -path "*/\.*" -not -path "*/node_modules/*" 2>/dev/null | sed 's|^\./||' | sort); do
        # Get file creation time (birth time if available, otherwise mtime)
        if stat --version 2>/dev/null | grep -q GNU; then
            # GNU stat (Linux)
            created_at=$(stat -c %W "$file")
            if [ "$created_at" = "-" ] || [ "$created_at" = "0" ]; then
                # Birth time not available, use modification time
                created_at=$(stat -c %Y "$file")
            fi
        else
            # BSD stat (macOS)
            created_at=$(stat -f %B "$file")
            if [ "$created_at" = "0" ]; then
                # Birth time not available, use modification time
                created_at=$(stat -f %m "$file")
            fi
        fi
        
        # Convert to ISO format
        created_at_iso=$(date -Iseconds -d "@$created_at" 2>/dev/null || date -r "$created_at" -Iseconds 2>/dev/null)
        
        # Add comma if not first entry
        if [ "$first" = true ]; then
            first=false
        else
            echo "," >> "$INDEX_FILE"
        fi
        
        # Write entry
        printf '  "%s": "%s"' "$file" "$created_at_iso" >> "$INDEX_FILE"
    done
    
    echo "" >> "$INDEX_FILE"
    echo "}" >> "$INDEX_FILE"
    echo "Created index with $(find . -name "*.md" -type f -not -path "*/\.*" -not -path "*/node_modules/*" 2>/dev/null | wc -l) files"
else
    # Index exists, only add new files from git staged changes
    echo "Updating file dates index with new files..."
    
    # Get list of staged markdown files (any .md file being added)
    new_files=$(git diff --cached --name-only --diff-filter=A | grep -E '\.md$')
    
    if [ -n "$new_files" ]; then
        # Read existing index
        existing_json=$(cat "$INDEX_FILE")
        
        # Remove closing brace
        temp_json="${existing_json%\}}"
        
        # Add new files
        for file in $new_files; do
            if [ -f "$file" ]; then
                # Get file creation time
                if stat --version 2>/dev/null | grep -q GNU; then
                    # GNU stat (Linux)
                    created_at=$(stat -c %W "$file")
                    if [ "$created_at" = "-" ] || [ "$created_at" = "0" ]; then
                        created_at=$(stat -c %Y "$file")
                    fi
                else
                    # BSD stat (macOS)
                    created_at=$(stat -f %B "$file")
                    if [ "$created_at" = "0" ]; then
                        created_at=$(stat -f %m "$file")
                    fi
                fi
                
                # Convert to ISO format
                created_at_iso=$(date -Iseconds -d "@$created_at" 2>/dev/null || date -r "$created_at" -Iseconds 2>/dev/null)
                
                # Add comma if there were existing entries
                if [ "${temp_json: -1}" != "{" ]; then
                    temp_json="${temp_json},"
                fi
                
                # Add new entry
                temp_json="${temp_json}
  \"$file\": \"$created_at_iso\""
                
                echo "  Added: $file"
            fi
        done
        
        # Write updated index
        echo "${temp_json}" > "$INDEX_FILE"
        echo "" >> "$INDEX_FILE"
        echo "}" >> "$INDEX_FILE"
        
        # Stage the updated index
        git add "$INDEX_FILE"
    else
        echo "No new markdown files to add"
    fi
fi