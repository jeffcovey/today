#!/usr/bin/env node

// Fetch contacts from specific Notion database
import { autoDotenvx } from './lib/dotenvx-loader.js';
autoDotenvx();

import { Client } from '@notionhq/client';
import chalk from 'chalk';

const DATABASE_ID = 'ac20b688e2774fc6a8a6dabe90271d01';

async function fetchContactsDatabase() {
  const token = process.env.NOTION_TOKEN;
  if (!token) {
    console.error(chalk.red('NOTION_TOKEN environment variable is required'));
    process.exit(1);
  }

  const notion = new Client({ auth: token });

  try {
    console.log(chalk.blue('Fetching contacts from Notion database...'));
    
    // Query the database
    const response = await notion.databases.query({
      database_id: DATABASE_ID,
      sorts: [
        {
          property: 'Name',
          direction: 'ascending'
        }
      ]
    });

    console.log(chalk.green(`âœ… Found ${response.results.length} contacts`));
    
    // Debug: Show available properties from first contact
    if (response.results.length > 0 && process.argv.includes('--debug')) {
      console.log('\nDebug - Available properties:');
      const firstPage = response.results[0];
      Object.keys(firstPage.properties).forEach(key => {
        const prop = firstPage.properties[key];
        console.log(`  - ${key}: ${prop.type}`);
      });
      console.log('');
    }
    
    // Process each contact
    const contacts = response.results.map(page => {
      const properties = page.properties;
      
      // Extract properties using actual database schema
      const name = properties.Name?.title?.[0]?.text?.content || 'Unknown';
      const lastContactedOrEdited = properties['Last Contacted Or Edited']?.formula?.date?.start || null;
      const manualContactDate = properties['Manual Contact Date']?.date?.start || null;
      const lastEdited = properties['Last Edited']?.last_edited_time || null;
      const weeksSinceContact = properties['Weeks Since Contact']?.formula?.number || null;
      const isDue = properties['Due?']?.formula?.boolean || false;
      const isToggled = properties.Toggle?.checkbox || false;
      const url = properties.URL?.url || '';
      
      // Use Last Contacted Or Edited formula field
      const lastContacted = lastContactedOrEdited;
      
      return {
        id: page.id,
        name,
        lastContacted,
        manualContactDate,
        lastEdited,
        weeksSinceContact,
        isDue,
        isToggled,
        url: url || page.url
      };
    });

    // Filter for contacts that are being tracked (toggled on)
    const trackedContacts = contacts.filter(c => c.isToggled);
    
    // Filter for overdue contacts (using the Due? formula from Notion)
    const overdueContacts = contacts.filter(contact => contact.isDue);

    // For one-time sync: Show ALL contacts with their dates
    console.log(chalk.cyan(`\nðŸ“Š All Notion Contacts with Dates:`));
    contacts.forEach(contact => {
      if (contact.lastContacted) {
        // Extract just the date part (YYYY-MM-DD)
        const dateOnly = contact.lastContacted.split('T')[0];
        console.log(`${contact.name}: Last contacted: ${dateOnly}`);
      }
    });

    // Return data for potential integration
    return {
      all: contacts,
      tracked: trackedContacts,
      overdue: overdueContacts
    };

  } catch (error) {
    console.error(chalk.red('Error fetching Notion database:'), error.message);
    
    // Check for specific error types
    if (error.code === 'object_not_found') {
      console.error(chalk.yellow('Database not found or you don\'t have access.'));
      console.error(chalk.yellow('Make sure the database is shared with your integration.'));
    } else if (error.code === 'unauthorized') {
      console.error(chalk.yellow('Invalid NOTION_TOKEN. Check your .env file.'));
    }
    
    process.exit(1);
  }
}

// Run if called directly
if (import.meta.url === `file://${process.argv[1]}`) {
  fetchContactsDatabase()
    .then(() => process.exit(0))
    .catch(error => {
      console.error('Error:', error.message);
      process.exit(1);
    });
}

export { fetchContactsDatabase };