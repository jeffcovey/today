#!/usr/bin/env node

// Fetch contacts from specific Notion database
import { autoDotenvx } from './lib/dotenvx-loader.js';
autoDotenvx();

import { Client } from '@notionhq/client';
import chalk from 'chalk';

const DATABASE_ID = 'ac20b688e2774fc6a8a6dabe90271d01';

async function fetchContactsDatabase() {
  const token = process.env.NOTION_TOKEN;
  if (!token) {
    console.error(chalk.red('NOTION_TOKEN environment variable is required'));
    process.exit(1);
  }

  const notion = new Client({ auth: token });

  try {
    console.log(chalk.blue('Fetching contacts from Notion database...'));
    
    // Query the database
    const response = await notion.databases.query({
      database_id: DATABASE_ID,
      sorts: [
        {
          property: 'Name',
          direction: 'ascending'
        }
      ]
    });

    console.log(chalk.green(`âœ… Found ${response.results.length} contacts`));
    
    // Debug: Show available properties from first contact
    if (response.results.length > 0 && process.argv.includes('--debug')) {
      console.log('\nDebug - Available properties:');
      const firstPage = response.results[0];
      Object.keys(firstPage.properties).forEach(key => {
        const prop = firstPage.properties[key];
        console.log(`  - ${key}: ${prop.type}`);
      });
      console.log('');
    }
    
    // Process each contact
    const contacts = response.results.map(page => {
      const properties = page.properties;
      
      // Extract properties using actual database schema
      const name = properties.Name?.title?.[0]?.text?.content || 'Unknown';
      const manualContactDate = properties['Manual Contact Date']?.date?.start || null;
      const lastEdited = properties['Last Edited']?.last_edited_time || null;
      const weeksSinceContact = properties['Weeks Since Contact']?.formula?.number || null;
      const isDue = properties['Due?']?.formula?.boolean || false;
      const isToggled = properties.Toggle?.checkbox || false;
      const url = properties.URL?.url || '';
      
      // Use Manual Contact Date if available, otherwise fall back to Last Edited
      const lastContacted = manualContactDate || lastEdited;
      
      return {
        id: page.id,
        name,
        lastContacted,
        manualContactDate,
        lastEdited,
        weeksSinceContact,
        isDue,
        isToggled,
        url: url || page.url
      };
    });

    // Filter for contacts that are being tracked (toggled on)
    const trackedContacts = contacts.filter(c => c.isToggled);
    
    // Filter for overdue contacts (using the Due? formula from Notion)
    const overdueContacts = contacts.filter(contact => contact.isDue);

    // Display results
    console.log(chalk.cyan(`\nðŸ“Š Contact Summary:`));
    console.log(`   Total contacts: ${contacts.length}`);
    console.log(`   Tracked contacts: ${trackedContacts.length}`);
    console.log(`   Overdue for contact: ${overdueContacts.length}`);
    
    if (overdueContacts.length > 0) {
      console.log(chalk.yellow(`\nâš ï¸  Contacts needing attention (6+ weeks):`));
      overdueContacts.forEach(contact => {
        const weeksSince = contact.weeksSinceContact ? Math.round(contact.weeksSinceContact) : 'Unknown';
        const lastDate = contact.manualContactDate || 'Never manually logged';
        console.log(`   â€¢ ${contact.name} (${weeksSince} weeks ago, last: ${lastDate})`);
        if (contact.url) {
          console.log(`     ${contact.url}`);
        }
      });
    }
    
    // Also show recently contacted if any
    const recentContacts = trackedContacts.filter(c => c.weeksSinceContact && c.weeksSinceContact < 2);
    if (recentContacts.length > 0) {
      console.log(chalk.green(`\nâœ… Recently contacted (< 2 weeks):`));
      recentContacts.forEach(contact => {
        const weeksSince = contact.weeksSinceContact ? Math.round(contact.weeksSinceContact) : 0;
        console.log(`   â€¢ ${contact.name} (${weeksSince} weeks ago)`);
      });
    }

    // Return data for potential integration
    return {
      all: contacts,
      tracked: trackedContacts,
      overdue: overdueContacts
    };

  } catch (error) {
    console.error(chalk.red('Error fetching Notion database:'), error.message);
    
    // Check for specific error types
    if (error.code === 'object_not_found') {
      console.error(chalk.yellow('Database not found or you don\'t have access.'));
      console.error(chalk.yellow('Make sure the database is shared with your integration.'));
    } else if (error.code === 'unauthorized') {
      console.error(chalk.yellow('Invalid NOTION_TOKEN. Check your .env file.'));
    }
    
    process.exit(1);
  }
}

// Run if called directly
if (import.meta.url === `file://${process.argv[1]}`) {
  fetchContactsDatabase()
    .then(() => process.exit(0))
    .catch(error => {
      console.error('Error:', error.message);
      process.exit(1);
    });
}

export { fetchContactsDatabase };