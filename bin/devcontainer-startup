#!/bin/bash
# Main startup script for devcontainer
set -e

echo "=== DevContainer Startup ==="
echo "Project: $(basename "$(pwd)")"
echo "Time: $(date)"

# Run setup scripts using unified setup command
if [ -f "bin/setup" ]; then
    echo "Setting up SSH..."
    bash bin/setup --ssh || echo "SSH setup failed, continuing..."
    
    echo "Setting up Tailscale hostname..."
    bash bin/setup --tailscale-hostname || echo "Tailscale hostname setup failed, continuing..."
fi


# Start vault git sync
if [ -f "bin/vault-sync-daemon" ] && [ -d "vault/.git" ]; then
    echo "Setting up vault git sync..."
    # Run initial pull to get latest
    echo "Pulling latest vault changes..."
    (cd vault && git pull --quiet) || echo "Initial vault pull failed - may need to resolve conflicts"
    
    # Start the sync daemon for periodic syncing
    echo "Starting vault sync daemon (syncs every 5 minutes)..."
    nohup bin/vault-sync-daemon > /dev/null 2>&1 &
    echo "Vault sync daemon started"
    echo "To sync manually, run: bin/vault-sync"
else
    echo "Vault git sync not configured - run bin/vault-sync setup-remote"
fi

# Start code-server
if [ -f "bin/start-code-server" ]; then
    echo "Starting code-server..."
    bash bin/start-code-server || echo "code-server startup failed"
fi

# Create a summary file for easy access
mkdir -p ~/.config/devcontainer
cat > ~/.config/devcontainer/access-info.txt <<EOF
=== DevContainer Access Information ===
Generated: $(date)
Project: $(basename "$(pwd)")

SSH Access:
  Port: 2222
  Command: ssh -p 2222 user@<container-ip>

Code Server Access:
  Port: 8081
  Tailscale IP: $(tailscale ip -4 2>/dev/null || echo "Not available")
  URL: http://$(tailscale ip -4 2>/dev/null || echo "localhost"):8081

To view this information again:
  cat ~/.config/devcontainer/access-info.txt

To restart code-server:
  bin/start-code-server
EOF

echo ""
echo "=== Access Information ==="
cat ~/.config/devcontainer/access-info.txt
echo ""
echo "DevContainer startup complete!"