#!/bin/bash

# Headless Syncthing Setup Script
# Runs Syncthing in background with API access for configuration

set -e

SYNCTHING_CONFIG_DIR="${HOME}/.config/syncthing"
SYNCTHING_API_KEY=""
SYNCTHING_PORT="${SYNCTHING_PORT:-8384}"
VAULT_PATH="${VAULT_PATH:-/workspaces/today/vault}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_status() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

# Check if syncthing is installed
if ! command -v syncthing &> /dev/null; then
    print_error "Syncthing is not installed. Please install it first."
    exit 1
fi

# Function to start syncthing
start_syncthing() {
    if pgrep -x "syncthing" > /dev/null; then
        print_warning "Syncthing is already running"
    else
        print_status "Starting Syncthing in background..."
        syncthing serve --no-browser --no-restart --logflags=0 &> /dev/null &
        sleep 3
        print_status "Syncthing started on http://localhost:${SYNCTHING_PORT}"
    fi
}

# Function to stop syncthing
stop_syncthing() {
    if pgrep -x "syncthing" > /dev/null; then
        print_status "Stopping Syncthing..."
        pkill syncthing
    else
        print_warning "Syncthing is not running"
    fi
}

# Function to get API key
get_api_key() {
    if [ -f "${SYNCTHING_CONFIG_DIR}/config.xml" ]; then
        SYNCTHING_API_KEY=$(grep -oP '(?<=<apikey>)[^<]+' "${SYNCTHING_CONFIG_DIR}/config.xml")
        if [ -z "$SYNCTHING_API_KEY" ]; then
            print_error "Could not extract API key from config"
            return 1
        fi
    else
        print_error "Syncthing config not found. Run 'syncthing generate' first."
        return 1
    fi
}

# Function to add vault folder via API
add_vault_folder() {
    get_api_key || return 1
    
    print_status "Adding vault folder via API..."
    
    # Create folder configuration JSON
    cat > /tmp/syncthing-folder.json <<EOF
{
    "id": "today-vault",
    "label": "Today Vault",
    "path": "${VAULT_PATH}",
    "type": "sendreceive",
    "devices": [],
    "rescanIntervalS": 60,
    "fsWatcherEnabled": true,
    "fsWatcherDelayS": 10,
    "ignorePerms": false,
    "autoNormalize": true,
    "paused": false
}
EOF

    # Add folder via API
    curl -X POST -H "X-API-Key: ${SYNCTHING_API_KEY}" \
        -H "Content-Type: application/json" \
        -d @/tmp/syncthing-folder.json \
        "http://localhost:${SYNCTHING_PORT}/rest/config/folders" \
        &> /dev/null
    
    # Restart syncthing to apply changes
    curl -X POST -H "X-API-Key: ${SYNCTHING_API_KEY}" \
        "http://localhost:${SYNCTHING_PORT}/rest/system/restart" \
        &> /dev/null
    
    rm /tmp/syncthing-folder.json
    print_status "Vault folder added successfully"
}

# Function to show device ID
show_device_id() {
    get_api_key || return 1
    
    echo ""
    echo "Your Syncthing Device ID:"
    
    # Try jq first, then fall back to grep if jq is not available
    if command -v jq &> /dev/null; then
        DEVICE_ID=$(curl -s -H "X-API-Key: ${SYNCTHING_API_KEY}" \
            "http://localhost:${SYNCTHING_PORT}/rest/system/status" | \
            jq -r '.myID // empty')
    else
        DEVICE_ID=$(curl -s -H "X-API-Key: ${SYNCTHING_API_KEY}" \
            "http://localhost:${SYNCTHING_PORT}/rest/system/status" | \
            sed -n 's/.*"myID":"\([^"]*\)".*/\1/p')
    fi
    
    if [ -n "$DEVICE_ID" ]; then
        echo "$DEVICE_ID"
    else
        print_error "Could not get device ID"
    fi
    echo ""
}

# Function to disable GUI authentication (for headless)
disable_gui_auth() {
    get_api_key || return 1
    
    print_warning "Disabling GUI authentication for headless access..."
    print_warning "WARNING: This makes Syncthing accessible without password!"
    
    # Modify config to remove GUI auth
    curl -X PATCH -H "X-API-Key: ${SYNCTHING_API_KEY}" \
        -H "Content-Type: application/json" \
        -d '{"gui": {"user": "", "password": ""}}' \
        "http://localhost:${SYNCTHING_PORT}/rest/config/gui" \
        &> /dev/null
    
    print_status "GUI authentication disabled"
}

# Main command handling
case "${1:-}" in
    start)
        start_syncthing
        ;;
    stop)
        stop_syncthing
        ;;
    status)
        if pgrep -x "syncthing" > /dev/null; then
            print_status "Syncthing is running"
            show_device_id
        else
            print_warning "Syncthing is not running"
        fi
        ;;
    setup)
        # Full setup for headless environment
        print_status "Setting up Syncthing for headless operation..."
        
        # Generate config if it doesn't exist
        if [ ! -f "${SYNCTHING_CONFIG_DIR}/config.xml" ]; then
            print_status "Generating Syncthing configuration..."
            syncthing generate
        fi
        
        start_syncthing
        sleep 3
        disable_gui_auth
        add_vault_folder
        show_device_id
        
        echo ""
        
        # Auto-add known devices (e.g., MacBook)
        if command -v jq &> /dev/null; then
            print_status "Adding known devices..."
            
            # MacBook device
            MACBOOK_ID="NFKKNCL-DOI4RVX-OD3FVOT-EXLVTW4-IJU33XQ-3IF6OA6-AEPXGCS-KXVNTAU"
            
            # Add MacBook as trusted device
            curl -X POST -H "X-API-Key: ${SYNCTHING_API_KEY}" \
                -H "Content-Type: application/json" \
                -d "{
                    \"deviceID\": \"${MACBOOK_ID}\",
                    \"name\": \"MacBook\",
                    \"addresses\": [\"dynamic\"],
                    \"compression\": \"metadata\",
                    \"introducer\": false,
                    \"paused\": false,
                    \"allowedNetworks\": [],
                    \"autoAcceptFolders\": false
                }" \
                "http://localhost:${SYNCTHING_PORT}/rest/config/devices" \
                &> /dev/null || true
            
            # Share vault folder with MacBook
            FOLDER_CONFIG=$(curl -s -H "X-API-Key: ${SYNCTHING_API_KEY}" \
                "http://localhost:${SYNCTHING_PORT}/rest/config/folders/today-vault")
            
            if [ "$FOLDER_CONFIG" != "null" ] && [ -n "$FOLDER_CONFIG" ]; then
                UPDATED_CONFIG=$(echo "$FOLDER_CONFIG" | jq ".devices += [{\"deviceID\": \"${MACBOOK_ID}\", \"introducedBy\": \"\", \"encryptionPassword\": \"\"}]")
                echo "$UPDATED_CONFIG" | curl -X PUT -H "X-API-Key: ${SYNCTHING_API_KEY}" \
                    -H "Content-Type: application/json" \
                    -d @- \
                    "http://localhost:${SYNCTHING_PORT}/rest/config/folders/today-vault" \
                    &> /dev/null || true
            fi
            
            # Restart to apply changes
            curl -X POST -H "X-API-Key: ${SYNCTHING_API_KEY}" \
                "http://localhost:${SYNCTHING_PORT}/rest/system/restart" \
                &> /dev/null || true
            
            print_status "MacBook device added and vault shared"
        fi
        
        echo ""
        print_status "Headless setup complete!"
        echo "Access Syncthing at: http://localhost:${SYNCTHING_PORT}"
        echo "Share the device ID above with your other devices to sync."
        ;;
    add-vault)
        add_vault_folder
        ;;
    device-id)
        show_device_id
        ;;
    *)
        echo "Syncthing Headless Manager"
        echo ""
        echo "Usage: $0 {start|stop|status|setup|add-vault|device-id}"
        echo ""
        echo "Commands:"
        echo "  start      - Start Syncthing in background"
        echo "  stop       - Stop Syncthing"
        echo "  status     - Show status and device ID"
        echo "  setup      - Complete headless setup (generate config, start, add vault)"
        echo "  add-vault  - Add vault folder to existing Syncthing instance"
        echo "  device-id  - Show this device's ID for pairing"
        echo ""
        echo "Environment variables:"
        echo "  SYNCTHING_PORT - Web UI port (default: 8384)"
        echo "  VAULT_PATH     - Path to vault directory (default: /workspaces/today/vault)"
        exit 1
        ;;
esac