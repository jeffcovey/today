#!/bin/bash

# Quick review script that syncs, updates summary, and pipes to Claude

# Load common dotenvx handler
source "$(dirname "$0")/lib/dotenvx-loader.sh"
auto_dotenvx "$@"

echo "ğŸ“Š Starting daily review process..."

# Run sync to update all data sources
echo "ğŸ”„ Syncing data sources..."
bin/sync

# Update the comprehensive summary with content and changes
echo "ğŸ“ Updating summary with content and changes..."
bin/update-summary

# Check if we should include the summary in the review
if [ -f SUMMARY.json ]; then
    echo "âœ… Summary updated successfully"
    
    # Prepare review file paths
    TODAY_DATE=$(date +%Y-%m-%d)
    REVIEW_FILE="notes/reviews/${TODAY_DATE}.md"
    TIMESTAMP=$(date +"%H:%M")
    
    # Create a temporary file with both TODAY.md and summary info
    TEMP_FILE=$(mktemp)
    
    # Add TODAY.md content
    cat TODAY.md > "$TEMP_FILE"
    
    # Add comprehensive summary from SUMMARY.json
    echo "" >> "$TEMP_FILE"
    echo "## ğŸ“Š AI Summary and Analysis" >> "$TEMP_FILE"
    echo "The SUMMARY.json file contains comprehensive content and tracking data:" >> "$TEMP_FILE"
    echo '```json' >> "$TEMP_FILE"
    # Include the entire summary since it now has meaningful content
    cat SUMMARY.json >> "$TEMP_FILE" 2>/dev/null || echo "Unable to read summary" >> "$TEMP_FILE"
    echo '```' >> "$TEMP_FILE"
    
    # Add note about saving
    echo "" >> "$TEMP_FILE"
    echo "---" >> "$TEMP_FILE"
    echo "" >> "$TEMP_FILE"
    echo "## ğŸ“ Session Notes" >> "$TEMP_FILE"
    echo "" >> "$TEMP_FILE"
    echo "**Review file:** $REVIEW_FILE" >> "$TEMP_FILE"
    echo "**Time:** $TIMESTAMP" >> "$TEMP_FILE"
    echo "" >> "$TEMP_FILE"
    echo "After I provide your daily review, you can:" >> "$TEMP_FILE"
    echo "1. Ask follow-up questions about any recommendations" >> "$TEMP_FILE"
    echo "2. Request help with specific tasks" >> "$TEMP_FILE"
    echo "3. Update your priorities based on new information" >> "$TEMP_FILE"
    echo "" >> "$TEMP_FILE"
    echo "ğŸ’¡ **Tip:** Copy important insights from our conversation and save them using:" >> "$TEMP_FILE"
    echo '```bash' >> "$TEMP_FILE"
    echo 'bin/progress "Your note here"  # Adds timestamped note to review file' >> "$TEMP_FILE"
    echo '```' >> "$TEMP_FILE"
    
    # Create or prepare the review file header
    if [ ! -f "$REVIEW_FILE" ]; then
        mkdir -p notes/reviews
        {
            echo "# Daily Review - $(date +'%B %d, %Y')"
            echo ""
            echo "## Morning Review ($TIMESTAMP)"
            echo "*Generated by Claude via bin/today*"
            echo ""
            echo "### Initial Analysis"
            echo "*Copy key insights from Claude below:*"
            echo ""
            echo "---"
            echo ""
            echo "## Progress Log"
            echo "*Update throughout the day with completed tasks and notes*"
            echo ""
        } > "$REVIEW_FILE"
        echo "ğŸ“ Created new review file: $REVIEW_FILE"
    else
        {
            echo ""
            echo "---"
            echo ""
            echo "## Update ($TIMESTAMP)"
            echo "*Copy key insights from Claude below:*"
            echo ""
        } >> "$REVIEW_FILE"
        echo "ğŸ“ Appending to existing review: $REVIEW_FILE"
    fi
    
    echo "ğŸ¤– Starting interactive Claude session..."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    # Run Claude interactively
    cat "$TEMP_FILE" | claude
    
    # After Claude exits, remind about saving
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… Claude session ended"
    echo ""
    echo "ğŸ“ Remember to save important insights using:"
    echo "   bin/progress \"Your note here\""
    echo ""
    echo "ğŸ“‚ Review file: $REVIEW_FILE"
    echo ""
    
    # Cleanup
    rm "$TEMP_FILE"
else
    # Fallback to original behavior
    echo "âš ï¸  No summary file found, using standard review"
    cat TODAY.md | claude
fi