#!/bin/bash

# Quick review script that syncs, updates summary, and starts interactive Claude session

# Load common dotenvx handler
source "$(dirname "$0")/lib/dotenvx-loader.sh"
auto_dotenvx "$@"

echo "ğŸ“Š Starting daily review process..."

# Check if Claude CLI is authenticated by testing actual functionality
echo "ğŸ” Checking Claude authentication..."
TEST_RESPONSE=$(claude --print "Say 'ok'" 2>&1)
if echo "$TEST_RESPONSE" | grep -q "Invalid API key\|Please run /login\|not authenticated"; then
    echo ""
    echo "âš ï¸  Claude CLI is not authenticated!"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Claude is essential for daily reviews."
    echo "Please authenticate now by running:"
    echo ""
    echo "  claude"
    echo ""
    echo "Then follow the browser prompt to login."
    echo "After authentication, run 'bin/today' again."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    exit 1
fi
echo "âœ… Claude is authenticated"
echo ""

# Check dependencies once per day (quietly) - skip in container if CI env var is set
LAST_DEP_CHECK_FILE=".last-dep-check"
# Use Eastern timezone as specified in TODAY.md
TODAY_DATE=$(TZ='America/New_York' date +%Y-%m-%d)

# Skip dependency check if running in container with limited network
if [ "$SKIP_DEP_CHECK" != "true" ]; then
    if [ ! -f "$LAST_DEP_CHECK_FILE" ] || [ "$(cat $LAST_DEP_CHECK_FILE 2>/dev/null)" != "$TODAY_DATE" ]; then
        echo "ğŸ” Checking for dependency updates (timeout in 10s)..."
        timeout 10 bin/update-deps --quiet || echo "âš ï¸  Dependency check timed out, continuing..."
        echo "$TODAY_DATE" > "$LAST_DEP_CHECK_FILE"
        echo ""
    fi
fi

# Run sync to update all data sources
echo "ğŸ”„ Syncing data sources..."
bin/sync

# Quick markdown lint check (non-blocking)
if command -v npx &> /dev/null && [ -f ".markdownlint.json" ]; then
    echo "ğŸ“ Checking markdown formatting..."
    # Run lint but don't block on errors, just show warnings
    npx markdownlint-cli2 'notes/reviews/*.md' 2>&1 | head -10 || true
    echo ""
fi

# Update the comprehensive summary with content and changes
echo "ğŸ“ Updating summary with content and changes..."
bin/update-summary

# Check if we successfully created the summary
if [ -f SUMMARY.json ]; then
    echo "âœ… Summary updated successfully"
    echo ""
    
    # Show the user what will happen
    REVIEW_FILE="notes/reviews/${TODAY_DATE}.md"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“ Review file: $REVIEW_FILE"
    echo ""
    echo "Starting interactive Claude session..."
    echo "Claude will:"
    echo "  â€¢ Analyze your SUMMARY.json data"
    echo "  â€¢ Create or update today's review file"
    echo "  â€¢ Provide recommendations"
    echo "  â€¢ Continue working with you as needed"
    echo ""
    echo "ğŸ’¡ Useful commands during the session:"
    echo "  bin/mark-done 'task'  # Mark task complete"
    echo "  bin/progress 'note'   # Add progress note"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    # Start interactive Claude session with TODAY.md
    echo "ğŸ¤– Starting Claude interactive session..."
    cat TODAY.md | claude
    
    # After Claude session ends
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… Claude session ended"
    echo ""
    echo "ğŸ“ Your review should be in: $REVIEW_FILE"
    echo ""
    echo "ğŸ’¡ Continue tracking progress with:"
    echo "   bin/mark-done 'task description'"
    echo "   bin/progress 'note'"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
else
    echo "âŒ Failed to create summary file"
    echo "Please check bin/sync and bin/update-summary for errors"
    exit 1
fi