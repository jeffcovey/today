#!/bin/bash

# Quick review script that syncs, updates summary, and pipes to Claude

# Load common dotenvx handler
source "$(dirname "$0")/lib/dotenvx-loader.sh"
auto_dotenvx "$@"

echo "ğŸ“Š Starting daily review process..."

# Check dependencies once per day (quietly) - skip in container if CI env var is set
LAST_DEP_CHECK_FILE=".last-dep-check"
TODAY_DATE=$(date +%Y-%m-%d)

# Skip dependency check if running in container with limited network
if [ "$SKIP_DEP_CHECK" != "true" ]; then
    if [ ! -f "$LAST_DEP_CHECK_FILE" ] || [ "$(cat $LAST_DEP_CHECK_FILE 2>/dev/null)" != "$TODAY_DATE" ]; then
        echo "ğŸ” Checking for dependency updates (timeout in 10s)..."
        timeout 10 bin/update-deps --quiet || echo "âš ï¸  Dependency check timed out, continuing..."
        echo "$TODAY_DATE" > "$LAST_DEP_CHECK_FILE"
        echo ""
    fi
fi

# Run sync to update all data sources
echo "ğŸ”„ Syncing data sources..."
bin/sync

# Update the comprehensive summary with content and changes
echo "ğŸ“ Updating summary with content and changes..."
bin/update-summary

# Check if we should include the summary in the review
if [ -f SUMMARY.json ]; then
    echo "âœ… Summary updated successfully"
    
    # Prepare review file paths
    TODAY_DATE=$(date +%Y-%m-%d)
    REVIEW_FILE="notes/reviews/${TODAY_DATE}.md"
    TIMESTAMP=$(date +"%H:%M")
    
    # Create a temporary file with both TODAY.md and summary info
    TEMP_FILE=$(mktemp)
    
    # Add TODAY.md content
    cat TODAY.md > "$TEMP_FILE"
    
    # Add comprehensive summary from SUMMARY.json
    echo "" >> "$TEMP_FILE"
    echo "## ğŸ“Š AI Summary and Analysis" >> "$TEMP_FILE"
    echo "The SUMMARY.json file contains comprehensive content and tracking data:" >> "$TEMP_FILE"
    echo '```json' >> "$TEMP_FILE"
    # Include the entire summary since it now has meaningful content
    cat SUMMARY.json >> "$TEMP_FILE" 2>/dev/null || echo "Unable to read summary" >> "$TEMP_FILE"
    echo '```' >> "$TEMP_FILE"
    
    # Add note about saving
    echo "" >> "$TEMP_FILE"
    echo "---" >> "$TEMP_FILE"
    echo "" >> "$TEMP_FILE"
    echo "## ğŸ“ Session Notes" >> "$TEMP_FILE"
    echo "" >> "$TEMP_FILE"
    echo "**Review file:** $REVIEW_FILE" >> "$TEMP_FILE"
    echo "**Time:** $TIMESTAMP" >> "$TEMP_FILE"
    echo "" >> "$TEMP_FILE"
    echo "### Important Instructions for Claude:" >> "$TEMP_FILE"
    echo "1. Format all tasks with checkboxes: - [ ] Task description" >> "$TEMP_FILE"
    echo "2. Or use numbered format: 1. **Task name** (time estimate)" >> "$TEMP_FILE"
    echo "3. Group tasks by time of day or category" >> "$TEMP_FILE"
    echo "4. If updating an existing review, check which tasks are marked done (âœ“)" >> "$TEMP_FILE"
    echo "5. Provide new recommendations based on completed tasks" >> "$TEMP_FILE"
    echo "" >> "$TEMP_FILE"
    echo "### Commands for the user:" >> "$TEMP_FILE"
    echo '```bash' >> "$TEMP_FILE"
    echo 'bin/mark-done "Take a 20-minute walk"  # Mark specific task as done' >> "$TEMP_FILE"
    echo 'bin/mark-done 1                        # Mark task #1 as done' >> "$TEMP_FILE"
    echo 'bin/progress "Additional note"         # Add a progress note' >> "$TEMP_FILE"
    echo '```' >> "$TEMP_FILE"
    
    # Create or prepare the review file header
    if [ ! -f "$REVIEW_FILE" ]; then
        mkdir -p notes/reviews
        {
            echo "# Daily Review - $(date +'%B %d, %Y')"
            echo ""
            echo "## Morning Review ($TIMESTAMP)"
            echo "*Generated by Claude via bin/today*"
            echo ""
            echo "### Initial Analysis"
            echo "*Copy key insights from Claude below:*"
            echo ""
            echo "---"
            echo ""
            echo "## Progress Log"
            echo "*Update throughout the day with completed tasks and notes*"
            echo ""
        } > "$REVIEW_FILE"
        echo "ğŸ“ Created new review file: $REVIEW_FILE"
    else
        {
            echo ""
            echo "---"
            echo ""
            echo "## Update ($TIMESTAMP)"
            echo "*Copy key insights from Claude below:*"
            echo ""
        } >> "$REVIEW_FILE"
        echo "ğŸ“ Appending to existing review: $REVIEW_FILE"
    fi
    
    echo "ğŸ¤– Starting interactive Claude session..."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ğŸ“ Review will be saved to: $REVIEW_FILE"
    echo "   (Click the path above to open the file)"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    # Run Claude interactively and capture output
    CLAUDE_OUTPUT=$(cat "$TEMP_FILE" | claude 2>&1 | tee /dev/tty)
    
    # Save Claude's analysis to the review file with timestamp
    if [ ! -z "$CLAUDE_OUTPUT" ]; then
        # Find the last "Update" section and replace it with Claude's output
        # Create a temporary file with the updated content
        TEMP_REVIEW=$(mktemp)
        
        # If this is a new file or first entry, just append
        if ! grep -q "^## Update" "$REVIEW_FILE" 2>/dev/null; then
            cat "$REVIEW_FILE" > "$TEMP_REVIEW"
            echo "" >> "$TEMP_REVIEW"
            echo "## Update ($TIMESTAMP)" >> "$TEMP_REVIEW"
            echo "" >> "$TEMP_REVIEW"
            echo "### Completed Since Last Review:" >> "$TEMP_REVIEW"
            grep "âœ“" "$REVIEW_FILE" | tail -5 >> "$TEMP_REVIEW" 2>/dev/null || echo "None yet" >> "$TEMP_REVIEW"
            echo "" >> "$TEMP_REVIEW"
            echo "### Claude's Updated Recommendations:" >> "$TEMP_REVIEW"
            echo "" >> "$TEMP_REVIEW"
            echo "$CLAUDE_OUTPUT" >> "$TEMP_REVIEW"
            echo "" >> "$TEMP_REVIEW"
            echo "---" >> "$TEMP_REVIEW"
        else
            # Find the last "Update" section and replace everything after it
            # Keep everything up to and including the last "Update" header
            awk '/^## Update \([0-9][0-9]:[0-9][0-9]\)$/ { found=NR } { lines[NR]=$0 } END { 
                if (found) {
                    for (i=1; i<=found; i++) print lines[i]
                } else {
                    for (i=1; i<=NR; i++) print lines[i]
                }
            }' "$REVIEW_FILE" > "$TEMP_REVIEW"
            
            # Add Claude's new analysis
            echo "*Claude's analysis:*" >> "$TEMP_REVIEW"
            echo "" >> "$TEMP_REVIEW"
            echo "$CLAUDE_OUTPUT" >> "$TEMP_REVIEW"
            echo "" >> "$TEMP_REVIEW"
            echo "---" >> "$TEMP_REVIEW"
        fi
        
        # Replace the review file with the updated content
        mv "$TEMP_REVIEW" "$REVIEW_FILE"
    fi
    
    # After Claude exits, remind about saving
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… Claude session ended"
    echo ""
    echo "ğŸ“ Claude's analysis has been saved to:"
    echo "   $REVIEW_FILE"
    echo ""
    echo "ğŸ’¡ Track your progress using:"
    echo "   bin/mark-done 'task description'  # Mark a task as complete"
    echo "   bin/mark-done 1                   # Mark task #1 as complete"
    echo "   bin/progress 'note'               # Add a general note"
    echo ""
    
    # Cleanup
    rm "$TEMP_FILE"
else
    # Fallback to original behavior
    echo "âš ï¸  No summary file found, using standard review"
    cat TODAY.md | claude
fi