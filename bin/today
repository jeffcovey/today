#!/bin/bash

# Quick review script that syncs, updates summary, and starts interactive Claude session
# Usage: bin/today [--no-sync] [optional direct request]
# Examples: 
#   bin/today "Let's work on the PS trip project"
#   bin/today --no-sync "Quick session without sync"
#   bin/today --no-sync

# Load common dotenvx handler
source "$(dirname "$0")/lib/dotenvx-loader.sh"
auto_dotenvx "$@"

# Parse arguments
SKIP_SYNC=false
DIRECT_REQUEST=""

# Check for --no-sync flag
for arg in "$@"; do
    case $arg in
        --no-sync)
            SKIP_SYNC=true
            shift
            ;;
        *)
            if [ -z "$DIRECT_REQUEST" ]; then
                DIRECT_REQUEST="$arg"
            fi
            ;;
    esac
done

if [ -n "$DIRECT_REQUEST" ]; then
    echo "ğŸ“Š Starting focused session: $DIRECT_REQUEST"
else
    echo "ğŸ“Š Starting daily review process..."
fi

if [ "$SKIP_SYNC" = true ]; then
    echo "âš ï¸  Skipping sync (--no-sync flag provided)"
fi

# Check if Claude CLI is authenticated by testing actual functionality
echo "ğŸ” Checking Claude authentication..."
TEST_RESPONSE=$(claude --print "Say 'ok'" 2>&1)
if echo "$TEST_RESPONSE" | grep -q "Invalid API key\|Please run /login\|not authenticated"; then
    echo ""
    echo "âš ï¸  Claude CLI is not authenticated!"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Claude is essential for daily reviews."
    echo "Please authenticate now by running:"
    echo ""
    echo "  claude"
    echo ""
    echo "Then follow the browser prompt to login."
    echo "After authentication, run 'bin/today' again."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    exit 1
fi
echo "âœ… Claude is authenticated"
echo ""

# Check dependencies once per day (quietly) - skip in container if CI env var is set
LAST_DEP_CHECK_FILE=".last-dep-check"
# Use Eastern timezone as specified in TODAY.md
TODAY_DATE=$(TZ='America/New_York' date +%Y-%m-%d)

# Skip dependency check if running in container with limited network
if [ "$SKIP_DEP_CHECK" != "true" ]; then
    if [ ! -f "$LAST_DEP_CHECK_FILE" ] || [ "$(cat $LAST_DEP_CHECK_FILE 2>/dev/null)" != "$TODAY_DATE" ]; then
        echo "ğŸ” Checking for dependency updates (timeout in 10s)..."
        timeout 10 bin/update-deps --quiet || echo "âš ï¸  Dependency check timed out, continuing..."
        echo "$TODAY_DATE" > "$LAST_DEP_CHECK_FILE"
        echo ""
    fi
fi

# Run sync to update all data sources (unless --no-sync flag provided)
if [ "$SKIP_SYNC" != true ]; then
    echo "ğŸ”„ Syncing data sources..."
    bin/sync
else
    echo "â­ï¸  Skipping sync step"
fi

# Quick markdown lint check (non-blocking)
if command -v npx &> /dev/null && [ -f ".markdownlint.json" ]; then
    echo "ğŸ“ Checking markdown formatting..."
    # Run lint but don't block on errors, just show warnings
    npx markdownlint-cli2 'vault/plans/*.md' 2>&1 | head -10 || true
    echo ""
fi

# Check if database exists and has data
DB_PATH=".data/today.db"
if [ ! -f "$DB_PATH" ]; then
    echo "âŒ Database not found at $DB_PATH"
    echo "Please run bin/sync to create and populate the database"
    exit 1
fi

# Quick check that database has recent data
LAST_SYNC=$(sqlite3 "$DB_PATH" "SELECT MAX(created_at) FROM sync_log" 2>/dev/null || echo "")
if [ -n "$LAST_SYNC" ]; then
    echo "âœ… Database ready (last sync: $LAST_SYNC)"
    echo ""
    
    # Show the user what will happen
    # Get date components for new naming scheme
    YEAR=$(date +%Y)
    MONTH=$(date +%m)  
    DAY=$(date +%d)
    # Determine quarter from month
    if [ $MONTH -le 3 ]; then Q="Q1"
    elif [ $MONTH -le 6 ]; then Q="Q2"
    elif [ $MONTH -le 9 ]; then Q="Q3"
    else Q="Q4"
    fi
    REVIEW_FILE="vault/plans/${YEAR}-${Q}-${MONTH}-${DAY}.md"
    
    if [ -n "$DIRECT_REQUEST" ]; then
        # Direct request mode - skip the full review
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“ Review file: $REVIEW_FILE"
        echo ""
        echo "Starting focused Claude session..."
        echo "Request: $DIRECT_REQUEST"
        echo ""
        echo "Claude will:"
        echo "  â€¢ Query the SQLite database for context"
        echo "  â€¢ Check today's review if it exists"
        echo "  â€¢ Focus on your specific request"
        echo ""
        echo "ğŸ’¡ Useful commands during the session:"
        echo "  bin/mark-done 'task'  # Mark task complete"
        echo "  bin/progress 'note'   # Add progress note"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        # Start interactive Claude session with direct request
        echo "ğŸ¤– Starting Claude focused session..."
        
        # Create a prompt that includes context but focuses on the request
        cat <<EOF | claude
# Focused Work Session

You have access to today's synchronized data in the SQLite database at .data/today.db. You can check the review file at ${REVIEW_FILE} if it exists.

## Context Available
- SQLite database at .data/today.db with all current data
- Today's date: ${TODAY_DATE}
- Review file location: ${REVIEW_FILE}

## Database Tables Available:
- task_cache: Tasks with titles, stages, due dates
- emails: Recent emails with subjects, senders, reply status
- calendar_events: Upcoming events with times, locations
- contacts: Contact information
- file_tracking: Recently modified files
- people_to_contact: People needing follow-up

## Direct Request from User
"${DIRECT_REQUEST}"

Please:
1. Query the database to understand current context
2. Check if today's review exists to understand what's been done
3. Focus on helping with the specific request above
4. You can reference relevant tasks, projects, or information from the database
5. This is an interactive session - continue helping as needed

Let's get started with the request!
EOF
    else
        # Normal review mode
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“ Review file: $REVIEW_FILE"
        echo ""
        echo "Starting interactive Claude session..."
        echo "Claude will:"
        echo "  â€¢ Query the SQLite database for all data"
        echo "  â€¢ Create or update today's review file"
        echo "  â€¢ Provide recommendations"
        echo "  â€¢ Continue working with you as needed"
        echo ""
        echo "ğŸ’¡ Useful commands during the session:"
        echo "  bin/mark-done 'task'  # Mark task complete"
        echo "  bin/progress 'note'   # Add progress note"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        # Start interactive Claude session with TODAY.md
        echo "ğŸ¤– Starting Claude interactive session..."
        cat TODAY.md | claude
    fi
    
    # After Claude session ends
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… Claude session ended"
    echo ""
    echo "ğŸ“ Your review should be in: $REVIEW_FILE"
    echo ""
    echo "ğŸ’¡ Continue tracking progress with:"
    echo "   bin/mark-done 'task description'"
    echo "   bin/progress 'note'"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
else
    echo "âŒ Database check failed"
    echo "Please check bin/sync for errors"
    exit 1
fi