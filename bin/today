#!/usr/bin/env node

/**
 * Today - Daily review and planning tool (bootstrap wrapper)
 *
 * This wrapper checks for dependencies before loading the main script.
 * Uses only Node built-ins to avoid import errors when deps are missing.
 */

import { existsSync, statSync } from 'fs';
import { dirname, join } from 'path';
import { execSync } from 'child_process';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const projectRoot = dirname(__dirname);

// Check if node_modules is missing or outdated (skip in tests)
if (!process.env.SKIP_DEP_CHECK) {
  const nodeModulesPath = join(projectRoot, 'node_modules');
  const packageJsonPath = join(projectRoot, 'package.json');
  const packageLockPath = join(projectRoot, 'package-lock.json');

  let needsInstall = false;
  let installReason = '';

  if (!existsSync(nodeModulesPath)) {
    needsInstall = true;
    installReason = 'Dependencies not installed';
  } else {
    // Check if package.json or package-lock.json is newer than node_modules
    const nodeModulesMtime = statSync(nodeModulesPath).mtimeMs;
    const packageJsonMtime = existsSync(packageJsonPath) ? statSync(packageJsonPath).mtimeMs : 0;
    const packageLockMtime = existsSync(packageLockPath) ? statSync(packageLockPath).mtimeMs : 0;

    if (packageJsonMtime > nodeModulesMtime || packageLockMtime > nodeModulesMtime) {
      needsInstall = true;
      installReason = 'Dependencies outdated (package files changed)';
    }
  }

  if (needsInstall) {
    console.log(`üì¶ ${installReason}. Running npm install...`);
    console.log('');
    try {
      execSync('npm install', { stdio: 'inherit', cwd: projectRoot });
      console.log('');
      console.log('‚úÖ Dependencies installed!');
      console.log('');
    } catch (e) {
      console.error('‚ùå Failed to install dependencies:', e.message);
      console.error('   Please run: npm install');
      process.exit(1);
    }
  }
}

// Now dynamically import the main script (deps are guaranteed to exist)
const mainScript = join(__dirname, 'today-main.js');
await import(mainScript);
