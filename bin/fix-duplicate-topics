#!/usr/bin/env node

// Fix duplicate topic tags in task titles
// This script removes [Topic] tags from task titles since topics are stored separately

import { TaskManager } from '../src/task-manager.js';
import chalk from 'chalk';

const tm = new TaskManager();

try {
  console.log(chalk.bold('\nüîß Fixing Duplicate Topic Tags\n'));
  
  // Get all tasks
  const tasks = tm.db.prepare('SELECT id, title FROM tasks').all();
  
  let fixed = 0;
  
  for (const task of tasks) {
    // Check if title contains topic tags
    const topicPattern = /\s*\[([^\]]+)\]/g;
    const matches = task.title.match(topicPattern);
    
    if (matches) {
      // Extract the clean title (without topic tags)
      const cleanTitle = task.title.replace(topicPattern, '').trim();
      
      // Update the task title
      tm.db.prepare('UPDATE tasks SET title = ? WHERE id = ?')
        .run(cleanTitle, task.id);
      
      console.log(chalk.green(`‚úì Fixed: ${task.title.substring(0, 50)}...`));
      console.log(chalk.gray(`  ‚Üí ${cleanTitle}`));
      fixed++;
    }
  }
  
  if (fixed > 0) {
    console.log(chalk.green(`\n‚úÖ Fixed ${fixed} task(s) with duplicate topic tags`));
  } else {
    console.log(chalk.gray('No tasks with topic tags in titles found'));
  }
  
} catch (error) {
  console.error(chalk.red('\n‚ùå Error:'), error.message);
  process.exit(1);
} finally {
  tm.close();
}