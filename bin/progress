#!/bin/bash

# Script to quickly add progress notes to today's review

# Load common dotenvx handler
source "$(dirname "$0")/lib/dotenvx-loader.sh"
auto_dotenvx "$@"

# Use timezone from config.toml
TZ_CONFIG=$(bin/get-config timezone)
TODAY_DATE=$(TZ=$TZ_CONFIG date +%Y-%m-%d)
YEAR=$(TZ=$TZ_CONFIG date +%Y)
MONTH=$(TZ=$TZ_CONFIG date +%m)
DAY=$(TZ=$TZ_CONFIG date +%d)
WEEK=$(TZ=$TZ_CONFIG date +%V)  # ISO week number
# Determine quarter from month
if [ $MONTH -le 3 ]; then Q="Q1"
elif [ $MONTH -le 6 ]; then Q="Q2"
elif [ $MONTH -le 9 ]; then Q="Q3"
else Q="Q4"
fi
REVIEW_FILE="vault/plans/${YEAR}_${Q}_${MONTH}_W${WEEK}_${DAY}.md"
TIMESTAMP=$(TZ=$TZ_CONFIG date +"%H:%M %Z")

# Check if review file exists
if [ ! -f "$REVIEW_FILE" ]; then
    echo "âŒ No review file for today. Run 'bin/today' first to create one."
    exit 1
fi

# If no arguments provided, open in editor
if [ $# -eq 0 ]; then
    # Try to find an editor
    if command -v code &> /dev/null; then
        code "$REVIEW_FILE"
    elif command -v nano &> /dev/null; then
        nano "$REVIEW_FILE"
    elif command -v vim &> /dev/null; then
        vim "$REVIEW_FILE"
    else
        echo "ðŸ“ Today's review: $REVIEW_FILE"
        echo "Please provide a progress note as an argument, or open the file manually"
    fi
else
    # Add progress note with timestamp
    echo "" >> "$REVIEW_FILE"
    echo "### Progress Update ($TIMESTAMP)" >> "$REVIEW_FILE"
    echo "$*" >> "$REVIEW_FILE"
    
    echo "âœ… Progress note added to $REVIEW_FILE"
    echo "   $TIMESTAMP: $*"
fi