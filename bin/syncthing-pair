#!/bin/bash

# Syncthing Device Pairing Helper
# Helps add remote devices and share folders

set -e

SYNCTHING_CONFIG_DIR="${HOME}/.config/syncthing"
SYNCTHING_PORT="${SYNCTHING_PORT:-8384}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_status() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

# Get API key
get_api_key() {
    if [ -f "${SYNCTHING_CONFIG_DIR}/config.xml" ]; then
        SYNCTHING_API_KEY=$(grep -oP '(?<=<apikey>)[^<]+' "${SYNCTHING_CONFIG_DIR}/config.xml")
        if [ -z "$SYNCTHING_API_KEY" ]; then
            print_error "Could not extract API key from config"
            return 1
        fi
    else
        print_error "Syncthing config not found"
        return 1
    fi
}

# Add a remote device
add_device() {
    local device_id="$1"
    local device_name="$2"
    
    if [ -z "$device_id" ] || [ -z "$device_name" ]; then
        print_error "Usage: $0 add-device <device-id> <device-name>"
        echo "Example: $0 add-device XXXXXXX-XXXXXXX-... \"My Laptop\""
        exit 1
    fi
    
    get_api_key || return 1
    
    print_status "Adding device: $device_name ($device_id)"
    
    # Create device configuration JSON
    cat > /tmp/syncthing-device.json <<EOF
{
    "deviceID": "$device_id",
    "name": "$device_name",
    "addresses": ["dynamic"],
    "compression": "metadata",
    "introducer": false,
    "paused": false,
    "allowedNetworks": [],
    "autoAcceptFolders": false
}
EOF
    
    # Add device via API
    curl -X POST -H "X-API-Key: ${SYNCTHING_API_KEY}" \
        -H "Content-Type: application/json" \
        -d @/tmp/syncthing-device.json \
        "http://localhost:${SYNCTHING_PORT}/rest/config/devices" \
        &> /dev/null
    
    rm /tmp/syncthing-device.json
    print_status "Device added successfully"
}

# Share a folder with a device
share_folder() {
    local folder_id="$1"
    local device_id="$2"
    
    if [ -z "$folder_id" ] || [ -z "$device_id" ]; then
        print_error "Usage: $0 share-folder <folder-id> <device-id>"
        echo "Example: $0 share-folder today-vault XXXXXXX-XXXXXXX-..."
        exit 1
    fi
    
    get_api_key || return 1
    
    print_status "Sharing folder '$folder_id' with device..."
    
    # Get current folder config
    FOLDER_CONFIG=$(curl -s -H "X-API-Key: ${SYNCTHING_API_KEY}" \
        "http://localhost:${SYNCTHING_PORT}/rest/config/folders/$folder_id")
    
    if [ -z "$FOLDER_CONFIG" ] || [ "$FOLDER_CONFIG" = "null" ]; then
        print_error "Folder '$folder_id' not found"
        return 1
    fi
    
    # Add device to folder's device list
    UPDATED_CONFIG=$(echo "$FOLDER_CONFIG" | jq ".devices += [{\"deviceID\": \"$device_id\", \"introducedBy\": \"\", \"encryptionPassword\": \"\"}]")
    
    # Update folder config
    echo "$UPDATED_CONFIG" | curl -X PUT -H "X-API-Key: ${SYNCTHING_API_KEY}" \
        -H "Content-Type: application/json" \
        -d @- \
        "http://localhost:${SYNCTHING_PORT}/rest/config/folders/$folder_id" \
        &> /dev/null
    
    print_status "Folder shared successfully"
}

# List current devices
list_devices() {
    get_api_key || return 1
    
    echo "Current devices:"
    curl -s -H "X-API-Key: ${SYNCTHING_API_KEY}" \
        "http://localhost:${SYNCTHING_PORT}/rest/config/devices" | \
        jq -r '.[] | "\(.name) (\(.deviceID[0:7])-...)"'
}

# List current folders
list_folders() {
    get_api_key || return 1
    
    echo "Current folders:"
    curl -s -H "X-API-Key: ${SYNCTHING_API_KEY}" \
        "http://localhost:${SYNCTHING_PORT}/rest/config/folders" | \
        jq -r '.[] | "\(.label) [id: \(.id), path: \(.path)]"'
}

# Restart Syncthing to apply changes
restart_syncthing() {
    get_api_key || return 1
    
    print_status "Restarting Syncthing to apply changes..."
    curl -X POST -H "X-API-Key: ${SYNCTHING_API_KEY}" \
        "http://localhost:${SYNCTHING_PORT}/rest/system/restart" \
        &> /dev/null
    
    sleep 3
    print_status "Syncthing restarted"
}

# Main command handling
case "${1:-}" in
    add-device)
        add_device "$2" "$3"
        restart_syncthing
        ;;
    share-folder)
        share_folder "$2" "$3"
        restart_syncthing
        ;;
    list-devices)
        list_devices
        ;;
    list-folders)
        list_folders
        ;;
    *)
        echo "Syncthing Pairing Helper"
        echo ""
        echo "Usage: $0 {add-device|share-folder|list-devices|list-folders}"
        echo ""
        echo "Commands:"
        echo "  add-device <device-id> <name>    - Add a remote device"
        echo "  share-folder <folder-id> <device-id> - Share a folder with a device"
        echo "  list-devices                      - List configured devices"
        echo "  list-folders                      - List configured folders"
        echo ""
        echo "Example workflow:"
        echo "  1. $0 add-device XXXXXXX-XXXXXXX-... \"My Laptop\""
        echo "  2. $0 share-folder today-vault XXXXXXX-XXXXXXX-..."
        exit 1
        ;;
esac