#!/bin/bash
# Monitoring script with alerts for droplet health
# Sends alerts via the inbox API when thresholds are exceeded

set -e

# Configuration
DISK_ALERT_PERCENT=90
LOAD_ALERT_THRESHOLD=6
MEMORY_ALERT_PERCENT=90

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

# Get current metrics
DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
LOAD_1MIN=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | sed 's/,//')
LOAD_INT=$(echo "$LOAD_1MIN" | cut -d. -f1)
MEM_PERCENT=$(free | grep Mem | awk '{printf "%.0f", $3/$2 * 100}')
HOSTNAME=$(hostname)

# Check if running on droplet
if [ ! -f /opt/today/.inbox-api-key ] && [ ! -f .env ]; then
    echo "Not running on droplet or in dev environment"
    exit 1
fi

# Function to send alert
send_alert() {
    local severity=$1
    local message=$2

    # Create alert content
    local alert_content="ðŸš¨ DROPLET ALERT [$severity]

$message

Host: $HOSTNAME
Time: $(date '+%Y-%m-%d %H:%M:%S')
"

    # Try to send via inbox API if available
    if [ -f /opt/today/.inbox-api-key ]; then
        source /opt/today/.inbox-api-key
        # DEPLOY_DOMAIN should be set in environment
        DEPLOY_DOMAIN="${DEPLOY_DOMAIN:-localhost}"
        curl -s -X POST "https://${DEPLOY_DOMAIN}/api/inbox/upload" \
            -H "X-API-Key: $INBOX_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"content\": \"$alert_content\"}" > /dev/null 2>&1 || true
    fi

    # Also log to syslog
    logger -t "droplet-monitor" -p "daemon.$severity" "$message"

    # Print to console
    if [ "$severity" = "crit" ]; then
        echo -e "${RED}[CRITICAL]${NC} $message"
    elif [ "$severity" = "warning" ]; then
        echo -e "${YELLOW}[WARNING]${NC} $message"
    else
        echo -e "${GREEN}[INFO]${NC} $message"
    fi
}

# Check disk usage
if [ "$DISK_USAGE" -ge "$DISK_ALERT_PERCENT" ]; then
    send_alert "crit" "Disk usage critical: ${DISK_USAGE}% (threshold: ${DISK_ALERT_PERCENT}%)"

    # Try emergency cleanup
    echo "Running emergency cleanup..."
    if [ -x /opt/today/bin/droplet-maintenance ]; then
        /opt/today/bin/droplet-maintenance
    fi
elif [ "$DISK_USAGE" -ge 85 ]; then
    send_alert "warning" "Disk usage high: ${DISK_USAGE}%"
fi

# Check load average
if [ "$LOAD_INT" -ge "$LOAD_ALERT_THRESHOLD" ]; then
    # Get top processes
    TOP_PROCS=$(ps aux --sort=-%cpu | head -6 | tail -5 | awk '{printf "%s: %.1f%%\n", $11, $3}')
    send_alert "crit" "High load average: $LOAD_1MIN (threshold: $LOAD_ALERT_THRESHOLD)

Top CPU processes:
$TOP_PROCS"

    # Check for stuck processes
    STUCK_COUNT=$(ps aux | grep -E 'node.*bin/today.*--non-interactive' | grep -v grep | wc -l)
    if [ "$STUCK_COUNT" -gt 0 ]; then
        send_alert "warning" "Found $STUCK_COUNT stuck bin/today processes - running cleanup"
        ps aux | grep -E 'node.*bin/today.*--non-interactive' | grep -v grep | awk '{print $2}' | xargs -r kill -9
    fi
elif [ "$LOAD_INT" -ge 4 ]; then
    send_alert "warning" "Load average elevated: $LOAD_1MIN"
fi

# Check memory usage
if [ "$MEM_PERCENT" -ge "$MEMORY_ALERT_PERCENT" ]; then
    # Get top memory processes
    TOP_MEM=$(ps aux --sort=-%mem | head -6 | tail -5 | awk '{printf "%s: %.1f%%\n", $11, $4}')
    send_alert "crit" "Memory usage critical: ${MEM_PERCENT}% (threshold: ${MEMORY_ALERT_PERCENT}%)

Top memory processes:
$TOP_MEM"
elif [ "$MEM_PERCENT" -ge 85 ]; then
    send_alert "warning" "Memory usage high: ${MEM_PERCENT}%"
fi

# Check services
for SERVICE in today-scheduler vault-watcher vault-api inbox-api; do
    if systemctl is-enabled "$SERVICE" > /dev/null 2>&1; then
        if ! systemctl is-active "$SERVICE" > /dev/null 2>&1; then
            send_alert "crit" "Service $SERVICE is not running!"
            # Try to restart
            systemctl restart "$SERVICE" 2>/dev/null || true
            sleep 2
            if systemctl is-active "$SERVICE" > /dev/null 2>&1; then
                send_alert "info" "Service $SERVICE restarted successfully"
            fi
        fi
    fi
done

# Summary output (only if running interactively)
if [ -t 1 ]; then
    echo ""
    echo "ðŸ“Š System Status:"
    echo "  Disk: ${DISK_USAGE}%"
    echo "  Load: $LOAD_1MIN"
    echo "  Memory: ${MEM_PERCENT}%"

    if [ "$DISK_USAGE" -lt 85 ] && [ "$LOAD_INT" -lt 4 ] && [ "$MEM_PERCENT" -lt 85 ]; then
        echo -e "  ${GREEN}âœ“ All systems normal${NC}"
    fi
fi