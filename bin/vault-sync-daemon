#!/bin/bash
# Simple daemon to sync vault every 5 minutes

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
LOG_FILE="/tmp/vault-sync-daemon.log"
PID_FILE="/tmp/vault-sync-daemon.pid"
INTERVAL=300  # 5 minutes in seconds

# Check if already running
if [ -f "$PID_FILE" ]; then
    OLD_PID=$(cat "$PID_FILE")
    if ps -p "$OLD_PID" > /dev/null 2>&1; then
        echo "Vault sync daemon already running (PID: $OLD_PID)"
        exit 0
    fi
fi

# Write PID
echo $$ > "$PID_FILE"

# Cleanup on exit
trap "rm -f $PID_FILE; exit" INT TERM EXIT

echo "[$(date)] Vault sync daemon started (PID: $$)" >> "$LOG_FILE"
echo "Vault sync daemon started (PID: $$)"
echo "Syncing every 5 minutes. Logs at: $LOG_FILE"

while true; do
    # Wait first, then sync (so we don't sync immediately on startup)
    sleep $INTERVAL
    
    echo "[$(date)] Running vault sync..." >> "$LOG_FILE"
    cd "$PROJECT_DIR" || exit 1
    
    # Run the sync quietly
    if bin/vault-sync sync >> "$LOG_FILE" 2>&1; then
        echo "[$(date)] Sync completed successfully" >> "$LOG_FILE"
    else
        echo "[$(date)] Sync failed" >> "$LOG_FILE"
    fi
    
    # Keep log file from growing too large
    tail -n 1000 "$LOG_FILE" > "$LOG_FILE.tmp" && mv "$LOG_FILE.tmp" "$LOG_FILE"
done