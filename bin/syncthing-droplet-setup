#!/bin/bash

# Syncthing Setup for Droplet
# Generates a unique device ID for the droplet and configures known devices

set -e

SYNCTHING_CONFIG_DIR="${HOME}/.config/syncthing"
SYNCTHING_PORT="${SYNCTHING_PORT:-8384}"

# Known device IDs
MACBOOK_ID="NFKKNCL-DOI4RVX-OD3FVOT-EXLVTW4-IJU33XQ-3IF6OA6-AEPXGCS-KXVNTAU"
CONTAINER_ID="MP3GVPA-JXGKQ4A-ZPYRC7U-NWOZLZF-55CL6VY-ZWPQVMB-7UGV5I4-XU7GBAU"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_status() {
    echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

# Install Syncthing if not present
if ! command -v syncthing &> /dev/null; then
    print_status "Installing Syncthing..."
    
    # Add Syncthing repo and install
    curl -s https://syncthing.net/release-key.txt | sudo apt-key add -
    echo "deb https://apt.syncthing.net/ syncthing stable" | sudo tee /etc/apt/sources.list.d/syncthing.list
    sudo apt-get update
    sudo apt-get install -y syncthing
fi

# Generate config if it doesn't exist (creates unique device ID)
if [ ! -f "${SYNCTHING_CONFIG_DIR}/config.xml" ]; then
    print_status "Generating unique Syncthing configuration for droplet..."
    syncthing generate
fi

# Start Syncthing temporarily to configure it
print_status "Starting Syncthing for configuration..."
syncthing serve --no-browser --no-restart --logflags=0 &
SYNCTHING_PID=$!
sleep 5

# Get API key
SYNCTHING_API_KEY=$(grep -oP '(?<=<apikey>)[^<]+' "${SYNCTHING_CONFIG_DIR}/config.xml")

# Get this droplet's unique device ID
DROPLET_ID=$(syncthing -device-id)
echo ""
print_status "Droplet Device ID: ${DROPLET_ID}"

# Disable GUI authentication for headless access
print_warning "Configuring for headless access..."
curl -X PATCH -H "X-API-Key: ${SYNCTHING_API_KEY}" \
    -H "Content-Type: application/json" \
    -d '{"gui": {"user": "", "password": ""}}' \
    "http://localhost:${SYNCTHING_PORT}/rest/config/gui" \
    &> /dev/null

# Add vault folder
print_status "Adding vault folder..."
curl -X POST -H "X-API-Key: ${SYNCTHING_API_KEY}" \
    -H "Content-Type: application/json" \
    -d '{
        "id": "today-vault",
        "label": "Today Vault",
        "path": "/opt/today/vault",
        "type": "sendreceive",
        "devices": [],
        "rescanIntervalS": 60,
        "fsWatcherEnabled": true,
        "fsWatcherDelayS": 10,
        "ignorePerms": false,
        "autoNormalize": true,
        "paused": false
    }' \
    "http://localhost:${SYNCTHING_PORT}/rest/config/folders" \
    &> /dev/null || true

# Add known devices
print_status "Adding known devices..."

# Add MacBook
curl -X POST -H "X-API-Key: ${SYNCTHING_API_KEY}" \
    -H "Content-Type: application/json" \
    -d "{
        \"deviceID\": \"${MACBOOK_ID}\",
        \"name\": \"MacBook\",
        \"addresses\": [\"dynamic\"],
        \"compression\": \"metadata\",
        \"introducer\": false,
        \"paused\": false,
        \"allowedNetworks\": [],
        \"autoAcceptFolders\": false
    }" \
    "http://localhost:${SYNCTHING_PORT}/rest/config/devices" \
    &> /dev/null || true

# Add Container
curl -X POST -H "X-API-Key: ${SYNCTHING_API_KEY}" \
    -H "Content-Type: application/json" \
    -d "{
        \"deviceID\": \"${CONTAINER_ID}\",
        \"name\": \"DevContainer\",
        \"addresses\": [\"dynamic\"],
        \"compression\": \"metadata\",
        \"introducer\": false,
        \"paused\": false,
        \"allowedNetworks\": [],
        \"autoAcceptFolders\": false
    }" \
    "http://localhost:${SYNCTHING_PORT}/rest/config/devices" \
    &> /dev/null || true

# Share vault folder with all devices
print_status "Sharing vault folder with all devices..."

# Get folder config
FOLDER_CONFIG=$(curl -s -H "X-API-Key: ${SYNCTHING_API_KEY}" \
    "http://localhost:${SYNCTHING_PORT}/rest/config/folders/today-vault")

# Add all devices to folder
if [ "$FOLDER_CONFIG" != "null" ] && [ -n "$FOLDER_CONFIG" ]; then
    UPDATED_CONFIG=$(echo "$FOLDER_CONFIG" | jq ".devices = [
        {\"deviceID\": \"${DROPLET_ID}\", \"introducedBy\": \"\", \"encryptionPassword\": \"\"},
        {\"deviceID\": \"${MACBOOK_ID}\", \"introducedBy\": \"\", \"encryptionPassword\": \"\"},
        {\"deviceID\": \"${CONTAINER_ID}\", \"introducedBy\": \"\", \"encryptionPassword\": \"\"}
    ]")
    
    echo "$UPDATED_CONFIG" | curl -X PUT -H "X-API-Key: ${SYNCTHING_API_KEY}" \
        -H "Content-Type: application/json" \
        -d @- \
        "http://localhost:${SYNCTHING_PORT}/rest/config/folders/today-vault" \
        &> /dev/null
fi

# Create systemd service
print_status "Creating systemd service..."
sudo tee /etc/systemd/system/syncthing.service > /dev/null <<EOF
[Unit]
Description=Syncthing - Open Source Continuous File Synchronization
Documentation=man:syncthing(1)
After=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/bin/syncthing serve --no-browser --no-restart --logflags=0
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

# Stop temporary instance and start service
kill $SYNCTHING_PID 2>/dev/null || true
sleep 2

sudo systemctl daemon-reload
sudo systemctl enable syncthing
sudo systemctl start syncthing

print_status "Syncthing service started"

echo ""
echo "=========================================="
echo "Syncthing setup complete!"
echo ""
echo "Droplet Device ID: ${DROPLET_ID}"
echo ""
echo "Known devices configured:"
echo "  - MacBook: ${MACBOOK_ID:0:7}..."
echo "  - DevContainer: ${CONTAINER_ID:0:7}..."
echo ""
echo "Access Syncthing at: http://$(hostname -I | awk '{print $1}'):${SYNCTHING_PORT}"
echo "=========================================="