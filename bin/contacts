#!/usr/bin/env node

// Contacts CLI - queries contacts from plugin system
import { autoDotenvx } from './lib/dotenvx-loader.js';
autoDotenvx();

import { getDatabase } from '../src/database-service.js';
import { ensureSyncForType, getSyncStatusMessage } from '../src/plugin-loader.js';
import { getTodayDate } from '../src/date-utils.js';
import { program } from 'commander';
import { colors } from '../src/cli-utils.js';
import { execSync } from 'child_process';

// Quiet sync - ensures database is current before read operations
function ensureSync(db) {
  ensureSyncForType(db, 'contacts');
}

// Check if contacts table exists
function contactsTableExists(db) {
  try {
    db.prepare("SELECT 1 FROM contacts LIMIT 1").get();
    return true;
  } catch (error) {
    if (error.code === 'SQLITE_ERROR' && error.message.includes('no such table')) {
      return false;
    }
    throw error;
  }
}

// Get contacts from database
function getAllContacts(db) {
  if (!contactsTableExists(db)) {
    return [];
  }
  return db.prepare(`
    SELECT id, source, full_name, first_name, last_name,
           organization, primary_email, primary_phone,
           birthday, notes, created_at
    FROM contacts
    ORDER BY full_name
  `).all();
}

// Get birthdays for next N days
function getUpcomingBirthdays(db, days = 7) {
  if (!contactsTableExists(db)) {
    return [];
  }

  const events = [];
  const today = new Date();

  for (let i = 0; i < days; i++) {
    const checkDate = new Date(today);
    checkDate.setDate(today.getDate() + i);
    const monthDay = `${String(checkDate.getMonth() + 1).padStart(2, '0')}-${String(checkDate.getDate()).padStart(2, '0')}`;

    const dayEvents = db.prepare(`
      SELECT full_name, birthday, organization, primary_email, primary_phone
      FROM contacts
      WHERE birthday LIKE '%${monthDay}'
    `).all();

    if (dayEvents.length > 0) {
      events.push({
        date: checkDate.toISOString().split('T')[0],
        dayLabel: checkDate.toDateString(),
        contacts: dayEvents
      });
    }
  }

  return events;
}

// Get birthdays for specific date
function getBirthdaysForDate(db, targetDate) {
  if (!contactsTableExists(db)) {
    return [];
  }

  const date = new Date(targetDate);
  const monthDay = `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

  return db.prepare(`
    SELECT full_name, birthday, organization, primary_email, primary_phone
    FROM contacts
    WHERE birthday LIKE '%${monthDay}'
    ORDER BY full_name
  `).all();
}

// Search contacts
function searchContacts(db, query) {
  if (!contactsTableExists(db)) {
    return [];
  }

  const searchTerm = `%${query.toLowerCase()}%`;

  return db.prepare(`
    SELECT full_name, organization, primary_email, primary_phone, birthday, notes
    FROM contacts
    WHERE LOWER(full_name) LIKE ?
       OR LOWER(organization) LIKE ?
       OR LOWER(notes) LIKE ?
    ORDER BY full_name
    LIMIT 20
  `).all(searchTerm, searchTerm, searchTerm);
}

// Display contact with details
function displayContact(contact) {
  console.log(`${colors.bold(contact.full_name || 'Unknown')}`);
  if (contact.organization) {
    console.log(`  ${colors.gray('Organization:')} ${contact.organization}`);
  }
  if (contact.primary_email) {
    console.log(`  ${colors.gray('Email:')} ${contact.primary_email}`);
  }
  if (contact.primary_phone) {
    console.log(`  ${colors.gray('Phone:')} ${contact.primary_phone}`);
  }
  if (contact.birthday) {
    console.log(`  ${colors.gray('Birthday:')} ${contact.birthday}`);
  }
  if (contact.notes && contact.notes.length > 0) {
    const shortNotes = contact.notes.length > 100
      ? contact.notes.substring(0, 100) + '...'
      : contact.notes;
    console.log(`  ${colors.gray('Notes:')} ${shortNotes}`);
  }
}

// Commands
async function cmdSync() {
  console.log(colors.blue('â„¹') + ' Syncing contacts plugins to database...');

  try {
    const result = execSync('bin/plugins sync --type contacts', { encoding: 'utf8' });
    const lines = result.split('\n').filter(l => !l.includes('[dotenvx'));
    console.log(lines.join('\n'));
  } catch (error) {
    if (error.stdout?.includes('No plugins of type')) {
      console.log(colors.yellow('âš ') + ' No contacts plugins are enabled.');
      console.log('');
      console.log('To sync contacts, configure a plugin:');
      console.log('');
      console.log('  ' + colors.cyan('bin/plugins configure'));
    } else {
      console.error(colors.red('âœ—') + ' Sync failed:', error.message);
      process.exit(1);
    }
  }
}

async function cmdBirthdays(db, options) {
  ensureSync(db);

  if (options.date) {
    const contacts = getBirthdaysForDate(db, options.date);
    if (contacts.length === 0) {
      const dateStr = new Date(options.date).toDateString();
      console.log(colors.blue('â„¹') + ` No birthdays on ${dateStr}.`);
      return;
    }

    const dateStr = new Date(options.date).toDateString();
    console.log(colors.bold(`ðŸŽ‚ Birthdays on ${dateStr}:\n`));
    contacts.forEach(contact => {
      displayContact(contact);
      console.log('');
    });
  } else {
    const days = options.days || 7;
    const events = getUpcomingBirthdays(db, days);

    if (events.length === 0) {
      console.log(colors.blue('â„¹') + ` No birthdays in the next ${days} days.`);
      return;
    }

    console.log(colors.bold(`ðŸŽ‚ Upcoming Birthdays (Next ${days} Days):\n`));
    events.forEach(dayEvent => {
      console.log(colors.bold(dayEvent.dayLabel + ':'));
      dayEvent.contacts.forEach(contact => {
        console.log(`  ðŸŽ‚ ${colors.bold(contact.full_name)}`);
        if (contact.organization) console.log(`     ${colors.gray(contact.organization)}`);
      });
      console.log('');
    });
  }

  console.log(getSyncStatusMessage(db, 'contacts'));
}

async function cmdList(db, options = {}) {
  ensureSync(db);

  const contacts = getAllContacts(db);

  if (contacts.length === 0) {
    console.log(colors.blue('â„¹') + ' No contacts found.');
    console.log('');
    console.log('Sync contacts first: ' + colors.cyan('bin/contacts sync'));
    return;
  }

  console.log(colors.bold(`ðŸ“‡ All Contacts (${contacts.length}):\n`));

  const limit = options.limit || 20;
  const displayed = contacts.slice(0, limit);

  displayed.forEach(contact => {
    console.log(`${colors.bold(contact.full_name)}`);
    if (contact.organization) console.log(`  ${colors.gray(contact.organization)}`);
    if (contact.primary_email) console.log(`  ${colors.gray(contact.primary_email)}`);
    console.log('');
  });

  if (contacts.length > limit) {
    console.log(colors.gray(`... and ${contacts.length - limit} more contacts`));
    console.log(colors.gray(`Use --limit option to show more`));
    console.log('');
  }

  console.log(getSyncStatusMessage(db, 'contacts'));
}

async function cmdSearch(db, query) {
  ensureSync(db);

  const contacts = searchContacts(db, query);

  if (contacts.length === 0) {
    console.log(colors.blue('â„¹') + ` No contacts matching "${query}".`);
    return;
  }

  console.log(colors.bold(`ðŸ” Search Results for "${query}" (${contacts.length}):\n`));

  contacts.forEach(contact => {
    displayContact(contact);
    console.log('');
  });

  console.log(getSyncStatusMessage(db, 'contacts'));
}

async function cmdStats(db) {
  ensureSync(db);

  if (!contactsTableExists(db)) {
    console.log(colors.blue('â„¹') + ' No contacts plugins enabled.');
    console.log('');
    console.log('To view contact statistics, configure a plugin:');
    console.log('');
    console.log('  ' + colors.cyan('bin/plugins configure'));
    return;
  }

  const stats = db.prepare(`
    SELECT
      COUNT(*) as total,
      COUNT(CASE WHEN birthday IS NOT NULL THEN 1 END) as with_birthday,
      COUNT(CASE WHEN primary_email IS NOT NULL THEN 1 END) as with_email,
      COUNT(CASE WHEN primary_phone IS NOT NULL THEN 1 END) as with_phone,
      COUNT(CASE WHEN organization IS NOT NULL THEN 1 END) as with_organization,
      COUNT(CASE WHEN notes IS NOT NULL AND notes != '' THEN 1 END) as with_notes
    FROM contacts
  `).get();

  console.log(colors.bold('\nðŸ“Š Contact Statistics:'));
  console.log(`   Total contacts: ${stats.total}`);
  console.log(`   With birthday: ${stats.with_birthday}`);
  console.log(`   With email: ${stats.with_email}`);
  console.log(`   With phone: ${stats.with_phone}`);
  console.log(`   With organization: ${stats.with_organization}`);
  console.log(`   With notes: ${stats.with_notes}`);
  console.log('');

  console.log(getSyncStatusMessage(db, 'contacts'));
}

// Default command - show summary
async function cmdSummary(db) {
  ensureSync(db);

  if (!contactsTableExists(db)) {
    console.log(colors.blue('â„¹') + ' No contacts plugins enabled. Run ' + colors.cyan('bin/plugins configure') + ' to set up contacts.');
    return;
  }

  const total = db.prepare('SELECT COUNT(*) as count FROM contacts').get().count;
  if (total === 0) {
    console.log(colors.blue('â„¹') + ' No contacts found. Run ' + colors.cyan('bin/contacts sync') + ' to import contacts.');
    return;
  }

  console.log(colors.bold('ðŸ“‡ Contact Summary\n'));

  // Show upcoming birthdays (next 7 days)
  const upcomingBirthdays = getUpcomingBirthdays(db, 7);
  if (upcomingBirthdays.length > 0) {
    console.log(colors.bold('ðŸŽ‚ Upcoming Birthdays (Next 7 Days):'));
    upcomingBirthdays.slice(0, 3).forEach(dayEvent => {
      console.log(`  ${colors.bold(dayEvent.dayLabel)}:`);
      dayEvent.contacts.forEach(contact => {
        console.log(`    ðŸŽ‚ ${contact.full_name}`);
      });
    });

    if (upcomingBirthdays.length > 3) {
      const moreCount = upcomingBirthdays.slice(3).reduce((sum, day) => sum + day.contacts.length, 0);
      console.log(`    ... and ${moreCount} more birthdays`);
    }
    console.log('');
  }

  console.log(colors.gray(`ðŸ“Š ${total} total contacts`));

  if (upcomingBirthdays.length === 0) {
    console.log(colors.green('âœ… No upcoming birthdays in the next 7 days'));
  }

  console.log('');
  console.log(colors.gray('Commands: birthday, list, search, sync, stats'));
  console.log(getSyncStatusMessage(db, 'contacts'));
}

// Commander setup
const db = getDatabase();

program
  .name('contacts')
  .description('Contact management for Today system');

program
  .command('summary', { isDefault: true })
  .description('Show contact summary (default)')
  .action(async () => {
    await cmdSummary(db);
  });

program
  .command('sync')
  .description('Sync contacts via plugin system')
  .action(async () => {
    await cmdSync();
  });

program
  .command('birthday')
  .aliases(['birthdays'])
  .description('Show upcoming birthdays')
  .option('--days <days>', 'Number of days to look ahead', parseInt, 7)
  .option('--date <date>', 'Show birthdays for specific date (YYYY-MM-DD)')
  .action(async (options) => {
    await cmdBirthdays(db, options);
  });

program
  .command('list')
  .description('List all contacts')
  .option('--limit <limit>', 'Maximum number of contacts to show', parseInt, 20)
  .action(async (options) => {
    await cmdList(db, options);
  });

program
  .command('search <query>')
  .description('Search contacts by name, organization, or notes')
  .action(async (query) => {
    await cmdSearch(db, query);
  });

program
  .command('stats')
  .description('Show contact statistics')
  .action(async () => {
    await cmdStats(db);
  });

// Handle --date option at top level (used by bin/today for historical queries)
const dateArgIdx = process.argv.findIndex(a => a === '--date');
if (dateArgIdx > 0 && process.argv[dateArgIdx + 1]) {
  const targetDate = process.argv[dateArgIdx + 1];
  ensureSync(db);

  const birthdays = getBirthdaysForDate(db, targetDate);
  if (birthdays.length === 0) {
    console.log(`No birthdays for ${targetDate}`);
  } else {
    console.log('Birthdays:');
    birthdays.forEach(contact => {
      console.log(`  ðŸŽ‚ ${contact.full_name}`);
    });
  }
  process.exit(0);
}

program.parse();
