#!/bin/bash
# Unified setup script for various development environment configurations
set -e

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${GREEN}$1${NC}"
}

print_error() {
    echo -e "${RED}$1${NC}"
}

print_warning() {
    echo -e "${YELLOW}$1${NC}"
}

# Function to show usage
show_help() {
    cat << EOF
Usage: setup [OPTION]
Unified setup script for development environment configurations

Options:
    --ssh                Setup SSH server for remote access
    --tailscale         Setup Tailscale VPN for secure connectivity
    --tailscale-hostname Configure Tailscale hostname
    --all               Run all setup tasks
    --help              Display this help message

Examples:
    setup --ssh          # Setup SSH server only
    setup --tailscale    # Setup Tailscale only
    setup --all          # Run all setups

EOF
}

# SSH Setup Function
setup_ssh() {
    print_status "Setting up SSH server for VS Code Remote SSH..."
    
    # Generate SSH host keys if they don't exist
    if [ ! -f /etc/ssh/ssh_host_rsa_key ]; then
        echo "Generating SSH host keys..."
        sudo ssh-keygen -A
    fi
    
    # Create SSH key pair for the user if it doesn't exist
    if [ ! -f /home/node/.ssh/id_rsa ]; then
        echo "Generating SSH key pair for user 'node'..."
        mkdir -p /home/node/.ssh
        ssh-keygen -t rsa -b 4096 -f /home/node/.ssh/id_rsa -N "" -C "devcontainer-$(hostname)"
        
        # Set up authorized_keys for passwordless login
        cp /home/node/.ssh/id_rsa.pub /home/node/.ssh/authorized_keys
        chmod 600 /home/node/.ssh/authorized_keys
        chmod 700 /home/node/.ssh
        chown -R node:node /home/node/.ssh
    fi
    
    # Configure SSH daemon
    sudo tee /etc/ssh/sshd_config.d/devcontainer.conf > /dev/null << 'EOF'
# Dev container SSH configuration
Port 2222
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
X11Forwarding yes
PrintMotd no
AcceptEnv LANG LC_*
Subsystem sftp /usr/lib/openssh/sftp-server
EOF
    
    # Start SSH service
    echo "Starting SSH daemon..."
    sudo service ssh start
    
    print_status "‚úÖ SSH server setup complete!"
    echo ""
    echo "To connect from VS Code:"
    echo "1. Add this to your local ~/.ssh/config:"
    echo "   Host devcontainer"
    echo "   HostName <container-ip>"
    echo "   Port 2222"
    echo "   User node"
    echo ""
}

# Tailscale Setup Function
setup_tailscale() {
    print_status "Setting up Tailscale for remote access..."
    echo ""
    
    # Check if Tailscale is installed
    if ! command -v tailscale &> /dev/null; then
        print_error "‚ùå Tailscale is not installed!"
        echo "Please rebuild the devcontainer to install Tailscale."
        return 1
    fi
    
    # Check Tailscale status
    STATUS=$(tailscale status --json 2>/dev/null || echo "{}")
    
    if echo "$STATUS" | grep -q '"BackendState":"Running"'; then
        print_status "‚úÖ Tailscale is already running!"
        
        # Get the Tailscale IP
        TAILSCALE_IP=$(tailscale ip -4 2>/dev/null || echo "Not available")
        HOSTNAME=$(hostname)
        
        echo ""
        echo "üì± Connection Information:"
        echo "=========================="
        echo "Tailscale IP: $TAILSCALE_IP"
        echo "Hostname: $HOSTNAME"
        echo ""
        echo "SSH Access: ssh node@$TAILSCALE_IP -p 2222"
        echo ""
    else
        print_warning "‚ö†Ô∏è  Tailscale needs authentication"
        echo ""
        
        # Check for authkey
        if [ -n "$TAILSCALE_AUTHKEY" ]; then
            echo "Using provided auth key..."
            sudo tailscale up --authkey="$TAILSCALE_AUTHKEY" --ssh
        else
            echo "To set up Tailscale, you have two options:"
            echo ""
            echo "Option 1: Interactive Login (Recommended for first time)"
            echo "  Run: sudo tailscale up --ssh"
            echo "  This will provide a URL to authenticate"
            echo ""
            echo "Option 2: Auth Key (For automated setup)"
            echo "  Set TAILSCALE_AUTHKEY environment variable"
            echo "  Then run this setup again"
        fi
    fi
}

# Tailscale Hostname Setup Function
setup_tailscale_hostname() {
    print_status "Configuring Tailscale hostname..."
    
    # Get project and host information
    PROJECT_NAME=$(basename "$(pwd)")
    HOST_MACHINE=$(hostname -s 2>/dev/null || hostname)
    PARENT_HOST="${DEVCONTAINER_HOST_MACHINE:-unknown}"
    
    # Create a meaningful hostname
    TAILSCALE_HOSTNAME="${PROJECT_NAME}-${PARENT_HOST}"
    # Sanitize: lowercase, replace invalid chars with hyphens
    TAILSCALE_HOSTNAME=$(echo "$TAILSCALE_HOSTNAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
    # Truncate to 63 chars if needed
    TAILSCALE_HOSTNAME=${TAILSCALE_HOSTNAME:0:63}
    
    echo "Setting Tailscale hostname to: $TAILSCALE_HOSTNAME"
    
    # Wait for Tailscale to be ready
    echo "Waiting for Tailscale..."
    for i in {1..30}; do
        if tailscale status &>/dev/null; then
            break
        fi
        sleep 1
    done
    
    # Set the hostname if Tailscale is available
    if command -v tailscale &> /dev/null && tailscale status &>/dev/null; then
        echo "Tailscale is ready, attempting to set hostname..."
        
        # Get current status
        CURRENT_HOSTNAME=$(tailscale status --json | jq -r '.Self.HostName' 2>/dev/null || echo "")
        echo "Current hostname: $CURRENT_HOSTNAME"
        echo "Desired hostname: $TAILSCALE_HOSTNAME"
        
        # Save the configuration for reference
        mkdir -p ~/.config/tailscale
        cat > ~/.config/tailscale/hostname.conf <<EOF
PROJECT_NAME=$PROJECT_NAME
PARENT_HOST=$PARENT_HOST
DESIRED_HOSTNAME=$TAILSCALE_HOSTNAME
TAILSCALE_IP=$(tailscale ip -4 2>/dev/null || echo "")
EOF
        
        print_status "‚úÖ Tailscale hostname configuration saved"
    else
        print_error "‚ùå Tailscale is not running"
        return 1
    fi
}

# Main script logic
if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

case "$1" in
    --ssh)
        setup_ssh
        ;;
    --tailscale)
        setup_tailscale
        ;;
    --tailscale-hostname)
        setup_tailscale_hostname
        ;;
    --all)
        print_status "Running all setup tasks..."
        echo ""
        setup_ssh
        echo ""
        setup_tailscale
        echo ""
        setup_tailscale_hostname
        print_status "‚úÖ All setup tasks completed!"
        ;;
    --help|-h)
        show_help
        ;;
    *)
        print_error "Unknown option: $1"
        echo ""
        show_help
        exit 1
        ;;
esac