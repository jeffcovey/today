#!/bin/bash
# Unified setup script for various development environment configurations
set -e

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${GREEN}$1${NC}"
}

print_error() {
    echo -e "${RED}$1${NC}"
}

print_warning() {
    echo -e "${YELLOW}$1${NC}"
}

# Function to setup config.toml
setup_config() {
    SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
    PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
    CONFIG_FILE="$PROJECT_DIR/config.toml"
    EXAMPLE_FILE="$PROJECT_DIR/config.toml.example"

    if [ ! -f "$CONFIG_FILE" ]; then
        print_warning "config.toml not found!"
        echo ""
        if [ -f "$EXAMPLE_FILE" ]; then
            echo "Creating config.toml from example..."
            cp "$EXAMPLE_FILE" "$CONFIG_FILE"
            print_status "Created config.toml"
            echo ""
            print_warning "Please edit config.toml with your personal settings:"
            echo "  - Your name and vocation"
            echo "  - Your timezone and home location"
            echo "  - Your schedule preferences"
            echo ""
        else
            print_error "config.toml.example not found!"
            exit 1
        fi
    else
        print_status "config.toml already exists"
    fi
}

# Function to show usage
show_help() {
    cat << EOF
Usage: setup [OPTION]
Unified setup script for development environment configurations

Options:
    --config            Setup config.toml from example template
    --ssh               Setup SSH server for remote access
    --tailscale         Setup Tailscale VPN for secure connectivity
    --tailscale-hostname Configure Tailscale hostname
    --dotenvx           Setup dotenvx for encrypted environment sync
    --calendar          Setup calendar integrations (Google & iCloud)
    --all               Run all setup tasks
    --help              Display this help message

Examples:
    setup --ssh          # Setup SSH server only
    setup --tailscale    # Setup Tailscale only
    setup --dotenvx      # Setup encrypted env sync
    setup --calendar     # Setup calendar integrations
    setup --all          # Run all setups

EOF
}

# SSH Setup Function
setup_ssh() {
    print_status "Setting up SSH server for VS Code Remote SSH..."
    
    # Generate SSH host keys if they don't exist
    if [ ! -f /etc/ssh/ssh_host_rsa_key ]; then
        echo "Generating SSH host keys..."
        sudo ssh-keygen -A
    fi
    
    # Create SSH key pair for the user if it doesn't exist
    if [ ! -f /home/node/.ssh/id_rsa ]; then
        echo "Generating SSH key pair for user 'node'..."
        mkdir -p /home/node/.ssh
        ssh-keygen -t rsa -b 4096 -f /home/node/.ssh/id_rsa -N "" -C "devcontainer-$(hostname)"
        
        # Set up authorized_keys for passwordless login
        cp /home/node/.ssh/id_rsa.pub /home/node/.ssh/authorized_keys
        chmod 600 /home/node/.ssh/authorized_keys
        chmod 700 /home/node/.ssh
        chown -R node:node /home/node/.ssh
    fi
    
    # Set password for node user for iPad/mobile SSH access
    # Default password is 'ipad2025' - change via SSH_PASSWORD env var
    SSH_PASSWORD="${SSH_PASSWORD:-ipad2025}"
    echo "node:$SSH_PASSWORD" | sudo chpasswd
    echo "Set SSH password for user 'node'"

    # Configure SSH daemon
    sudo tee /etc/ssh/sshd_config.d/devcontainer.conf > /dev/null << 'EOF'
# Dev container SSH configuration
Port 2222
PermitRootLogin no
PasswordAuthentication yes
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
X11Forwarding yes
PrintMotd no
AcceptEnv LANG LC_*
EOF

    # Start SSH service
    echo "Starting SSH daemon..."
    sudo service ssh restart
    
    print_status "‚úÖ SSH server setup complete!"
    echo ""
    echo "To connect from VS Code:"
    echo "1. Add this to your local ~/.ssh/config:"
    echo "   Host devcontainer"
    echo "   HostName <container-ip>"
    echo "   Port 2222"
    echo "   User node"
    echo ""
}

# Tailscale Setup Function
setup_tailscale() {
    print_status "Setting up Tailscale for remote access..."
    echo ""
    
    # Check if Tailscale is installed
    if ! command -v tailscale &> /dev/null; then
        print_error "‚ùå Tailscale is not installed!"
        echo "Please rebuild the devcontainer to install Tailscale."
        return 1
    fi
    
    # Check Tailscale status
    STATUS=$(tailscale status --json 2>/dev/null || echo "{}")
    
    if echo "$STATUS" | grep -q '"BackendState":"Running"'; then
        print_status "‚úÖ Tailscale is already running!"
        
        # Get the Tailscale IP
        TAILSCALE_IP=$(tailscale ip -4 2>/dev/null || echo "Not available")
        HOSTNAME=$(hostname)
        
        echo ""
        echo "üì± Connection Information:"
        echo "=========================="
        echo "Tailscale IP: $TAILSCALE_IP"
        echo "Hostname: $HOSTNAME"
        echo ""
        echo "SSH Access: ssh node@$TAILSCALE_IP -p 2222"
        echo ""
    else
        print_warning "‚ö†Ô∏è  Tailscale needs authentication"
        echo ""
        
        # Check for authkey
        if [ -n "$TAILSCALE_AUTHKEY" ]; then
            echo "Using provided auth key..."
            sudo tailscale up --authkey="$TAILSCALE_AUTHKEY" --ssh
        else
            echo "To set up Tailscale, you have two options:"
            echo ""
            echo "Option 1: Interactive Login (Recommended for first time)"
            echo "  Run: sudo tailscale up --ssh"
            echo "  This will provide a URL to authenticate"
            echo ""
            echo "Option 2: Auth Key (For automated setup)"
            echo "  Set TAILSCALE_AUTHKEY environment variable"
            echo "  Then run this setup again"
        fi
    fi
}

# Dotenvx Setup Function
setup_dotenvx() {
    print_status "Setting up dotenvx for encrypted environment sync..."
    echo ""
    
    # Load common functions
    source "$(dirname "$0")/lib/dotenvx-loader.sh"
    
    # Check if .env exists
    if [ ! -f .env ]; then
        print_error "‚ùå No .env file found. Please create one first."
        return 1
    fi
    
    # Install dotenvx if not already installed
    if ! has_dotenvx_installed; then
        echo "üì¶ Installing dotenvx..."
        npm install -D @dotenvx/dotenvx
    fi
    
    # Check if already encrypted
    if has_dotenvx_encryption; then
        print_warning "‚ö†Ô∏è  Environment already encrypted"
        echo "To re-encrypt with updated values, run:"
        echo "  npx dotenvx encrypt"
        echo ""
        
        # Check for decryption key
        if [ -f .env.keys ]; then
            echo "üîë Your private key (from .env.keys):"
            grep "DOTENV_PRIVATE_KEY" .env.keys | head -1
        fi
        return 0
    fi
    
    # Encrypt the .env file
    echo "üîí Encrypting .env file..."
    npx dotenvx encrypt
    
    # Check if encryption succeeded
    if has_dotenvx_encryption; then
        print_status "‚úÖ Successfully encrypted environment variables"
        
        # Update .gitignore
        echo "üìù Updating .gitignore..."
        npx dotenvx ext gitignore --pattern .env.keys 2>/dev/null || true
        
        # Ensure .env is also ignored
        if ! grep -q "^\.env$" .gitignore 2>/dev/null; then
            echo ".env" >> .gitignore
        fi
        
        echo ""
        print_status "‚úÖ Dotenvx setup complete!"
        echo ""
        echo "üìã Next steps:"
        echo "1. Your private key is in .env.keys (DO NOT COMMIT)"
        echo "2. The encrypted .env file is safe to commit"
        echo "3. To use in other locations:"
        echo "   - Pull the repo to get encrypted .env"
        echo "   - Set: export DOTENV_PRIVATE_KEY='<key>'"
        echo "   - Commands will auto-decrypt when run"
        echo ""
        echo "Example usage:"
        echo "  bin/sync         # Will auto-use dotenvx"
        echo "  bin/review       # Will auto-use dotenvx"
        echo ""
        
        # Show the key for easy copying
        if [ -f .env.keys ]; then
            echo "üîë Your private key (save this securely):"
            grep "DOTENV_PRIVATE_KEY" .env.keys | head -1
            echo ""
            echo "Add to your shell profile (~/.bashrc or ~/.zshrc):"
            echo "export $(grep "DOTENV_PRIVATE_KEY" .env.keys | head -1)"
        fi
    else
        print_error "‚ùå Encryption failed"
        return 1
    fi
}

# Tailscale Hostname Setup Function
setup_tailscale_hostname() {
    print_status "Configuring Tailscale hostname..."
    
    # Get project and host information
    PROJECT_NAME=$(basename "$(pwd)")
    HOST_MACHINE=$(hostname -s 2>/dev/null || hostname)
    PARENT_HOST="${DEVCONTAINER_HOST_MACHINE:-unknown}"
    
    # Create a meaningful hostname
    TAILSCALE_HOSTNAME="${PROJECT_NAME}-${PARENT_HOST}"
    # Sanitize: lowercase, replace invalid chars with hyphens
    TAILSCALE_HOSTNAME=$(echo "$TAILSCALE_HOSTNAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
    # Truncate to 63 chars if needed
    TAILSCALE_HOSTNAME=${TAILSCALE_HOSTNAME:0:63}
    
    echo "Setting Tailscale hostname to: $TAILSCALE_HOSTNAME"
    
    # Wait for Tailscale to be ready
    echo "Waiting for Tailscale..."
    for i in {1..30}; do
        if tailscale status &>/dev/null; then
            break
        fi
        sleep 1
    done
    
    # Set the hostname if Tailscale is available
    if command -v tailscale &> /dev/null && tailscale status &>/dev/null; then
        echo "Tailscale is ready, attempting to set hostname..."
        
        # Get current status
        CURRENT_HOSTNAME=$(tailscale status --json | jq -r '.Self.HostName' 2>/dev/null || echo "")
        echo "Current hostname: $CURRENT_HOSTNAME"
        echo "Desired hostname: $TAILSCALE_HOSTNAME"
        
        # Save the configuration for reference
        mkdir -p ~/.config/tailscale
        cat > ~/.config/tailscale/hostname.conf <<EOF
PROJECT_NAME=$PROJECT_NAME
PARENT_HOST=$PARENT_HOST
DESIRED_HOSTNAME=$TAILSCALE_HOSTNAME
TAILSCALE_IP=$(tailscale ip -4 2>/dev/null || echo "")
EOF
        
        print_status "‚úÖ Tailscale hostname configuration saved"
    else
        print_error "‚ùå Tailscale is not running"
        return 1
    fi
}

# Calendar Setup Function
setup_calendar() {
    print_status "Setting up calendar integrations..."
    echo ""
    
    # Check current .env for calendar settings
    GOOGLE_CONFIGURED=false
    ICLOUD_CONFIGURED=false
    
    if [ -f .env ]; then
        if grep -q "GOOGLE_SERVICE_ACCOUNT_KEY_PATH=" .env && ! grep -q "GOOGLE_SERVICE_ACCOUNT_KEY_PATH=your" .env 2>/dev/null; then
            # Also check if the key file exists
            KEY_PATH=$(grep "GOOGLE_SERVICE_ACCOUNT_KEY_PATH=" .env | cut -d'=' -f2)
            if [ -f "$KEY_PATH" ]; then
                GOOGLE_CONFIGURED=true
            fi
        fi
        if grep -q "ICLOUD_USERNAME=" .env && ! grep -q "ICLOUD_USERNAME=your@icloud" .env 2>/dev/null; then
            ICLOUD_CONFIGURED=true
        fi
    fi
    
    echo "üìÖ Calendar Integration Setup"
    echo "=============================="
    echo ""
    
    # Google Calendar Setup
    echo "üî∑ Google Calendar"
    echo "------------------"
    if $GOOGLE_CONFIGURED; then
        print_status "‚úÖ Google Calendar is configured"
        if grep -q "GOOGLE_CALENDAR_ID=" .env 2>/dev/null; then
            CALENDAR_ID=$(grep "GOOGLE_CALENDAR_ID=" .env | cut -d'=' -f2)
            echo "   Calendar ID: $CALENDAR_ID"
        fi
    else
        print_warning "‚ö†Ô∏è  Google Calendar not configured"
        echo ""
        echo "To set up Google Calendar (Service Account - Recommended):"
        echo "1. Go to https://console.cloud.google.com/"
        echo "2. Create a new project (or select existing)"
        echo "3. Enable the Google Calendar API:"
        echo "   - Go to 'APIs & Services' > 'Enable APIs and Services'"
        echo "   - Search for 'Google Calendar API' and enable it"
        echo "4. Create a Service Account:"
        echo "   - Go to 'APIs & Services' > 'Credentials'"
        echo "   - Click 'Create Credentials' > 'Service Account'"
        echo "   - Give it a name like 'today-calendar-sync'"
        echo "   - Click 'Create and Continue'"
        echo "   - Skip optional steps, click 'Done'"
        echo "5. Create a key for the Service Account:"
        echo "   - Click on your new service account"
        echo "   - Go to 'Keys' tab"
        echo "   - Click 'Add Key' > 'Create new key'"
        echo "   - Choose JSON format"
        echo "   - Save the downloaded file as 'google-calendar-key.json' in project root"
        echo "6. Share your calendar with the Service Account:"
        echo "   - Copy the service account email (ends with @...iam.gserviceaccount.com)"
        echo "   - Open Google Calendar"
        echo "   - Go to Settings > Settings for my calendars > [Your Calendar]"
        echo "   - Under 'Share with specific people', add the service account email"
        echo "   - Set permission to 'See all event details'"
        echo "7. Convert key to base64 and add to .env:"
        echo "   Run: bin/encode-service-account"
        echo "   This will give you a GOOGLE_SERVICE_ACCOUNT_KEY value for .env"
        echo ""
        echo "8. Add calendar IDs to .env:"
        echo "   GOOGLE_CALENDAR_IDS=primary,work@group.calendar.google.com,personal@gmail.com"
        echo "   (comma-separated list of calendars to sync)"
        echo ""
        echo "To find your Calendar IDs:"
        echo "   - In Google Calendar, click the 3 dots next to each calendar"
        echo "   - Go to 'Settings and sharing'"
        echo "   - Find 'Calendar ID' (primary, your-email@gmail.com, or abc123@group.calendar.google.com)"
        echo ""
        echo "Note: After adding to .env, run 'npx dotenvx encrypt' to secure your credentials"
    fi
    echo ""
    
    # iCloud Calendar Setup
    echo "üçé iCloud Calendar"
    echo "------------------"
    if $ICLOUD_CONFIGURED; then
        print_status "‚úÖ iCloud Calendar is configured"
        ICLOUD_USER=$(grep "ICLOUD_USERNAME=" .env | cut -d'=' -f2)
        echo "   Username: $ICLOUD_USER"
    else
        print_warning "‚ö†Ô∏è  iCloud Calendar not configured"
        echo ""
        echo "To set up iCloud Calendar:"
        echo "1. Go to https://appleid.apple.com/account/manage"
        echo "2. Sign in with your Apple ID"
        echo "3. Under 'Sign-In and Security', find 'App-Specific Passwords'"
        echo "4. Click '+' to generate a new password"
        echo "5. Name it 'Today Calendar Sync' (or similar)"
        echo "6. Copy the generated password (format: xxxx-xxxx-xxxx-xxxx)"
        echo "7. Add to your .env file:"
        echo "   ICLOUD_USERNAME=your@icloud.com"
        echo "   ICLOUD_APP_PASSWORD=xxxx-xxxx-xxxx-xxxx"
        echo ""
        echo "Note: App-specific passwords are required for 2FA-enabled accounts"
    fi
    echo ""
    
    # Public Calendar URLs
    echo "üåê Public Calendar URLs"
    echo "-----------------------"
    CALENDAR_COUNT=$(grep -c '\[plugins.public-calendars\.' config.toml 2>/dev/null || echo "0")
    if [ "$CALENDAR_COUNT" -gt 0 ]; then
        print_status "‚úÖ Found $CALENDAR_COUNT public calendar(s) configured in config.toml"
        echo "   Edit config.toml to add/remove calendars"
    else
        echo "‚ÑπÔ∏è  No public calendars configured"
        echo ""
        echo "To add public calendar URLs, add to config.toml:"
        echo "  [plugins.public-calendars.tripit]"
        echo "  enabled = true"
        echo "  name = \"TripIt\""
        echo "  url = \"https://www.tripit.com/feed/ical/...\""
    fi
    echo ""
    
    # Local Calendar File
    echo "üìÅ Local Calendar File"
    echo "----------------------"
    if [ -f calendar.ics ]; then
        print_status "‚úÖ Local calendar.ics file found"
        EVENT_COUNT=$(grep -c "BEGIN:VEVENT" calendar.ics 2>/dev/null || echo "0")
        echo "   Events in file: $EVENT_COUNT"
    else
        echo "‚ÑπÔ∏è  No local calendar.ics file found"
        echo ""
        echo "To use a local calendar file:"
        echo "1. Export your calendar from any app as .ics file"
        echo "2. Save it as 'calendar.ics' in the project root"
        echo "3. The sync will automatically pick it up"
    fi
    echo ""
    
    # macOS Calendar
    if [ "$(uname)" = "Darwin" ]; then
        echo "üñ•Ô∏è  macOS Calendar"
        echo "------------------"
        print_status "‚úÖ macOS Calendar available (uses AppleScript)"
        echo "   No configuration needed - works automatically"
        echo ""
    fi
    
    # Test calendar sync
    echo "Testing calendar sync..."
    SYNC_OUTPUT=$(bin/calendar sync 2>&1)
    if echo "$SYNC_OUTPUT" | grep -q "‚úÖ Synced [1-9]"; then
        # Actually synced some events (not 0)
        print_status "‚úÖ Calendar sync is working!"
        
        # Show summary
        TODAY_COUNT=$(bin/calendar today 2>/dev/null | jq '. | length' 2>/dev/null || echo 0)
        WEEK_COUNT=$(bin/calendar week 2>/dev/null | jq '. | length' 2>/dev/null || echo 0)
        
        if [ "$TODAY_COUNT" -gt 0 ] || [ "$WEEK_COUNT" -gt 0 ]; then
            echo ""
            echo "üìä Calendar Summary:"
            echo "   Events today: $TODAY_COUNT"
            echo "   Events this week: $WEEK_COUNT"
        fi
    else
        print_warning "‚ö†Ô∏è  No calendars are currently syncing"
        echo "   Configure at least one calendar source above"
    fi
    
    echo ""
    echo "üìù Next Steps:"
    echo "1. Configure your calendar credentials in .env"
    echo "2. Run 'bin/sync' to sync all data including calendars"
    echo "3. Run 'bin/today' to see your daily review with calendar events"
}

# Main script logic
if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

case "$1" in
    --ssh)
        setup_ssh
        ;;
    --tailscale)
        setup_tailscale
        ;;
    --tailscale-hostname)
        setup_tailscale_hostname
        ;;
    --dotenvx)
        setup_dotenvx
        ;;
    --calendar)
        setup_calendar
        ;;
    --config)
        setup_config
        ;;
    --all)
        print_status "Running all setup tasks..."
        echo ""
        setup_config
        echo ""
        setup_ssh
        echo ""
        setup_tailscale
        echo ""
        setup_tailscale_hostname
        echo ""
        setup_dotenvx
        echo ""
        setup_calendar
        print_status "All setup tasks completed!"
        ;;
    --help|-h)
        show_help
        ;;
    *)
        print_error "Unknown option: $1"
        echo ""
        show_help
        exit 1
        ;;
esac