#!/bin/bash
# Setup vault-api on the droplet
# This provides read-only access to vault files for Drafts sync

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

print_status() { echo -e "${GREEN}✓${NC} $1"; }
print_info() { echo -e "${BLUE}ℹ${NC} $1"; }
print_warning() { echo -e "${YELLOW}⚠${NC} $1"; }
print_error() { echo -e "${RED}✗${NC} $1"; }

print_info "Setting up combined Vault API service (read + write)..."

# Copy vault-api.js to the server
print_info "Copying vault-api.js..."
scp -i ~/.ssh/do_deploy_key /workspaces/today/src/vault-api.js root@today.jeffcovey.net:/opt/today/src/

# Copy the systemd service file
print_info "Installing systemd service..."
scp -i ~/.ssh/do_deploy_key /workspaces/today/config/vault-api.service root@today.jeffcovey.net:/tmp/
ssh -i ~/.ssh/do_deploy_key root@today.jeffcovey.net "sudo mv /tmp/vault-api.service /etc/systemd/system/"

# Copy nginx configuration
print_info "Configuring nginx..."
scp -i ~/.ssh/do_deploy_key /workspaces/today/config/nginx-vault-api.conf root@today.jeffcovey.net:/tmp/

# Apply nginx configuration
ssh -i ~/.ssh/do_deploy_key root@today.jeffcovey.net << 'EOF'
# Add vault-api configuration to nginx
if ! grep -q "/api/vault/" /etc/nginx/sites-available/today.jeffcovey.net; then
    echo "Adding vault-api configuration to nginx..."
    
    # Insert the vault-api config into the server block
    # Find the line with "location /api/inbox/" and add vault-api config after it
    sed -i '/location \/api\/inbox\//r /tmp/nginx-vault-api.conf' /etc/nginx/sites-available/today.jeffcovey.net
fi

# Test nginx configuration
nginx -t

# Reload nginx
systemctl reload nginx

# Ensure the inbox API key file exists (vault-api uses the same key)
if [ ! -f /opt/today/.inbox-api-key ]; then
    echo "INBOX_API_KEY=$(openssl rand -hex 32)" > /opt/today/.inbox-api-key
    chmod 600 /opt/today/.inbox-api-key
    echo "Generated new API key"
else
    echo "Using existing API key"
fi

# Reload systemd and start the service
systemctl daemon-reload
systemctl enable vault-api
systemctl restart vault-api

# Check status
sleep 2
if systemctl is-active --quiet vault-api; then
    echo "✓ Vault API service is running"
else
    echo "✗ Vault API service failed to start"
    systemctl status vault-api --no-pager
    exit 1
fi
EOF

print_status "Vault API setup complete!"
print_info "Testing vault API..."

# Get the API key for testing
API_KEY=$(ssh -i ~/.ssh/do_deploy_key root@today.jeffcovey.net "grep INBOX_API_KEY /opt/today/.inbox-api-key | cut -d= -f2")

# Test the health endpoint (no auth required)
if curl -s https://today.jeffcovey.net/api/health | grep -q "ok"; then
    print_status "Health check passed"
else
    print_error "Health check failed"
fi

echo ""
print_status "Vault API is now available at:"
echo "Vault endpoints:"
echo "  - List files: https://today.jeffcovey.net/api/vault/list"
echo "  - Get file: https://today.jeffcovey.net/api/vault/file/[path]"
echo ""
echo "Inbox endpoints:"
echo "  - Upload: https://today.jeffcovey.net/api/inbox/upload"
echo "  - List inbox: https://today.jeffcovey.net/api/inbox/list"
echo ""
print_info "Use this API key in Drafts: $API_KEY"