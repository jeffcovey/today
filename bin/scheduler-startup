#!/bin/bash
# Startup script for scheduler - clones or updates GitHub repository

set -e

echo "ðŸš€ Scheduler startup..."

# Create symlinks AFTER volume is mounted
if [[ ! -L /app/.data ]]; then
    echo "ðŸ“ Setting up data symlinks..."
    ln -sfn /app/data /app/.data
    ln -sfn /app/data /app/.notion-cache
    ln -sfn /app/data /app/.calendar-cache
fi

# Ensure data directory exists and is writable
mkdir -p /app/data
chmod 755 /app/data

# Check if we have GitHub token
if [[ -z "$GITHUB_TOKEN" ]]; then
    echo "âš ï¸  No GITHUB_TOKEN found, skipping GitHub setup"
else
    echo "ðŸ“¦ Setting up GitHub repository..."
    
    # Configure git to use the token
    git config --global url."https://${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
    
    # Store git repo in persistent volume
    GIT_DIR="/app/data/git-repo"
    
    # Clone or update the repository content
    if [[ ! -d "$GIT_DIR/.git" ]]; then
        echo "ðŸ“¥ Cloning FULL repository to persistent storage..."
        # Clone to persistent volume with full depth
        git clone --depth=0 https://${GITHUB_TOKEN}@github.com/OlderGay-Men/today.git "$GIT_DIR"
        
        # Set up git for pushing
        cd "$GIT_DIR"
        git config user.email "scheduler@fly.io"
        git config user.name "Today Scheduler"
        
        # Verify vault exists
        if [[ ! -d "$GIT_DIR/vault" ]] || [[ $(find "$GIT_DIR/vault" -type f -name "*.md" | wc -l) -lt 10 ]]; then
            echo "âš ï¸  WARNING: Vault directory missing or has too few files!"
            echo "âš ï¸  Disabling sync to prevent data loss"
            touch /app/SYNC_DISABLED
        fi
        
        echo "âœ… Repository cloned to persistent storage"
    else
        echo "ðŸ“¥ Pulling latest changes from persistent storage..."
        cd "$GIT_DIR"
        git pull origin main || echo "âš ï¸  Pull failed, continuing anyway"
        
        # Verify vault still exists after pull
        if [[ ! -d "$GIT_DIR/vault" ]] || [[ $(find "$GIT_DIR/vault" -type f -name "*.md" | wc -l) -lt 10 ]]; then
            echo "âš ï¸  WARNING: Vault directory missing or has too few files after pull!"
            echo "âš ï¸  Disabling sync to prevent data loss"
            touch /app/SYNC_DISABLED
        fi
    fi
    
    # Remove existing directory if it exists
    rm -rf /app/vault
    
    # Symlink vault directory to /app
    ln -sfn "$GIT_DIR/vault" /app/vault
    ln -sfn "$GIT_DIR/.git" /app/.git
    
    # Change to app directory for scripts
    cd /app
    
    # Show file counts
    echo "ðŸ“Š Content summary:"
    echo "  Vault files: $(find vault -type f -name "*.md" 2>/dev/null | wc -l)"
    if [[ -d vault/notes ]]; then echo "    Notes: $(find vault/notes -type f -name "*.md" 2>/dev/null | wc -l)"; fi
    if [[ -d vault/plans ]]; then echo "    Plans: $(find vault/plans -type f -name "*.md" 2>/dev/null | wc -l)"; fi
    if [[ -d vault/projects ]]; then echo "    Projects: $(find vault/projects -type f -name "*.md" 2>/dev/null | wc -l)"; fi
    if [[ -d vault/topics ]]; then echo "    Topics: $(find vault/topics -type f -name "*.md" 2>/dev/null | wc -l)"; fi
fi

echo "âœ… Startup complete, starting scheduler..."

# Start the scheduler
exec node src/scheduler.js