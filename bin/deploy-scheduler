#!/bin/bash
# Deploy the scheduler to Fly.io
# Uses dotenvx to load secrets from .env and sets them in Fly

set -e

# Load common dotenvx handler
source "$(dirname "$0")/lib/dotenvx-loader.sh"
auto_dotenvx "$@"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

print_status() { echo -e "${GREEN}‚úì${NC} $1"; }
print_info() { echo -e "${BLUE}‚Ñπ${NC} $1"; }
print_warning() { echo -e "${YELLOW}‚ö†${NC} $1"; }
print_error() { echo -e "${RED}‚úó${NC} $1"; }

# Find the fly command
FLY_CMD=""
if command -v fly &> /dev/null; then
    FLY_CMD="fly"
elif command -v flyctl &> /dev/null; then
    FLY_CMD="flyctl"
elif [[ -x "/home/node/.fly/bin/flyctl" ]]; then
    FLY_CMD="/home/node/.fly/bin/flyctl"
elif [[ -x "$HOME/.fly/bin/flyctl" ]]; then
    FLY_CMD="$HOME/.fly/bin/flyctl"
else
    print_error "Fly CLI not installed"
    echo "Installing Fly CLI..."
    curl -L https://fly.io/install.sh | sh
    if [[ -x "$HOME/.fly/bin/flyctl" ]]; then
        FLY_CMD="$HOME/.fly/bin/flyctl"
        print_status "Fly CLI installed"
    else
        print_error "Failed to install Fly CLI"
        exit 1
    fi
fi

# Parse arguments
ACTION="${1:-deploy}"
APP_NAME="${FLY_APP_NAME:-today-scheduler}"

case "$ACTION" in
    setup)
        echo "üöÄ Setting up Fly.io app..."
        
        # Check if logged in
        if ! $FLY_CMD auth whoami &> /dev/null; then
            print_info "Not logged in to Fly.io"
            echo "Opening browser for authentication..."
            $FLY_CMD auth login
        else
            USER=$($FLY_CMD auth whoami)
            print_status "Logged in as: $USER"
        fi
        
        # Check if app exists
        if $FLY_CMD apps list | grep -q "$APP_NAME"; then
            print_info "App '$APP_NAME' already exists"
        else
            print_info "Creating app '$APP_NAME'..."
            $FLY_CMD launch --no-deploy --name "$APP_NAME" --copy-config --yes
            print_status "App created"
        fi
        
        # Create volumes if they don't exist
        print_info "Checking volumes..."
        if ! $FLY_CMD volumes list --app "$APP_NAME" | grep -q "today_data"; then
            print_info "Creating today_data volume (1GB)..."
            $FLY_CMD volumes create today_data --size 1 --app "$APP_NAME" --region iad --yes
        else
            print_status "Volume today_data exists"
        fi
        
        if ! $FLY_CMD volumes list --app "$APP_NAME" | grep -q "today_cache"; then
            print_info "Creating today_cache volume (1GB)..."
            $FLY_CMD volumes create today_cache --size 1 --app "$APP_NAME" --region iad --yes
        else
            print_status "Volume today_cache exists"
        fi
        
        print_status "Setup complete! Run 'bin/deploy-scheduler secrets' to set secrets"
        ;;
        
    secrets)
        echo "üîê Setting Fly.io secrets from .env..."
        
        # Get DOTENV_PRIVATE_KEY from .env.keys file since it's the unencrypted key
        if [[ -f .env.keys ]]; then
            DOTENV_KEY=$(grep "^DOTENV_PRIVATE_KEY=" .env.keys | cut -d'=' -f2)
        fi
        
        # Fallback to environment variable if not in .env.keys
        if [[ -z "$DOTENV_KEY" ]]; then
            DOTENV_KEY="$DOTENV_PRIVATE_KEY"
        fi
        
        # Check if we have the key
        if [[ -z "$DOTENV_KEY" ]]; then
            print_error "DOTENV_PRIVATE_KEY not found"
            print_info "Looking for the decryption key in .env.keys file"
            if [[ ! -f .env.keys ]]; then
                print_error ".env.keys file not found"
                echo "The DOTENV_PRIVATE_KEY is needed to decrypt your .env file in production"
                echo "You can find it in your .env.keys file (DO NOT commit this file)"
            fi
            exit 1
        fi
        
        # Build secrets command
        SECRETS_CMD="$FLY_CMD secrets set --app $APP_NAME"
        
        # Always set the dotenv key (using the key we found)
        SECRETS_CMD="$SECRETS_CMD DOTENV_PRIVATE_KEY=\"$DOTENV_KEY\""
        print_info "Will set: DOTENV_PRIVATE_KEY (from .env.keys)"
        
        # GitHub token for repository access
        if [[ -n "$GITHUB_TOKEN" ]]; then
            SECRETS_CMD="$SECRETS_CMD GITHUB_TOKEN=\"$GITHUB_TOKEN\""
            print_info "Will set: GITHUB_TOKEN (for repository read/write)"
        else
            print_warning "No GITHUB_TOKEN found - GitHub sync will not work!"
            print_info "For Organization repositories, create a Classic Personal Access Token:"
            print_info "  https://github.com/settings/tokens/new"
            print_info "Select scope: 'repo' (Full control of private repositories)"
            print_info "This works for org repos if you have write access"
            print_info ""
            print_info "Then add to .env and encrypt:"
            print_info "  echo 'GITHUB_TOKEN=ghp_YOUR_TOKEN' >> .env"
            print_info "  npx dotenvx encrypt"
        fi
        
        # Anthropic API key for Claude CLI
        if [[ -n "$ANTHROPIC_API_KEY" ]]; then
            SECRETS_CMD="$SECRETS_CMD ANTHROPIC_API_KEY=\"$ANTHROPIC_API_KEY\""
            print_info "Will set: ANTHROPIC_API_KEY (for Claude CLI automation)"
        else
            print_warning "No ANTHROPIC_API_KEY found - Claude scheduled tasks will not work!"
            print_info "To get an API key:"
            print_info "  1. Go to https://console.anthropic.com/settings/keys"
            print_info "  2. Create a new API key"
            print_info "  3. Add to .env and encrypt:"
            print_info "     echo 'ANTHROPIC_API_KEY=sk-ant-api03-YOUR_KEY' >> .env"
            print_info "     npx dotenvx encrypt"
        fi
        
        # Optional secrets - only set if they exist
        if [[ -n "$TURSO_DATABASE_URL" ]]; then
            SECRETS_CMD="$SECRETS_CMD TURSO_DATABASE_URL=\"$TURSO_DATABASE_URL\""
            print_info "Will set: TURSO_DATABASE_URL"
        fi
        
        if [[ -n "$TURSO_AUTH_TOKEN" ]]; then
            SECRETS_CMD="$SECRETS_CMD TURSO_AUTH_TOKEN=\"$TURSO_AUTH_TOKEN\""
            print_info "Will set: TURSO_AUTH_TOKEN"
        fi
        
        if [[ -n "$NOTION_TOKEN" ]] && [[ "$NOTION_TOKEN" != "your_notion_token_here" ]]; then
            SECRETS_CMD="$SECRETS_CMD NOTION_TOKEN=\"$NOTION_TOKEN\""
            print_info "Will set: NOTION_TOKEN"
        fi
        
        if [[ -n "$EMAIL_ACCOUNT" ]]; then
            SECRETS_CMD="$SECRETS_CMD EMAIL_ACCOUNT=\"$EMAIL_ACCOUNT\""
            print_info "Will set: EMAIL_ACCOUNT"
        fi
        
        if [[ -n "$EMAIL_PASSWORD" ]]; then
            SECRETS_CMD="$SECRETS_CMD EMAIL_PASSWORD=\"$EMAIL_PASSWORD\""
            print_info "Will set: EMAIL_PASSWORD"
        fi
        
        if [[ -n "$ICLOUD_USERNAME" ]]; then
            SECRETS_CMD="$SECRETS_CMD ICLOUD_USERNAME=\"$ICLOUD_USERNAME\""
            print_info "Will set: ICLOUD_USERNAME"
        fi
        
        if [[ -n "$ICLOUD_APP_PASSWORD" ]]; then
            SECRETS_CMD="$SECRETS_CMD ICLOUD_APP_PASSWORD=\"$ICLOUD_APP_PASSWORD\""
            print_info "Will set: ICLOUD_APP_PASSWORD"
        fi
        
        # Execute the secrets command
        echo ""
        print_info "Setting secrets in Fly.io..."
        eval $SECRETS_CMD
        
        print_status "Secrets updated! Run 'bin/deploy-scheduler deploy' to deploy"
        ;;
        
    deploy)
        echo "üö¢ Deploying scheduler to Fly.io..."
        
        # Check if app exists
        if ! $FLY_CMD apps list | grep -q "$APP_NAME"; then
            print_error "App '$APP_NAME' not found"
            echo "Run 'bin/deploy-scheduler setup' first"
            exit 1
        fi
        
        # Deploy
        print_info "Building and deploying..."
        $FLY_CMD deploy --app "$APP_NAME"
        
        print_status "Deployment complete!"
        echo ""
        echo "üìä View logs: $FLY_CMD logs --app $APP_NAME"
        echo "üìà Check status: $FLY_CMD status --app $APP_NAME"
        echo "üåê Dashboard: https://fly.io/apps/$APP_NAME"
        ;;
        
    logs)
        echo "üìä Showing logs for $APP_NAME..."
        $FLY_CMD logs --app "$APP_NAME"
        ;;
        
    status)
        echo "üìà Status of $APP_NAME..."
        $FLY_CMD status --app "$APP_NAME"
        echo ""
        $FLY_CMD apps list | grep "$APP_NAME"
        ;;
        
    ssh)
        echo "üîå Connecting to $APP_NAME..."
        $FLY_CMD ssh console --app "$APP_NAME"
        ;;
        
    sync)
        echo "üîÑ Running initial sync on $APP_NAME..."
        $FLY_CMD ssh console --app "$APP_NAME" --command "cd /app && bin/sync"
        print_status "Sync completed"
        ;;
        
    exec)
        if [[ -z "$2" ]]; then
            print_error "Usage: bin/deploy-scheduler exec 'command'"
            exit 1
        fi
        shift  # Remove 'exec' from arguments
        echo "‚ö° Executing on $APP_NAME: $*"
        $FLY_CMD ssh console --app "$APP_NAME" --command "$*"
        ;;
        
    restart)
        echo "üîÑ Restarting $APP_NAME..."
        $FLY_CMD apps restart "$APP_NAME"
        print_status "App restarted"
        ;;
        
    destroy)
        print_warning "This will destroy the app and all its data!"
        read -p "Are you sure? Type 'yes' to confirm: " confirm
        if [[ "$confirm" == "yes" ]]; then
            $FLY_CMD apps destroy "$APP_NAME" --yes
            print_status "App destroyed"
        else
            print_info "Cancelled"
        fi
        ;;
        
    full)
        echo "üéØ Full deployment process..."
        
        # Run all steps
        "$0" setup
        echo ""
        "$0" secrets
        echo ""
        "$0" deploy
        
        print_status "Full deployment complete!"
        ;;
        
    *)
        echo "Usage: bin/deploy-scheduler [command]"
        echo ""
        echo "Commands:"
        echo "  setup    - Create Fly.io app and volumes"
        echo "  secrets  - Set secrets from .env file"
        echo "  deploy   - Deploy the scheduler (default)"
        echo "  full     - Run setup + secrets + deploy"
        echo "  logs     - Show application logs"
        echo "  status   - Show app status"
        echo "  ssh      - SSH into the container"
        echo "  sync     - Run initial sync (bin/sync)"
        echo "  exec CMD - Execute any command in container"
        echo "  restart  - Restart the app"
        echo "  destroy  - Destroy the app (careful!)"
        echo ""
        echo "Typical first-time deployment:"
        echo "  bin/deploy-scheduler full"
        echo ""
        echo "Update after code changes:"
        echo "  bin/deploy-scheduler deploy"
        ;;
esac