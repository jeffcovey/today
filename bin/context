#!/usr/bin/env node

/**
 * Context CLI - Display contextual information from context plugins
 *
 * Context plugins provide ephemeral data that doesn't persist in the database.
 * They generate real-time contextual information for AI and daily reviews.
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { execSync } from 'child_process';
import { getSourcesForType } from '../src/plugin-loader.js';
import { colors, parseArgs } from '../src/cli-utils.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const PROJECT_ROOT = path.dirname(__dirname);

/**
 * Run a single context plugin and return its output
 */
async function runContextPlugin(pluginName, sourceId, sourceConfig) {
  const pluginPath = path.join(PROJECT_ROOT, 'plugins', pluginName);
  const readScript = path.join(pluginPath, 'read.js');

  if (!fs.existsSync(readScript)) {
    return null;
  }

  try {
    // Run from project root so relative paths work correctly
    const output = execSync(`node "${readScript}"`, {
      cwd: PROJECT_ROOT,
      encoding: 'utf8',
      timeout: 30000,
      env: {
        ...process.env,
        PROJECT_ROOT,
        PLUGIN_CONFIG: JSON.stringify(sourceConfig || {}),
        SOURCE_ID: sourceId
      }
    });

    return JSON.parse(output);
  } catch (error) {
    return { error: error.message };
  }
}

/**
 * Default formatter for context plugins
 * Plugins can provide a 'context' field with pre-formatted text
 */
function formatDefault(pluginName, data) {
  console.log(colors.cyan(pluginName));
  console.log('');

  // If plugin provides a 'context' field, display it formatted
  if (data.context) {
    console.log(data.context);
  } else {
    console.log(JSON.stringify(data, null, 2));
  }
}

// Default command - show all context plugin outputs
async function cmdDefault(options = {}) {
  const { sources, allSources } = await getSourcesForType('context', options.source);

  if (sources.length === 0) {
    if (options.source) {
      console.log(colors.yellow('⚠') + ` No context plugins matching "${options.source}"`);
      console.log('');
      console.log('Available sources:');
      for (const s of allSources) {
        console.log(`  - ${s.sourceId}`);
      }
    } else {
      console.log(colors.blue('ℹ') + ' No context plugins enabled');
      console.log('');
      console.log('Context plugins provide real-time information like vault changes.');
      console.log('Enable them in config.toml under [plugins.<name>.<source>]');
    }
    return;
  }

  for (let i = 0; i < sources.length; i++) {
    const { sourceId, plugin, config } = sources[i];
    const pluginName = plugin.name;

    const data = await runContextPlugin(pluginName, sourceId, config);

    if (!data) {
      console.log(colors.yellow('⚠') + ` Could not run ${pluginName}`);
      continue;
    }

    if (data.error) {
      console.log(colors.red('✗') + ` ${pluginName}: ${data.error}`);
      continue;
    }

    // Display plugin output using its context field
    formatDefault(pluginName, data);

    // Add separator between plugins
    if (i < sources.length - 1) {
      console.log('');
      console.log(colors.gray('─'.repeat(50)));
      console.log('');
    }
  }
}

// List command - show available context plugins
async function cmdList() {
  const { sources } = await getSourcesForType('context');

  if (sources.length === 0) {
    console.log(colors.blue('ℹ') + ' No context plugins enabled');
    return;
  }

  console.log(colors.cyan('Context Plugins'));
  console.log('');

  for (const { sourceId, pluginName, config } of sources) {
    console.log(`  ${colors.green('●')} ${sourceId}`);
    if (config?.description) {
      console.log(`    ${colors.gray(config.description)}`);
    }
  }
}

// Help text
function showHelp() {
  console.log('Context CLI');
  console.log('');
  console.log('Usage: context <command> [options]');
  console.log('');
  console.log('Commands:');
  console.log('  show [--source NAME]        Show all context plugin outputs');
  console.log('  list                        List available context plugins');
  console.log('');
  console.log('Options:');
  console.log('  --source NAME               Filter by plugin source');
  console.log('  -h, --help                  Show this help');
  console.log('');
  console.log('Context plugins provide ephemeral data (not stored in database):');
  console.log('  - vault-changes: Files modified or added today');
  console.log('  - weather-context: Current weather and forecast');
  console.log('');
  console.log('Examples:');
  console.log('  context show                Show all context');
  console.log('  context list                List enabled plugins');
  console.log('  context show --source vault Filter by source name');
  console.log('');
}

// Main command handler
const { command, options } = parseArgs();

// Handle help flag
if (options.help || options.h) {
  showHelp();
  process.exit(0);
}

switch (command) {
  case 'show':
    await cmdDefault(options);
    break;
  case 'list':
    await cmdList();
    break;
  default:
    showHelp();
}
