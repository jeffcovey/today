#!/bin/bash

# Vault Git Sync Script
# Automatically syncs the vault/ directory with its remote repository

# Get the directory where this script lives, then go to parent (project root)
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
VAULT_DIR="$PROJECT_DIR/vault"
SCRIPT_NAME="vault-sync"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log() {
    echo -e "${GREEN}[${SCRIPT_NAME}]${NC} $1"
}

error() {
    echo -e "${RED}[${SCRIPT_NAME} ERROR]${NC} $1" >&2
}

warning() {
    echo -e "${YELLOW}[${SCRIPT_NAME} WARNING]${NC} $1"
}

# Check if vault directory exists
if [ ! -d "$VAULT_DIR" ]; then
    error "Vault directory not found at $VAULT_DIR"
    exit 1
fi

cd "$VAULT_DIR" || exit 1

# Check if it's a git repository
if [ ! -d ".git" ]; then
    warning "Vault directory is not a git repository yet"
    echo ""
    echo "To initialize vault as a git repository, run:"
    echo "  cd $VAULT_DIR"
    echo "  git init"
    echo "  git branch -m main"
    echo "  git add ."
    echo "  git commit -m 'Initial commit'"
    echo ""
    echo "Then set up a remote repository:"
    echo "  $0 setup-remote git@github.com:yourusername/vault.git"
    echo ""
    exit 1
fi

# Parse command line arguments
ACTION="${1:-sync}"

case "$ACTION" in
    pull)
        log "Pulling latest changes from remote..."
        git pull --rebase || {
            error "Failed to pull changes"
            exit 1
        }
        log "Pull completed successfully"
        ;;
        
    push)
        log "Checking for local changes..."
        
        # Check if there are any changes to commit
        if [ -n "$(git status --porcelain)" ]; then
            log "Found local changes, committing..."
            git add .
            git commit -m "Vault sync: $(date '+%Y-%m-%d %H:%M:%S')" || {
                error "Failed to commit changes"
                exit 1
            }
        else
            log "No local changes to commit"
        fi
        
        # Push changes to remote
        log "Pushing to remote..."
        git push || {
            error "Failed to push changes"
            exit 1
        }
        log "Push completed successfully"
        ;;
        
    sync)
        log "Starting full sync..."
        
        # Check for merge conflicts first
        if git status | grep -q "Unmerged paths"; then
            warning "Detected unmerged files from previous sync attempt"
            
            # Get list of conflicted files
            CONFLICTED_FILES=$(git diff --name-only --diff-filter=U)
            
            # Check if all conflicts are in auto-generated files
            # Include plan files since Claude updates them with task IDs
            AUTO_GEN_PATTERN="(tasks/(today|stages|tasks)\.md|topics/.*\.md|plans/.*\.md)"
            ALL_AUTO_GEN=true
            
            for file in $CONFLICTED_FILES; do
                if ! echo "$file" | grep -qE "$AUTO_GEN_PATTERN"; then
                    ALL_AUTO_GEN=false
                    break
                fi
            done
            
            if [ "$ALL_AUTO_GEN" = true ]; then
                log "All conflicts are in auto-generated files, accepting remote versions..."
                for file in $CONFLICTED_FILES; do
                    git checkout --theirs "$file"
                    git add "$file"
                done
                
                # If we're in a rebase, continue it
                if [ -d ".git/rebase-merge" ] || [ -d ".git/rebase-apply" ]; then
                    git rebase --continue || git rebase --skip
                fi
            else
                error "Manual conflicts detected in non-auto-generated files"
                error "Please resolve conflicts manually and run sync again"
                exit 1
            fi
        fi
        
        # First, pull any remote changes
        log "Pulling remote changes..."
        git pull --rebase || {
            warning "Pull failed, attempting to resolve..."
            
            # Check if it's just auto-generated files
            CONFLICTED_FILES=$(git diff --name-only --diff-filter=U 2>/dev/null)
            if [ -n "$CONFLICTED_FILES" ]; then
                AUTO_GEN_PATTERN="(tasks/(today|stages|tasks)\.md|topics/.*\.md|plans/.*\.md)"
                ALL_AUTO_GEN=true
                
                for file in $CONFLICTED_FILES; do
                    if ! echo "$file" | grep -qE "$AUTO_GEN_PATTERN"; then
                        ALL_AUTO_GEN=false
                        break
                    fi
                done
                
                if [ "$ALL_AUTO_GEN" = true ]; then
                    log "Auto-generated file conflicts detected, accepting remote versions..."
                    for file in $CONFLICTED_FILES; do
                        git checkout --theirs "$file" 2>/dev/null
                        git add "$file" 2>/dev/null
                    done
                    
                    # Try to continue rebase
                    git rebase --continue 2>/dev/null || git rebase --skip 2>/dev/null
                else
                    # Fall back to stash approach for manual files
                    git rebase --abort 2>/dev/null
                    git stash
                    git pull
                    git stash pop || {
                        error "Conflict detected! Manual intervention required."
                        error "Your changes are saved in git stash"
                        exit 1
                    }
                fi
            else
                # If pull fails for other reasons, try stash
                git stash
                git pull
                git stash pop || {
                    error "Conflict detected! Manual intervention required."
                    error "Your changes are saved in git stash"
                    exit 1
                }
            fi
        }
        
        # Check for local changes and commit them
        if [ -n "$(git status --porcelain)" ]; then
            log "Committing local changes..."
            git add .
            git commit -m "Vault sync: $(date '+%Y-%m-%d %H:%M:%S')"
        fi
        
        # Push to remote
        log "Pushing to remote..."
        git push || {
            error "Failed to push changes"
            exit 1
        }
        
        log "Sync completed successfully"
        ;;
        
    status)
        log "Vault repository status:"
        git status
        echo ""
        log "Recent commits:"
        git log --oneline -5
        ;;
        
    setup-remote)
        REMOTE_URL="${2}"
        if [ -z "$REMOTE_URL" ]; then
            error "Please provide a remote repository URL"
            echo "Usage: $0 setup-remote <repository-url>"
            exit 1
        fi
        
        log "Setting up remote repository..."
        git remote remove origin 2>/dev/null
        git remote add origin "$REMOTE_URL"
        log "Remote repository set to: $REMOTE_URL"
        
        # Set upstream branch
        git push -u origin main || {
            error "Failed to push to remote. Make sure the repository exists and you have access."
            exit 1
        }
        log "Remote setup completed successfully"
        ;;
        
    *)
        echo "Usage: $0 [pull|push|sync|status|setup-remote <url>]"
        echo ""
        echo "Commands:"
        echo "  pull          - Pull latest changes from remote"
        echo "  push          - Commit and push local changes"
        echo "  sync          - Full sync (pull, commit, push)"
        echo "  status        - Show repository status"
        echo "  setup-remote  - Configure remote repository"
        echo ""
        echo "Default action is 'sync' if no command is specified"
        exit 0
        ;;
esac