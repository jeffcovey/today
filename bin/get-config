#!/usr/bin/env python3
"""Read values from config.toml

Usage:
  get-config <key>              # Get top-level key
  get-config <section>.<key>    # Get key from section
  get-config <section>          # Get all keys from section as JSON

Examples:
  get-config timezone           # Returns: America/New_York
  get-config profile.name       # Returns: Your Name
  get-config profile            # Returns: {"name": "...", "vocation": "..."}
  get-config stages.monday      # Returns: front
"""
import sys
import json
import tomllib
from pathlib import Path

def get_nested_value(config, key_path):
    """Get a value from nested config using dot notation."""
    keys = key_path.split('.')
    value = config
    for key in keys:
        if isinstance(value, dict) and key in value:
            value = value[key]
        else:
            return None
    return value

def main():
    if len(sys.argv) < 2:
        print("Usage: get-config <key> or get-config <section>.<key>", file=sys.stderr)
        print("Example: get-config timezone", file=sys.stderr)
        print("Example: get-config profile.name", file=sys.stderr)
        sys.exit(1)

    config_path = Path(__file__).parent.parent / 'config.toml'
    example_path = Path(__file__).parent.parent / 'config.toml.example'

    if not config_path.exists():
        print("config.toml not found!", file=sys.stderr)
        print("", file=sys.stderr)
        print("Create it by copying the example:", file=sys.stderr)
        print("  cp config.toml.example config.toml", file=sys.stderr)
        print("", file=sys.stderr)
        print("Then edit config.toml with your personal settings.", file=sys.stderr)
        sys.exit(1)

    with open(config_path, 'rb') as f:
        config = tomllib.load(f)

    key = sys.argv[1]

    # Try dot notation first (e.g., profile.name)
    if '.' in key:
        value = get_nested_value(config, key)
    elif key in config:
        value = config[key]
    else:
        value = None

    if value is None:
        print(f"Key '{key}' not found in config.toml", file=sys.stderr)
        sys.exit(1)

    # Special handling for timezone - resolve it to a proper timezone
    if key == 'timezone' and isinstance(value, str):
        import subprocess
        result = subprocess.run(
            [Path(__file__).parent / 'resolve-timezone', value],
            capture_output=True,
            text=True
        )
        if result.returncode == 0:
            value = result.stdout.strip()

    # Output dict/list as JSON, otherwise plain text
    if isinstance(value, (dict, list)):
        print(json.dumps(value))
    else:
        print(value)

if __name__ == '__main__':
    main()