#!/usr/bin/env node
/**
 * Read values from config.toml
 *
 * Usage:
 *   get-config <key>              # Get top-level key
 *   get-config <section>.<key>    # Get key from section
 *   get-config <section>          # Get all keys from section as JSON
 *
 * Examples:
 *   get-config timezone           # Returns: America/New_York
 *   get-config profile.name       # Returns: Your Name
 *   get-config profile            # Returns: {"name": "...", "vocation": "..."}
 *   get-config stages.monday      # Returns: front
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { parseTOML, getNestedValue } from '../src/toml-parser.js';
import { findTimezone } from '../src/timezone-resolver.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

function main() {
  if (process.argv.length < 3) {
    console.error('Usage: get-config <key> or get-config <section>.<key>');
    console.error('Example: get-config timezone');
    console.error('Example: get-config profile.name');
    process.exit(1);
  }

  const configPath = path.join(__dirname, '..', 'config.toml');

  if (!fs.existsSync(configPath)) {
    console.error('config.toml not found!');
    console.error('');
    console.error('Create it by copying the example:');
    console.error('  cp config.toml.example config.toml');
    console.error('');
    console.error('Then edit config.toml with your personal settings.');
    process.exit(1);
  }

  const configContent = fs.readFileSync(configPath, 'utf-8');
  const config = parseTOML(configContent);

  const key = process.argv[2];

  // Try dot notation first (e.g., profile.name)
  let value;
  if (key.includes('.')) {
    value = getNestedValue(config, key);
  } else if (key in config) {
    value = config[key];
  } else {
    value = undefined;
  }

  if (value === undefined) {
    console.error(`Key '${key}' not found in config.toml`);
    process.exit(1);
  }

  // Special handling for timezone - resolve it to a proper timezone
  if (key === 'timezone' && typeof value === 'string') {
    try {
      value = findTimezone(value);
    } catch {
      // If resolution fails, use the value as-is
    }
  }

  // Output dict/list as JSON, otherwise plain text
  if (typeof value === 'object' && value !== null) {
    console.log(JSON.stringify(value));
  } else {
    console.log(value);
  }
}

main();
