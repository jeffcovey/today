#!/bin/bash

echo "ğŸš€ Today CLI - Devcontainer Setup"
echo "=================================="
echo ""

# Detect if we're in a devcontainer
if [ ! -f /.dockerenv ] && [ -z "$CODESPACES" ] && [ -z "$REMOTE_CONTAINERS" ]; then
    echo "âš ï¸  This script is designed for devcontainer environments"
    echo "   Use 'bin/setup' for regular environments"
    exit 1
fi

echo "ğŸ“¦ Environment: Devcontainer"
[ -n "$CODESPACES" ] && echo "  Platform: GitHub Codespaces"
[ -n "$REMOTE_CONTAINERS" ] && echo "  Platform: VS Code Remote Containers"
echo ""

# Step 1: Check for .env.local
echo "Step 1: Environment Configuration"
echo "---------------------------------"
if [ -f .env.local ]; then
    echo "âœ… Found .env.local"
    
    # Extract DOTENV_PRIVATE_KEY
    export $(grep -v '^#' .env.local | grep DOTENV_PRIVATE_KEY | xargs) 2>/dev/null
    
    if [ ! -z "$DOTENV_PRIVATE_KEY" ]; then
        echo "âœ… Found DOTENV_PRIVATE_KEY (${#DOTENV_PRIVATE_KEY} chars)"
    else
        echo "âŒ No DOTENV_PRIVATE_KEY found in .env.local"
        echo ""
        echo "Please add your decryption key to .env.local:"
        echo "DOTENV_PRIVATE_KEY=your_key_here"
        exit 1
    fi
else
    echo "âŒ Missing .env.local"
    echo ""
    echo "You need to copy .env.local from your main machine."
    echo "This file contains the decryption key for your credentials."
    echo ""
    echo "On your main machine, run:"
    echo "  cat .env.local"
    echo ""
    echo "Then create .env.local here with that content."
    exit 1
fi
echo ""

# Step 2: Install dependencies and rebuild native modules
echo "Step 2: Dependencies & Native Modules"
echo "-------------------------------------"

# Check if node_modules exists
if [ ! -d "node_modules" ] || [ ! -d "node_modules/@dotenvx/dotenvx" ]; then
    echo "Installing npm dependencies..."
    npm install 2>&1 | grep -v "npm WARN" | grep -v "deprecated" | tail -5
    echo "âœ… Dependencies installed"
else
    echo "âœ… Dependencies already installed"
fi

echo "Rebuilding better-sqlite3 for this platform..."
npm rebuild better-sqlite3 2>&1 | grep -v "npm WARN" | grep -v "deprecated"
echo "âœ… Native modules rebuilt"
echo ""

# Step 3: Test decryption
echo "Step 3: Test Environment Decryption"
echo "-----------------------------------"
echo "Testing dotenvx decryption..."

# Try to get a test value
TEST_VAR=$(npx dotenvx get EMAIL_ACCOUNT 2>/dev/null)
if [ ! -z "$TEST_VAR" ]; then
    echo "âœ… Decryption working (EMAIL_ACCOUNT: ${TEST_VAR:0:10}...)"
else
    echo "âŒ Decryption failed"
    echo ""
    echo "Possible issues:"
    echo "1. Wrong DOTENV_PRIVATE_KEY in .env.local"
    echo "2. .env file not properly encrypted"
    echo ""
    echo "Try running:"
    echo "  npx dotenvx get --all"
    echo ""
    echo "If that fails, you may need to re-encrypt on main machine:"
    echo "  npx dotenvx set EMAIL_ACCOUNT=your_email"
    exit 1
fi
echo ""

# Step 4: Check for config files
echo "Step 4: Configuration Files"
echo "---------------------------"

if [ -f config/calendars.json ]; then
    CAL_COUNT=$(grep -c '"url"' config/calendars.json 2>/dev/null || echo "0")
    echo "âœ… Calendar config found ($CAL_COUNT calendars)"
else
    echo "âš ï¸  No calendar config (optional)"
    echo "   Copy config/calendars.json.example to config/calendars.json and add your calendar URLs"
fi

echo ""

# Step 5: Claude CLI
echo "Step 5: Claude CLI Authentication"
echo "---------------------------------"
if command -v claude &> /dev/null; then
    echo "âœ… Claude CLI is installed"
    
    # Test if authenticated
    TEST_RESPONSE=$(echo "test" | timeout 2 claude 2>&1 | head -1)
    if echo "$TEST_RESPONSE" | grep -q "Invalid API key\|Please run /login"; then
        echo "âŒ Claude not authenticated"
        echo ""
        echo "To authenticate Claude:"
        echo "  1. Run: claude"
        echo "  2. Follow the browser prompt to login"
        echo ""
    else
        echo "âœ… Claude appears to be authenticated"
    fi
else
    echo "âŒ Claude CLI not installed"
    echo ""
    echo "Installing Claude CLI is optional but recommended."
    echo "To install: npm install -g @anthropic-ai/sdk"
fi
echo ""

# Final summary
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ¨ Setup Summary"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Count successes
SUCCESS_COUNT=0
[ ! -z "$DOTENV_PRIVATE_KEY" ] && ((SUCCESS_COUNT++))
[ ! -z "$TEST_VAR" ] && ((SUCCESS_COUNT++))
[ -f config/calendars.json ] && ((SUCCESS_COUNT++))

if [ $SUCCESS_COUNT -ge 2 ]; then
    echo "âœ… Basic setup complete!"
    echo ""
    echo "You can now use:"
    echo "  bin/sync    - Sync all data sources"
    echo "  bin/today   - Run daily review"
    echo "  bin/status  - Check task status"
    echo ""
    echo "Run 'bin/diagnose' for detailed status"
else
    echo "âš ï¸  Setup incomplete"
    echo ""
    echo "Required steps:"
    echo "  1. Ensure .env.local has correct DOTENV_PRIVATE_KEY"
    echo "  2. Test with: npx dotenvx get --all"
    echo ""
    echo "Optional steps:"
    echo "  - Copy config/calendars.json.example to config/calendars.json and add your calendar URLs"
    echo "  - Authenticate Claude CLI"
fi