#!/bin/bash

# Create Time Machine-style incremental backups using hard links
# Very space-efficient for unchanged files

# Get the directory where this script lives, then go to parent (project root)
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
VAULT_DIR="$PROJECT_DIR/vault"
BACKUP_ROOT="${HOME}/vault-snapshots"
DATE=$(date +%Y%m%d-%H%M%S)
LATEST_LINK="${BACKUP_ROOT}/latest"
BACKUP_DIR="${BACKUP_ROOT}/${DATE}"

# Create backup root if it doesn't exist
mkdir -p "$BACKUP_ROOT"

# Create new backup using hard links to previous backup (saves space)
if [ -L "$LATEST_LINK" ]; then
    # Incremental backup using hard links
    echo "Creating incremental snapshot..."
    rsync -a --link-dest="$LATEST_LINK" "$VAULT_DIR/" "$BACKUP_DIR/"
else
    # First backup
    echo "Creating initial snapshot..."
    rsync -a "$VAULT_DIR/" "$BACKUP_DIR/"
fi

# Update latest symlink
rm -f "$LATEST_LINK"
ln -s "$BACKUP_DIR" "$LATEST_LINK"

# Keep only last 30 snapshots
echo "Cleaning old snapshots..."
ls -dt "$BACKUP_ROOT"/2* 2>/dev/null | tail -n +31 | xargs rm -rf 2>/dev/null

echo "âœ“ Snapshot complete!"
echo "  Saved to: $BACKUP_DIR"
echo "  Latest: $LATEST_LINK"
echo ""
echo "Recent snapshots:"
ls -la "$BACKUP_ROOT" | grep "^d" | tail -5

echo ""
echo "To browse snapshots:"
echo "  ls $BACKUP_ROOT/"
echo ""
echo "To restore a file:"
echo "  cp $BACKUP_ROOT/20250826-123456/path/to/file vault/path/to/file"