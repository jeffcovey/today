#!/bin/bash
# Tailscale setup script for remote access
# Configures Tailscale for secure remote connectivity

set -e

echo "Setting up Tailscale for remote access..."
echo ""

# Check if Tailscale is installed
if ! command -v tailscale &> /dev/null; then
    echo "‚ùå Tailscale is not installed!"
    echo "Please rebuild the devcontainer to install Tailscale."
    exit 1
fi

# Check Tailscale status
STATUS=$(tailscale status --json 2>/dev/null || echo "{}")

if echo "$STATUS" | grep -q '"BackendState":"Running"'; then
    echo "‚úÖ Tailscale is already running!"
    
    # Get the Tailscale IP
    TAILSCALE_IP=$(tailscale ip -4 2>/dev/null || echo "Not available")
    HOSTNAME=$(hostname)
    
    echo ""
    echo "üì± Connection Information:"
    echo "=========================="
    echo "Tailscale IP: $TAILSCALE_IP"
    echo "Hostname: $HOSTNAME"
    echo ""
    echo "SSH Access: ssh node@$TAILSCALE_IP -p 2222"
    echo ""
else
    echo "‚ö†Ô∏è  Tailscale needs authentication"
    echo ""
    
    # Check for authkey
    if [ -n "$TAILSCALE_AUTHKEY" ]; then
        echo "Using provided auth key..."
        sudo tailscale up --authkey="$TAILSCALE_AUTHKEY" --ssh
    else
        echo "To set up Tailscale, you have two options:"
        echo ""
        echo "Option 1: Interactive Login (Recommended for first time)"
        echo "  Run: sudo tailscale up --ssh"
        echo "  This will provide a URL to authenticate"
        echo ""
        echo "Option 2: Auth Key (For automated setup)"
        echo "  1. Go to https://login.tailscale.com/admin/settings/keys"
        echo "  2. Generate an auth key"
        echo "  3. Set TAILSCALE_AUTHKEY environment variable"
        echo "  4. Rebuild the container"
        echo ""
        echo "Would you like to start interactive login now? (y/n)"
        read -r response
        
        if [[ "$response" =~ ^[Yy]$ ]]; then
            sudo tailscale up --ssh
        fi
    fi
fi

# Ensure SSH is configured to listen on all interfaces
if [ -f /etc/ssh/sshd_config.d/devcontainer.conf ]; then
    echo ""
    echo "Updating SSH configuration for Tailscale access..."
    sudo sed -i 's/^Port 2222$/Port 2222\nListenAddress 0.0.0.0/' /etc/ssh/sshd_config.d/devcontainer.conf
    sudo service ssh restart
fi

echo ""
echo "üìö Next Steps:"
echo "============="
echo "1. Install Tailscale on your iPad from the App Store"
echo "2. Sign in with the same account"
echo "3. Your container will appear in the Tailscale network"
echo "4. Connect using SSH client or VS Code for Web"
echo ""
echo "üîí Security Note:"
echo "All connections are encrypted end-to-end using WireGuard"
echo ""