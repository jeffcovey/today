#!/bin/bash

# Diagnostic script to check configuration issues

# Load dotenvx if available
if [ -f "$(dirname "$0")/lib/dotenvx-loader.sh" ]; then
    source "$(dirname "$0")/lib/dotenvx-loader.sh"
    auto_dotenvx "$@"
fi

echo "üîç Today CLI Diagnostics"
echo "========================"
echo ""

# Check environment
echo "üì¶ Environment:"
echo "  Working directory: $(pwd)"
echo "  User: $(whoami)"
echo "  Node version: $(node --version 2>/dev/null || echo "Not found")"
echo "  NPM version: $(npm --version 2>/dev/null || echo "Not found")"
echo ""

# Check .env files
echo "üîê Environment Files:"
[ -f .env ] && echo "  ‚úÖ .env exists" || echo "  ‚ùå .env missing"
[ -f .env.local ] && echo "  ‚úÖ .env.local exists" || echo "  ‚ö†Ô∏è  .env.local missing"
[ -f .env.keys ] && echo "  ‚úÖ .env.keys exists" || echo "  ‚ö†Ô∏è  .env.keys missing"
echo ""

# Check DOTENV_PRIVATE_KEY
echo "üîë Encryption Key:"
# Try to load from .env.local if not set
if [ -z "$DOTENV_PRIVATE_KEY" ] && [ -f .env.local ]; then
    export $(grep -v '^#' .env.local | grep DOTENV_PRIVATE_KEY | xargs) 2>/dev/null
fi

if [ ! -z "$DOTENV_PRIVATE_KEY" ]; then
    echo "  ‚úÖ DOTENV_PRIVATE_KEY is set (${#DOTENV_PRIVATE_KEY} chars)"
    
    # Try to decrypt environment variables
    if [ -f node_modules/@dotenvx/dotenvx/src/cli/dotenvx.js ]; then
        echo "  üîÑ Attempting to decrypt environment variables..."
        # Use dotenvx to export decrypted vars
        eval "$(npx dotenvx get --all --format shell 2>/dev/null)"
    fi
else
    echo "  ‚ùå DOTENV_PRIVATE_KEY not set"
fi
echo ""

# Check decrypted values
echo "üìß Email Configuration:"
if [ ! -z "$EMAIL_ACCOUNT" ]; then
    echo "  ‚úÖ EMAIL_ACCOUNT is set: ${EMAIL_ACCOUNT:0:10}..."
else
    echo "  ‚ùå EMAIL_ACCOUNT not available"
fi
if [ ! -z "$EMAIL_PASSWORD" ]; then
    echo "  ‚úÖ EMAIL_PASSWORD is set"
else
    echo "  ‚ùå EMAIL_PASSWORD not available"
fi
echo ""

# Check calendar configuration
echo "üìÖ Calendar Configuration:"
if [ -f config/calendars.json ]; then
    CAL_COUNT=$(grep -c '"url"' config/calendars.json 2>/dev/null || echo "0")
    echo "  ‚úÖ config/calendars.json exists ($CAL_COUNT calendars)"
else
    echo "  ‚ùå config/calendars.json missing"
fi
if [ ! -z "$GOOGLE_SERVICE_ACCOUNT_KEY" ]; then
    echo "  ‚úÖ GOOGLE_SERVICE_ACCOUNT_KEY is set"
else
    echo "  ‚ö†Ô∏è  GOOGLE_SERVICE_ACCOUNT_KEY not set"
fi
echo ""

# Check databases
echo "üíæ Databases:"
if [ -d .calendar-cache ]; then
    echo "  ‚úÖ Calendar cache directory exists"
else
    echo "  ‚ö†Ô∏è  Calendar cache directory missing"
fi
echo ""

# Check native modules (check for all platforms)
echo "üîß Native Modules:"
BETTER_SQLITE_FOUND=false
for binding_dir in node_modules/better-sqlite3/lib/binding/*/; do
    if [ -d "$binding_dir" ] && [ -f "${binding_dir}node_sqlite3.node" ]; then
        BETTER_SQLITE_FOUND=true
        PLATFORM=$(basename "$binding_dir")
        echo "  ‚úÖ better-sqlite3 native module found ($PLATFORM)"
        break
    fi
done

if [ "$BETTER_SQLITE_FOUND" = false ]; then
    echo "  ‚ùå better-sqlite3 native module missing (rebuild needed)"
    echo "     Run: npm rebuild better-sqlite3"
fi
echo ""

# Check Claude CLI
echo "ü§ñ Claude CLI:"
if command -v claude &> /dev/null; then
    echo "  ‚úÖ Claude CLI installed"
    TEST_RESPONSE=$(echo "test" | timeout 2 claude 2>&1 | head -1)
    if echo "$TEST_RESPONSE" | grep -q "Invalid API key\|Please run /login"; then
        echo "  ‚ùå Claude not authenticated"
    elif echo "$TEST_RESPONSE" | grep -q "usage limit reached"; then
        echo "  ‚ö†Ô∏è  Claude rate limit reached"
    else
        echo "  ‚úÖ Claude appears to be working"
    fi
else
    echo "  ‚ùå Claude CLI not found"
fi
echo ""

# Check if we're in a devcontainer
if [ -f /.dockerenv ] || [ -n "$CODESPACES" ] || [ -n "$REMOTE_CONTAINERS" ]; then
    echo "üì¶ Container Environment:"
    echo "  ‚úÖ Running in container/devcontainer"
    if [ -n "$CODESPACES" ]; then
        echo "  ‚úÖ GitHub Codespaces detected"
    fi
    if [ -n "$REMOTE_CONTAINERS" ]; then
        echo "  ‚úÖ VS Code devcontainer detected"
    fi
    echo ""
fi

echo "üèÅ Diagnostics complete"
echo ""

# Provide specific guidance based on what we found
echo "To fix issues:"

if [ ! -f .env.local ]; then
    echo "  - Missing .env.local: Copy from your main machine"
elif [ -z "$DOTENV_PRIVATE_KEY" ]; then
    echo "  - Missing decryption key: Check .env.local has DOTENV_PRIVATE_KEY"
fi

if [ ! -z "$DOTENV_PRIVATE_KEY" ] && [ -z "$EMAIL_ACCOUNT" ]; then
    echo "  - Decryption failed: Try 'npx dotenvx get EMAIL_ACCOUNT' to debug"
    echo "    If that fails, you may need to regenerate encrypted .env"
fi

if [ "$BETTER_SQLITE_FOUND" = false ]; then
    echo "  - Native modules: Run 'npm rebuild better-sqlite3'"
fi

if [ ! -f config/calendars.json ]; then
    echo "  - Calendar config: Copy config/calendars.json.example to config/calendars.json and add your calendar URLs"
fi

if ! command -v claude &> /dev/null; then
    echo "  - Claude CLI: Install with 'npm install -g @anthropic-ai/sdk'"
elif echo "$TEST_RESPONSE" | grep -q "Invalid API key\|Please run /login"; then
    echo "  - Claude auth: Run 'claude' and follow login prompts"
fi

# If in devcontainer, provide specific guidance
if [ -f /.dockerenv ] || [ -n "$CODESPACES" ] || [ -n "$REMOTE_CONTAINERS" ]; then
    echo ""
    echo "üìù Devcontainer Quick Setup:"
    echo "  1. Copy .env.local from your main machine"
    echo "  2. Run: npm rebuild better-sqlite3"
    echo "  3. Run: npx dotenvx get --all  # Test decryption"
    echo "  4. Run: claude  # Authenticate Claude CLI"
fi