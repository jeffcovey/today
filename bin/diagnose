#!/bin/bash

# Diagnostic script to check configuration issues

echo "üîç Today CLI Diagnostics"
echo "========================"
echo ""

# Check environment
echo "üì¶ Environment:"
echo "  Working directory: $(pwd)"
echo "  User: $(whoami)"
echo "  Node version: $(node --version 2>/dev/null || echo "Not found")"
echo "  NPM version: $(npm --version 2>/dev/null || echo "Not found")"
echo ""

# Check .env files
echo "üîê Environment Files:"
[ -f .env ] && echo "  ‚úÖ .env exists" || echo "  ‚ùå .env missing"
[ -f .env.local ] && echo "  ‚úÖ .env.local exists" || echo "  ‚ö†Ô∏è  .env.local missing"
[ -f .env.keys ] && echo "  ‚úÖ .env.keys exists" || echo "  ‚ö†Ô∏è  .env.keys missing"
echo ""

# Check DOTENV_PRIVATE_KEY
echo "üîë Encryption Key:"
if [ ! -z "$DOTENV_PRIVATE_KEY" ]; then
    echo "  ‚úÖ DOTENV_PRIVATE_KEY is set (${#DOTENV_PRIVATE_KEY} chars)"
else
    echo "  ‚ùå DOTENV_PRIVATE_KEY not set"
fi
echo ""

# Check decrypted values
echo "üìß Email Configuration:"
source "$(dirname "$0")/lib/dotenvx-loader.sh" 2>/dev/null
if [ ! -z "$EMAIL_ACCOUNT" ]; then
    echo "  ‚úÖ EMAIL_ACCOUNT is set: ${EMAIL_ACCOUNT:0:10}..."
else
    echo "  ‚ùå EMAIL_ACCOUNT not available"
fi
if [ ! -z "$EMAIL_PASSWORD" ]; then
    echo "  ‚úÖ EMAIL_PASSWORD is set"
else
    echo "  ‚ùå EMAIL_PASSWORD not available"
fi
echo ""

# Check Notion configuration
echo "üìä Notion Configuration:"
if [ ! -z "$NOTION_TOKEN" ]; then
    echo "  ‚úÖ NOTION_TOKEN is set"
else
    echo "  ‚ùå NOTION_TOKEN not available"
fi
echo ""

# Check Todoist configuration
echo "‚úÖ Todoist Configuration:"
if [ ! -z "$TODOIST_TOKEN" ]; then
    echo "  ‚úÖ TODOIST_TOKEN is set"
else
    echo "  ‚ùå TODOIST_TOKEN not available"
fi
echo ""

# Check calendar configuration
echo "üìÖ Calendar Configuration:"
if [ -f config/calendars.json ]; then
    CAL_COUNT=$(grep -c '"url"' config/calendars.json 2>/dev/null || echo "0")
    echo "  ‚úÖ config/calendars.json exists ($CAL_COUNT calendars)"
else
    echo "  ‚ùå config/calendars.json missing"
fi
if [ ! -z "$GOOGLE_SERVICE_ACCOUNT_KEY" ]; then
    echo "  ‚úÖ GOOGLE_SERVICE_ACCOUNT_KEY is set"
else
    echo "  ‚ö†Ô∏è  GOOGLE_SERVICE_ACCOUNT_KEY not set"
fi
echo ""

# Check databases
echo "üíæ Databases:"
if [ -f .notion-cache/notion-cache.db ]; then
    SIZE=$(du -h .notion-cache/notion-cache.db | cut -f1)
    echo "  ‚úÖ Notion cache exists ($SIZE)"
else
    echo "  ‚ö†Ô∏è  Notion cache not initialized"
fi
if [ -d .calendar-cache ]; then
    echo "  ‚úÖ Calendar cache directory exists"
else
    echo "  ‚ö†Ô∏è  Calendar cache directory missing"
fi
echo ""

# Check native modules
echo "üîß Native Modules:"
if [ -f node_modules/better-sqlite3/lib/binding/napi-v6-linux-x64/node_sqlite3.node ] || \
   [ -f node_modules/better-sqlite3/lib/binding/napi-v3-linux-x64/node_sqlite3.node ]; then
    echo "  ‚úÖ better-sqlite3 native module found"
else
    echo "  ‚ùå better-sqlite3 native module missing (rebuild needed)"
    echo "     Run: npm rebuild better-sqlite3"
fi
echo ""

# Check Claude
echo "ü§ñ Claude CLI:"
if command -v claude >/dev/null 2>&1; then
    echo "  ‚úÖ Claude CLI installed"
    TEST_RESPONSE=$(echo "test" | timeout 2 claude 2>&1 | head -1)
    if echo "$TEST_RESPONSE" | grep -q "Invalid API key\|Please run /login"; then
        echo "  ‚ùå Claude not authenticated"
    elif echo "$TEST_RESPONSE" | grep -q "usage limit reached"; then
        echo "  ‚ö†Ô∏è  Claude rate limit reached"
    else
        echo "  ‚úÖ Claude appears to be working"
    fi
else
    echo "  ‚ùå Claude CLI not found"
fi
echo ""

echo "üèÅ Diagnostics complete"
echo ""
echo "To fix issues:"
echo "  - Missing .env.local: Run 'bin/docker-setup'"
echo "  - Missing native modules: Run 'npm rebuild'"
echo "  - Missing calendars.json: Run 'bin/setup --calendar'"
echo "  - Claude auth: Run 'claude' and follow prompts"