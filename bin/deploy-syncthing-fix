#!/bin/bash

# Deploy Syncthing fixes to droplet
# This script applies all reliability improvements

set -e

# Load environment
if [ -z "$DOTENVX_INJECTED" ]; then
    export DOTENVX_INJECTED=1
    exec npx dotenvx run -- "$0" "$@"
fi

# Configuration
DROPLET_IP="${DO_DROPLET_IP:-}"
DROPLET_USER="${DO_DROPLET_USER:-root}"
SSH_KEY="${HOME}/.ssh/do_deploy_key"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

print_status() { echo -e "${GREEN}âœ“${NC} $1"; }
print_info() { echo -e "${BLUE}â„¹${NC} $1"; }
print_warning() { echo -e "${YELLOW}âš ${NC} $1"; }
print_error() { echo -e "${RED}âœ—${NC} $1"; }

# Check configuration
if [ -z "$DROPLET_IP" ]; then
    print_error "DROPLET_IP not set!"
    exit 1
fi

echo "ðŸ”§ Deploying Syncthing reliability fixes..."

# 1. Copy health check script
print_info "Installing health check script..."
scp -i "$SSH_KEY" bin/syncthing-health-check ${DROPLET_USER}@${DROPLET_IP}:/opt/today/bin/
ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "chmod +x /opt/today/bin/syncthing-health-check"

# 2. Update systemd service
print_info "Updating systemd service..."
scp -i "$SSH_KEY" config/syncthing-improved.service ${DROPLET_USER}@${DROPLET_IP}:/tmp/syncthing.service
ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << 'EOF'
    # Backup current service
    cp /etc/systemd/system/syncthing.service /etc/systemd/system/syncthing.service.backup 2>/dev/null || true
    
    # Install new service
    mv /tmp/syncthing.service /etc/systemd/system/syncthing.service
    systemctl daemon-reload
    
    # Don't restart if already running healthy
    if systemctl is-active syncthing > /dev/null 2>&1; then
        echo "Syncthing is running, skipping restart"
    else
        systemctl restart syncthing
    fi
EOF

# 3. Install cron job for monitoring
print_info "Installing monitoring cron job..."
ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << 'EOF'
    # Create cron job
    cat > /etc/cron.d/syncthing-monitor << 'CRON'
# Syncthing Health Monitor
SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# Every 5 minutes, check health
*/5 * * * * root /opt/today/bin/syncthing-health-check check >> /var/log/syncthing-health.log 2>&1

# Every hour, clean logs
0 * * * * root journalctl --vacuum-time=24h > /dev/null 2>&1

# Daily restart at 3 AM
0 3 * * * root systemctl restart syncthing >> /var/log/syncthing-health.log 2>&1
CRON
    
    # Reload cron
    systemctl reload cron
    echo "Cron job installed"
EOF

# 4. Create log rotation
print_info "Setting up log rotation..."
ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << 'EOF'
    cat > /etc/logrotate.d/syncthing-health << 'LOGROTATE'
/var/log/syncthing-health.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
}
LOGROTATE
EOF

# 5. Run initial health check
print_info "Running health check..."
ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "/opt/today/bin/syncthing-health-check status"

# 6. Fix any immediate issues
print_info "Checking for and fixing any current issues..."
ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "/opt/today/bin/syncthing-health-check check"

print_status "Syncthing reliability fixes deployed!"
echo ""
echo "Improvements applied:"
echo "  âœ“ Health check script installed (/opt/today/bin/syncthing-health-check)"
echo "  âœ“ Improved systemd service with better restart policies"
echo "  âœ“ Cron monitoring every 5 minutes with auto-recovery"
echo "  âœ“ Daily restart at 3 AM to clear accumulated issues"
echo "  âœ“ Log rotation configured"
echo ""
echo "Monitor health with: bin/deploy-do exec '/opt/today/bin/syncthing-health-check status'"
echo "View logs with: bin/deploy-do exec 'tail -f /var/log/syncthing-health.log'"