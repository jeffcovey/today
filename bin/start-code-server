#!/bin/bash
set -e

# Get project and host information
PROJECT_NAME=$(basename "$(pwd)")
HOST_MACHINE=$(hostname -s 2>/dev/null || hostname)
TAILSCALE_IP=$(tailscale ip -4 2>/dev/null || echo "")
TAILSCALE_HOSTNAME=$(tailscale status --json 2>/dev/null | jq -r '.Self.HostName' 2>/dev/null || echo "")

# Install code-server if not already installed
if ! command -v code-server &> /dev/null; then
    echo "Installing code-server..."
    curl -fsSL https://code-server.dev/install.sh | sh
fi

# Create config directory
mkdir -p ~/.config/code-server

# Get password from environment or use default
CODE_SERVER_PASSWORD="${CODE_SERVER_PASSWORD:-ipad2025}"

# Generate config with password auth
cat > ~/.config/code-server/config.yaml <<EOF
bind-addr: 0.0.0.0:8081
auth: password
password: $CODE_SERVER_PASSWORD
cert: false
EOF

# Kill any existing code-server processes (but not VS Code's own processes)
pkill -f "code-server --bind-addr" 2>/dev/null || true

# Wait for port to be free
sleep 2

# Start code-server
echo "Starting code-server for project: $PROJECT_NAME"
echo "Host machine: $HOST_MACHINE"
if [ -n "$TAILSCALE_IP" ]; then
    echo "Tailscale IP: $TAILSCALE_IP"
    echo "Access at: http://$TAILSCALE_IP:8081"
fi
if [ -n "$TAILSCALE_HOSTNAME" ] && [ "$TAILSCALE_HOSTNAME" != "null" ]; then
    echo "Tailscale hostname: $TAILSCALE_HOSTNAME"
    # Set up a friendly hostname if MagicDNS is enabled
    echo "MagicDNS URL: http://$TAILSCALE_HOSTNAME:8081"
fi

# Run code-server in background with verbose logging
# Temporarily unset VS Code IPC hook for code-server only
(unset VSCODE_IPC_HOOK_CLI && nohup code-server --bind-addr 0.0.0.0:8081 --auth password --disable-telemetry --log debug /workspaces/$PROJECT_NAME > ~/.config/code-server/code-server.log 2>&1) &

# Save PID for later management
echo $! > ~/.config/code-server/code-server.pid

echo "code-server started with PID $(cat ~/.config/code-server/code-server.pid)"
echo "Logs available at: ~/.config/code-server/code-server.log"

# Wait a moment and check if it's running
sleep 3
if ps -p $(cat ~/.config/code-server/code-server.pid) > /dev/null; then
    echo "✓ code-server is running successfully"
    # Check if it's actually listening on port 8081
    if netstat -tlnp 2>/dev/null | grep :8081 > /dev/null; then
        echo "✓ code-server is listening on port 8081"
    else
        echo "⚠ code-server process exists but not listening on port 8081"
    fi
else
    echo "✗ code-server failed to start. Check logs at ~/.config/code-server/code-server.log"
    if [ -f ~/.config/code-server/code-server.log ] && [ -s ~/.config/code-server/code-server.log ]; then
        cat ~/.config/code-server/code-server.log
    else
        echo "Log file is empty or doesn't exist. Trying to run code-server directly:"
        code-server --bind-addr 0.0.0.0:8081 --auth password --disable-telemetry /workspaces/$PROJECT_NAME &
        sleep 2
        jobs
        kill %1 2>/dev/null || true
    fi
    exit 1
fi