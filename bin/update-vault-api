#!/bin/bash
# Update vault-api deployment to combined version
# This ensures the vault-api includes both read and write functionality

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

print_status() { echo -e "${GREEN}✓${NC} $1"; }
print_info() { echo -e "${BLUE}ℹ${NC} $1"; }
print_warning() { echo -e "${YELLOW}⚠${NC} $1"; }
print_error() { echo -e "${RED}✗${NC} $1"; }

print_info "Updating vault-api to combined version (vault + inbox)..."

# Get SSH key path
SSH_KEY="${HOME}/.ssh/do_deploy_key"
DROPLET_IP="today.jeffcovey.net"
DROPLET_USER="root"

# Stop old inbox-api if running
print_info "Stopping old inbox-api service if running..."
ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << 'EOF'
systemctl stop inbox-api 2>/dev/null || true
systemctl disable inbox-api 2>/dev/null || true
EOF

# Copy updated vault-api.js
print_info "Deploying updated vault-api.js..."
scp -i "$SSH_KEY" /workspaces/today/src/vault-api.js ${DROPLET_USER}@${DROPLET_IP}:/opt/today/src/

# Update systemd service to remove ReadOnlyPaths restriction
print_info "Updating systemd service configuration..."
ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << 'EOF'
# Remove ReadOnlyPaths restriction for vault directory
sed -i '/ReadOnlyPaths=\/opt\/today\/vault/d' /etc/systemd/system/vault-api.service

# Reload and restart service
systemctl daemon-reload
systemctl restart vault-api
sleep 2
EOF

# Fix nginx configuration to use only vault-api on port 3334
print_info "Updating nginx configuration..."
ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} << 'EOF'
# Backup current config
cp /etc/nginx/sites-available/today.jeffcovey.net /etc/nginx/sites-available/today.jeffcovey.net.backup

# Create cleaned config (removing old inbox-api on port 3333)
cat > /tmp/nginx-update.sh << 'SCRIPT'
#!/bin/bash
# Remove any location blocks pointing to port 3333
sed -i '/location \/api\/inbox\/ {/,/^[[:space:]]*}/ {
    /proxy_pass.*3333/d
}' /etc/nginx/sites-available/today.jeffcovey.net

# Ensure both vault and inbox endpoints point to port 3334
if ! grep -q "location /api/vault/" /etc/nginx/sites-available/today.jeffcovey.net; then
    # Add vault location if missing
    sed -i '/location \/ {/i\
    location /api/vault/ {\
        proxy_pass http://127.0.0.1:3334/vault/;\
        proxy_http_version 1.1;\
        proxy_set_header Upgrade $http_upgrade;\
        proxy_set_header Connection '"'"'upgrade'"'"';\
        proxy_set_header Host $host;\
        proxy_cache_bypass $http_upgrade;\
        proxy_set_header X-Real-IP $remote_addr;\
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\
        proxy_set_header X-Forwarded-Proto $scheme;\
        client_max_body_size 10M;\
        proxy_connect_timeout 60s;\
        proxy_send_timeout 60s;\
        proxy_read_timeout 60s;\
    }\
' /etc/nginx/sites-available/today.jeffcovey.net
fi

# Ensure inbox endpoint points to port 3334
if grep -q "proxy_pass.*3333" /etc/nginx/sites-available/today.jeffcovey.net; then
    sed -i 's|proxy_pass http://127.0.0.1:3333/|proxy_pass http://127.0.0.1:3334/|g' /etc/nginx/sites-available/today.jeffcovey.net
fi
SCRIPT

bash /tmp/nginx-update.sh
rm /tmp/nginx-update.sh

# Test and reload nginx
nginx -t && systemctl reload nginx
EOF

# Test the deployment
print_info "Testing deployment..."
API_KEY=$(ssh -i "$SSH_KEY" ${DROPLET_USER}@${DROPLET_IP} "grep INBOX_API_KEY /opt/today/.inbox-api-key | cut -d= -f2")

# Test health endpoint
if curl -s https://${DROPLET_IP}/api/health | grep -q "vault-api"; then
    print_status "Health check passed"
else
    print_error "Health check failed"
fi

# Test vault list endpoint
if curl -s -H "X-API-Key: ${API_KEY}" https://${DROPLET_IP}/api/vault/list | jq -e '.success' > /dev/null 2>&1; then
    print_status "Vault list endpoint working"
else
    print_error "Vault list endpoint failed"
fi

# Test inbox upload endpoint
TEST_CONTENT="# Test Upload\n\nDeployment test at $(date)"
if curl -s -X POST -H "X-API-Key: ${API_KEY}" -H "Content-Type: text/plain" -d "$TEST_CONTENT" https://${DROPLET_IP}/api/inbox/upload | jq -e '.success' > /dev/null 2>&1; then
    print_status "Inbox upload endpoint working"
else
    print_error "Inbox upload endpoint failed"
fi

print_status "Vault-API update complete!"
echo ""
print_info "Combined vault-api is now running with:"
echo "  - Read access: /api/vault/*"
echo "  - Write access: /api/inbox/*"
echo "  - API Key: ${API_KEY}"
echo ""
print_info "Use this API key in your Drafts scripts"