#!/bin/bash
# Clean up Syncthing conflict files and store backups centrally

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}=== Syncthing Conflict Cleanup ===${NC}"

# Get the directory where this script lives, then go to parent (project root)
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
VAULT_DIR="$PROJECT_DIR/vault"

# Check if vault directory exists
if [ ! -d "$VAULT_DIR" ]; then
    echo -e "${RED}Error: Cannot find vault directory at $VAULT_DIR${NC}"
    exit 1
fi

echo -e "Working with vault at: ${VAULT_DIR}"

# Count conflicts
CONFLICT_COUNT=$(find "$VAULT_DIR" -name "*.sync-conflict-*" -type f -not -path "*/.backups/*" -not -path "*/.stversions/*" 2>/dev/null | wc -l)

if [ "$CONFLICT_COUNT" -eq 0 ]; then
    echo -e "${GREEN}No sync-conflict files found. Vault is clean!${NC}"
    exit 0
fi

echo -e "${YELLOW}Found ${CONFLICT_COUNT} sync-conflict files${NC}"

# Create centralized backup directory with timestamp
BACKUP_BASE="${VAULT_DIR}/.backups/conflict-backups"
mkdir -p "$BACKUP_BASE"
BACKUP_DIR="${BACKUP_BASE}/backup-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$BACKUP_DIR"

echo -e "Creating backup in: ${BACKUP_DIR}"

# Find and process each conflict file (excluding already backed up files)
find "$VAULT_DIR" -name "*.sync-conflict-*" -type f -not -path "*/.backups/*" -not -path "*/.stversions/*" | while read -r conflict_file; do
    # Get the relative path from vault root
    rel_path="${conflict_file#$VAULT_DIR/}"
    
    # Create directory structure in backup
    backup_subdir=$(dirname "$rel_path")
    mkdir -p "$BACKUP_DIR/$backup_subdir"
    
    # Move conflict file to backup
    mv "$conflict_file" "$BACKUP_DIR/$rel_path"
    echo -e "  Backed up: $rel_path"
done

echo -e "${GREEN}âœ“ Moved ${CONFLICT_COUNT} conflict files to backup${NC}"
echo -e "Backup location: ${BACKUP_DIR}"
echo ""
echo "Backups are stored in: ${VAULT_DIR}/.backups/conflict-backups/"
echo "These backups are excluded from Syncthing and processing scripts."
echo ""
echo "To restore specific files: mv '${BACKUP_DIR}/path/to/file' '${VAULT_DIR}/path/to/file'"
echo "To remove old backups after review: rm -rf '${VAULT_DIR}/.backups/conflict-backups/backup-*'"