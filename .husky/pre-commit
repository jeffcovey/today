#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if any JavaScript source files are being committed
STAGED_JS=$(echo "$STAGED_FILES" | grep -E '^src/.*\.js$' || true)

# Update file dates index for new markdown files
bin/update-file-dates-index

# Run markdownlint on staged markdown files
STAGED_MD=$(echo "$STAGED_FILES" | grep '\.md$' || true)

if [ -n "$STAGED_MD" ]; then
  echo "Running markdownlint on staged markdown files..."
  npx markdownlint-cli2 $STAGED_MD
  
  if [ $? -ne 0 ]; then
    echo ""
    echo "❌ Markdown linting failed. Fix the issues above or run:"
    echo "   npm run lint:md:fix"
    echo ""
    exit 1
  fi
fi

# Only run tests if source code changed
if [ -n "$STAGED_JS" ]; then
  echo "JavaScript source files changed, running tests..."
  
  # Run only tests related to changed files
  npm test -- --bail --findRelatedTests $STAGED_JS
  
  if [ $? -ne 0 ]; then
    echo ""
    echo "❌ Tests failed. Please fix the failing tests before committing."
    echo ""
    exit 1
  fi
  
  echo "✅ All tests passed!"
else
  echo "No JavaScript source files changed, skipping tests."
fi

exit 0