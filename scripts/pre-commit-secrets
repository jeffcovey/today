#!/bin/sh
# Pre-commit hook to prevent accidental secret commits
# Install: cp scripts/pre-commit-secrets .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

# Get files being committed
if git rev-parse --verify HEAD >/dev/null 2>&1; then
    against=HEAD
else
    # Initial commit: diff against an empty tree object
    against=$(git hash-object -t tree /dev/null)
fi

# Patterns that indicate potential secrets
# Note: These are regex patterns for grep -E
SECRET_PATTERNS='
sk-ant-api[a-zA-Z0-9_-]{40,}
ghp_[a-zA-Z0-9]{36}
github_pat_[a-zA-Z0-9_]{22,}
-----BEGIN (RSA |DSA |EC |OPENSSH )?PRIVATE KEY-----
AKIA[0-9A-Z]{16}
xox[baprs]-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24}
'

# Files to exclude from checks (encrypted files, examples, docs)
EXCLUDE_PATTERN='\.env\.example|NATURAL_LANGUAGE_SEARCH\.md|TAILSCALE_SETUP\.md'

# Check staged files for secrets
errors_found=0

for pattern in $SECRET_PATTERNS; do
    # Skip empty lines
    [ -z "$pattern" ] && continue

    # Search staged content for the pattern
    matches=$(git diff --cached --diff-filter=ACMR -U0 $against | \
        grep -E "^\+" | \
        grep -v "^+++" | \
        grep -E "$pattern" | \
        grep -vE "$EXCLUDE_PATTERN" || true)

    if [ -n "$matches" ]; then
        echo "ERROR: Potential secret detected matching pattern: $pattern"
        echo "$matches" | head -5
        errors_found=1
    fi
done

# Check for common sensitive filenames being added
sensitive_files=$(git diff --cached --name-only --diff-filter=A $against | \
    grep -iE '(^|/)(\.(env|env\.local|env\.production)|.*credentials.*\.json|.*secrets.*\.json|.*\.pem|.*\.key|id_rsa|id_ed25519)$' || true)

if [ -n "$sensitive_files" ]; then
    echo "ERROR: Potentially sensitive file(s) being added:"
    echo "$sensitive_files"
    errors_found=1
fi

if [ $errors_found -eq 1 ]; then
    echo ""
    echo "Commit blocked. If these are false positives, use --no-verify to bypass."
    echo "Review carefully before bypassing - secrets in git history are hard to remove!"
    exit 1
fi

exit 0
